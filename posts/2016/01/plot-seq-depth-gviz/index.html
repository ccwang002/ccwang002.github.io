<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">
<meta name="author" content="Liang-Bo Wang" />
<meta name="description" content="TL;DR Plot exome sequencing depth and coverage with genome annotation using Gviz in R. Then apply detail control on Gviz annotation track displaying …" />
<meta name="keywords" content="en, r, bioconductor, gviz, NGS">
	<link rel="shortcut icon" href="https://blog.liang2.tw/favicon.ico" />
	<title>Plot Sequencing Depth with Gviz</title>

	<!-- og -->
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="Liang2's Blog"/>
<meta property="og:title" content="Plot Sequencing Depth with Gviz"/>
<meta property="og:description" content="TL;DR Plot exome sequencing depth and coverage with genome annotation using Gviz in R. Then apply detail control on Gviz annotation track displaying …"/>
<meta property="og:locale" content=""/>
<meta property="og:url" content="https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2016-01-15 23:50:00-06:00"/>
<meta property="article:modified_time" content="2016-01-15 23:50:00-06:00"/>
<meta property="article:author" content="https://blog.liang2.tw/author/liang-bo-wang.html">
<meta property="article:section" content="Bioinfo"/>
<meta property="article:tag" content="en"/>
<meta property="article:tag" content="r"/>
<meta property="article:tag" content="bioconductor"/>
<meta property="article:tag" content="gviz"/>
<meta property="article:tag" content="NGS"/>
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ccwang002">
<meta name="twitter:title" content="Plot Sequencing Depth with Gviz">
<meta name="twitter:description" content="TL;DR Plot exome sequencing depth and coverage with genome annotation using Gviz in R. Then apply detail control on Gviz annotation track displaying …">
<meta property="og:image" content="http://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/pics/seqdepth_gene_symbol.png">
<meta name="twitter:image" content="http://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/pics/seqdepth_gene_symbol.png">

	<!-- Feeds -->
	<link href="https://blog.liang2.tw/feeds/all.atom.xml"
		type="application/atom+xml" rel="alternate" title="Liang2's Blog" />

	<link href="https://blog.liang2.tw/theme/css/haunter.css?bd17f8d9" rel="stylesheet" />
</head>

<body class="post-template">
	<header class="site-head">
		<h1 class="blog-title"><a href="https://blog.liang2.tw">Liang2's Blog</a></h1>
		<h2 class="blog-description">
			<a href="https://blog.liang2.tw/about-me/">About</a> |
			<a href="https://blog.liang2.tw/talks/">Talks</a> |
			<a href="https://blog.liang2.tw/archives.html">Archives</a>
		</h2>
	</header>
	<main id="content" class="content" role="main">
<article class="post en-post">
    <span class="post-meta">
        <time datetime="Jan 15, 2016">Jan 15, 2016</time>
        in <a href="https://blog.liang2.tw/category/bioinfo/">Bioinfo</a>
    </span>
    <h1 class="post-title">
        <a href="https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/" rel="bookmark" title="Permalink to Plot Sequencing Depth with Gviz">Plot Sequencing Depth with Gviz</a>
    </h1>
    <span class="post-meta">
                <a href="https://blog.liang2.tw/tag/en/">en</a>
                <a href="https://blog.liang2.tw/tag/r/">r</a>
                <a href="https://blog.liang2.tw/tag/bioconductor/">bioconductor</a>
                <a href="https://blog.liang2.tw/tag/gviz/">gviz</a>
                <a href="https://blog.liang2.tw/tag/ngs/">NGS</a>
    </span>
    <section class="post-content"><p><em><strong>TL;DR</strong> Plot exome sequencing depth and coverage with genome annotation using Gviz in R. Then apply detail control on Gviz annotation track displaying.</em></p>
<p>This is an extending post from <a href="https://blog.liang2.tw/posts/2015/12/biocondutor-genomic-data/">Genomic Data Processing in Bioconductor</a>, though I haven&rsquo;t finished reading all the reference in that post. The background knowledge of this post is basic understanding of how to deal with annotation and genome reference in Bioconductor/R. If you don&rsquo;t deal with genome annotations in R before, you should find some time learning it anyway, a truly life saver.</p>
<div class="toc">
<ul>
<li><a href="#convert-sequencing-depth-to-bedgraph-format">Convert sequencing depth to BedGraph format</a></li>
<li><a href="#plot-depth-in-gviz">Plot depth in Gviz</a><ul>
<li><a href="#first-gviz-track">First Gviz track</a></li>
<li><a href="#add-genome-axis">Add genome axis</a></li>
<li><a href="#add-annotation">Add annotation</a></li>
</ul>
</li>
<li><a href="#plot-fine-tune">Plot fine tune</a><ul>
<li><a href="#genome-annotation-query-in-bioconductorr">Genome annotation query in Bioconductor/R</a><ul>
<li><a href="#via-transcripts">via transcripts()</a></li>
<li><a href="#via-exonsby">via exonsBy()</a></li>
</ul>
</li>
<li><a href="#show-only-the-annotations-of-certain-genes">Show only the annotations of certain genes</a></li>
<li><a href="#display-gene-symbols-at-annotation-track">Display gene symbols at annotation track</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
<li><a href="#supplementary-plot-bam-files-directly">Supplementary - Plot BAM files directly</a><ul>
<li><a href="#fancier-alignment-display">Fancier alignment display</a></li>
</ul>
</li>
</ul>
</div>
<p>I got the chance trying new tricks today when I and other lab members were analyzing our human cancer exome sequencing data. The results were a bunch of BAM files aligned by <a href="https://github.com/lh3/bwa">BWA-MEM</a> using reference hg19.</p>
<p>We want to see how was the sequencing depth and the coverage of all exons designed to be sequenced. Roughly, this can be done in the genome viewer such as <a href="https://www.broadinstitute.org/igv/">IGV</a>.</p>
<div class="figure">
  <img src="https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/pics/seqdepth_IGV.png"/>
  <p class="caption center">Visualize sequencing depth in IGV</p>
</div>

<p>IGV is good for daily research, but when it comes to customization, there aren&rsquo;t many options. And if the visualization is aimed for publishing, one might want the figure to be vectorized and, more importantly, <em>reproducible</em>.</p>
<p>Therefore, combining with what I learnt in <a href="https://blog.liang2.tw/posts/2015/12/biocondutor-genomic-data/">Genomic Data Processing in Bioconductor</a>, I tried to plot the sequencing depth in R with <a href="https://bioconductor.org/packages/release/bioc/html/Gviz.html">Gviz</a>. I thought learning Gviz will be demanding, since its vignette has 80 pages and the function documentation are <a href="http://rpackages.ianhowson.com/bioc/Gviz/man/GeneRegionTrack-class.html">scarily long spells</a>. But both of them turned out to be <em>really</em> helpful and informative, especially when trying to tune its behavior. Figures produced by Gviz are aesthetically pleasing, and Gviz has many features as well (still trying). I&rsquo;m glad that I gave it a shot.</p>
<p>If you want to follow the code yourself, any human BAM alignment files will do. For example, the GEO dataset <a href="http://dev.3dvcell.org/geo/query/acc.cgi?acc=GSE48215">GSE48215</a> contains exome sequencing of breast cancer cell lines.</p>
<h2 id="convert-sequencing-depth-to-bedgraph-format">Convert sequencing depth to BedGraph format</h2>
<p>After a quick search, Gviz&rsquo;s <a href="http://rpackages.ianhowson.com/bioc/Gviz/man/DataTrack-class.html">DataTrack</a> accepts BedGraph format. This format can display any numerical value of chromosome ranges, shown as follows,</p>
<table>
<thead>
<tr>
<th align="left">chromosome</th>
<th>start</th>
<th>end</th>
<th align="right">value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">chr1</td>
<td>10,051</td>
<td>10,093</td>
<td align="right">2</td>
</tr>
<tr>
<td align="left">chr1</td>
<td>10,093</td>
<td>10,104</td>
<td align="right">5</td>
</tr>
<tr>
<td align="left">&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
<td align="right">&hellip;</td>
</tr>
</tbody>
</table>
<p>So we need to convert the alignment result as BedGraph format, which can be done by <a href="http://bedtools.readthedocs.org/en/latest/content/tools/genomecov.html">BEDTools&rsquo; genomecov</a> command. On BEDTools&rsquo; documentation, it notes that the BAM file should be sorted. </p>
<div class="highlight"><pre><span></span>bedtools genomecov -bg -ibam myseq.bam &gt; myseq.bedGraph
</pre></div>


<p>The plain text BedGraph can be huge, pipe&rsquo;d with gzip will reduce file size to around 30% of the original.</p>
<div class="highlight"><pre><span></span>bedtools genomecov -bg -ibam myseq.bam <span class="p">|</span> gzip &gt; myseq.bedGraph.gz
</pre></div>


<h2 id="plot-depth-in-gviz">Plot depth in Gviz</h2>
<p>R packages of human genome annotations (<a href="http://bioconductor.org/packages/release/data/annotation/html/Homo.sapiens.html">Homo.sapiens</a>) and <a href="https://bioconductor.org/packages/release/bioc/html/Gviz.html">Gviz</a> itself are required. Also, <a href="https://cran.r-project.org/web/packages/data.table/index.html">data.table</a> gives an impressed speed at reading text tables so is recommended to use. During the analysis, I happened to know that data.table supports <a href="https://github.com/Rdatatable/data.table/issues/717">reading gzip&rsquo;d file through pipe</a>, which makes it more awesome.</p>
<h3 id="first-gviz-track">First Gviz track</h3>
<p>We should first start at reading our sequencing depth as BedGraph format and plot it.</p>
<div class="highlight"><pre><span></span><span class="kn">library</span><span class="p">(</span>data.table<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>Gviz<span class="p">)</span>

bedgraph_dt <span class="o">&lt;-</span> fread<span class="p">(</span>
    <span class="s">&#39;./coverage.bedGraph&#39;</span><span class="p">,</span>
    col.names <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&#39;chromosome&#39;</span><span class="p">,</span> <span class="s">&#39;start&#39;</span><span class="p">,</span> <span class="s">&#39;end&#39;</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Specifiy the range to plot</span>
thechr <span class="o">&lt;-</span> <span class="s">&quot;chr17&quot;</span>
st <span class="o">&lt;-</span> <span class="m">41176e3</span>
en <span class="o">&lt;-</span> <span class="m">41324e3</span>

bedgraph_dt_one_chr <span class="o">&lt;-</span> bedgraph_dt<span class="p">[</span>chromosome <span class="o">==</span> thechr<span class="p">]</span>
dtrack <span class="o">&lt;-</span> DataTrack<span class="p">(</span>
    range <span class="o">=</span> bedgraph_dt_one_chr<span class="p">,</span>
    type <span class="o">=</span> <span class="s">&quot;a&quot;</span><span class="p">,</span>
    genome <span class="o">=</span> <span class="s">&#39;hg19&#39;</span><span class="p">,</span>
    name <span class="o">=</span> <span class="s">&quot;Seq. Depth&quot;</span>
<span class="p">)</span>
plotTracks<span class="p">(</span>
    <span class="kt">list</span><span class="p">(</span>dtrack<span class="p">),</span>
    from <span class="o">=</span> st<span class="p">,</span> to <span class="o">=</span> en
<span class="p">)</span>
</pre></div>


<p>So we read the sequencing depth data, create a Gviz <code>DataTrack</code> holding the subset of our data on chr17, then plot Gviz tracks by <code>plotTracks</code> (though we only made one here) within a given chromosome region. Here is what we got.</p>
<div class="figure">
  <img src="https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/pics/seqdepth_one_track.png"/>
</div>

<h3 id="add-genome-axis">Add genome axis</h3>
<p>The figure is a bit weird and lack of information without the genomic location. </p>
<p>Adding genomic location can be done automatically by Gviz through a new track <code>GenomeAxisTrack</code>. Also, we&rsquo;d like to show which region of chromosome we are at. This can be done by adding another track, <code>IdeogramTrack</code>, to show the chromosome ideogram. Note that the latter track will download cytoband data from UCSC so the given genome must have a valid name.</p>
<div class="highlight"><pre><span></span>itrack <span class="o">&lt;-</span> IdeogramTrack<span class="p">(</span>
    genome <span class="o">=</span> <span class="s">&quot;hg19&quot;</span><span class="p">,</span> chromosome <span class="o">=</span> thechr
<span class="p">)</span>
gtrack <span class="o">&lt;-</span> GenomeAxisTrack<span class="p">()</span>

plotTracks<span class="p">(</span>
    <span class="kt">list</span><span class="p">(</span>itrack<span class="p">,</span> gtrack<span class="p">,</span> dtrack<span class="p">),</span>
    from <span class="o">=</span> st<span class="p">,</span> to <span class="o">=</span> en
<span class="p">)</span>
</pre></div>


<div class="figure">
  <img src="https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/pics/seqdepth_with_loc.png"/>
</div>

<p>Better now :)</p>
<h3 id="add-annotation">Add annotation</h3>
<p>Since we are using exome sequencing, the curve of sequencing depth only makes senses when combined with the transcript annotations. </p>
<p>Gviz has <code>GeneRegionTrack</code> to extract annotation from the R annotation packages. Package Homo.sapiens includes the gene annotation package using UCSC knownGene database. Adding this new track and we will have annotation on our plot.</p>
<div class="highlight"><pre><span></span><span class="kn">library</span><span class="p">(</span>TxDb.Hsapiens.UCSC.hg19.knownGene<span class="p">)</span>
txdb <span class="o">&lt;-</span> TxDb.Hsapiens.UCSC.hg19.knownGene

grtrack <span class="o">&lt;-</span> GeneRegionTrack<span class="p">(</span>
    txdb<span class="p">,</span>
    chromosome <span class="o">=</span> thechr<span class="p">,</span> start <span class="o">=</span> st<span class="p">,</span> end <span class="o">=</span> en<span class="p">,</span>
    showId <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span>
    name <span class="o">=</span> <span class="s">&quot;Gene Annotation&quot;</span>
<span class="p">)</span>

plotTracks<span class="p">(</span>
    <span class="kt">list</span><span class="p">(</span>itrack<span class="p">,</span> gtrack<span class="p">,</span> dtrack<span class="p">,</span> grtrack<span class="p">),</span>
    from <span class="o">=</span> st<span class="p">,</span> to <span class="o">=</span> en
<span class="p">)</span>
</pre></div>


<div class="figure">
  <img src="https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/pics/seqdepth_with_annotation.png"/>
</div>

<p>The plot should now be as informative as what we can get from the IGV. In fact, Gviz can plot the alignment result too. It can read the BAM file directly and show a more detailed coverage that matches what IGV can do. I&rsquo;ll leave that part at the end of this post. </p>
<p>So far we&rsquo;ve shown the sequencing depth of some chromosome region with annotation. However, there still leave something to be desired, mostly about the annotation:</p>
<ul>
<li>Can we show only the annotation of certain genes?</li>
<li>knownGene&rsquo;s identifier is barely meaningless, can we show the gene symbol instead?</li>
</ul>
<p>So here comes the second part, annotation fine tuning.</p>
<h2 id="plot-fine-tune">Plot fine tune</h2>
<p>Say, we only care about gene <em>BRCA1</em>. So we need to get its location, or specifically, the genomic range that cover all <em>BRCA1</em> isoforms. In the following example, I will demonstrate the Gviz&rsquo;s annotation fine tuning.</p>
<h3 id="genome-annotation-query-in-bioconductorr">Genome annotation query in Bioconductor/R</h3>
<p>If you are not familiar with how to query annotations in Bioconductor, it&rsquo;s easier to think by breaking our goal of finding <em>BRCA1</em>&lsquo;s ranges into two steps:</p>
<ol>
<li>Get the transcript IDs</li>
<li>Query the transcript locations by their IDs</li>
</ol>
<p>Getting transcript IDs given their gene symbol is a <code>select()</code> on OrganismDb object,</p>
<div class="highlight"><pre><span></span><span class="c1"># Get all transcript IDs of gene BRCA1</span>
BRCA1_txnames <span class="o">&lt;-</span> select<span class="p">(</span>
    Homo.sapiens<span class="p">,</span>
    keys <span class="o">=</span> <span class="s">&quot;BRCA1&quot;</span><span class="p">,</span> keytype <span class="o">=</span> <span class="s">&quot;SYMBOL&quot;</span><span class="p">,</span>
    columns <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;ENTREZID&quot;</span><span class="p">,</span> <span class="s">&quot;TXNAME&quot;</span><span class="p">)</span>
<span class="p">)</span><span class="o">$</span>TXNAME
</pre></div>


<div class="highlight"><pre><span></span><span class="gp">&gt; </span>BRCA1_txnames
<span class="go"> [1] &quot;uc010whl.2&quot; &quot;uc002icp.4&quot; &quot;uc010whm.2&quot; &quot;uc002icu.3&quot;</span>
<span class="go"> [5] &quot;uc010cyx.3&quot; &quot;uc002icq.3&quot; &quot;uc002ict.3&quot; &quot;uc010whn.2&quot;</span>
<span class="go"> [9] &quot;uc010who.3&quot; &quot;uc010whp.2&quot; &quot;uc010whq.1&quot; &quot;uc002idc.1&quot;</span>
<span class="go">[13] &quot;uc010whr.1&quot; &quot;uc002idd.3&quot; &quot;uc002ide.1&quot; &quot;uc010cyy.1&quot;</span>
<span class="go">[17] &quot;uc010whs.1&quot; &quot;uc010cyz.2&quot; &quot;uc010cza.2&quot; &quot;uc010wht.1&quot;</span>
</pre></div>


<p>Look like it has plenty of isoforms!</p>
<h4 id="via-transcripts">via <code>transcripts()</code></h4>
<p>For the transcript location, the easiest way will be querying the txDb via <code>transcript()</code>,</p>
<div class="highlight"><pre><span></span>BRCA1_txs <span class="o">&lt;-</span> transcripts<span class="p">(</span>
    Homo.sapiens<span class="p">,</span>
    vals<span class="o">=</span><span class="kt">list</span><span class="p">(</span>tx_name <span class="o">=</span> BRCA1_txnames<span class="p">),</span>
    columns<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="s">&quot;TXNAME&quot;</span><span class="p">,</span><span class="s">&quot;SYMBOL&quot;</span><span class="p">,</span> <span class="s">&quot;EXONID&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="gp">&gt; </span>BRCA1_txs
<span class="go">GRanges object with 20 ranges and 3 metadata columns:</span>
<span class="go">       seqnames               ranges strand   |                   EXONID          TXNAME          SYMBOL</span>
<span class="go">          &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt;   |            &lt;IntegerList&gt; &lt;CharacterList&gt; &lt;CharacterList&gt;</span>
<span class="go">   [1]    chr17 [41196312, 41276132]      -   | 227486,227485,227482,...      uc010whl.2           BRCA1</span>
<span class="go">   [2]    chr17 [41196312, 41277340]      -   | 227487,227486,227485,...      uc002icp.4           BRCA1</span>
<span class="go">   [3]    chr17 [41196312, 41277340]      -   | 227487,227464,227463,...      uc010whm.2           BRCA1</span>
<span class="go">   [4]    chr17 [41196312, 41277468]      -   | 227489,227486,227485,...      uc002icu.3           BRCA1</span>
<span class="go">   [5]    chr17 [41196312, 41277468]      -   | 227489,227486,227482,...      uc010cyx.3           BRCA1</span>
<span class="go">   ...      ...                  ...    ... ...                      ...             ...             ...</span>
<span class="go">  [16]    chr17 [41243452, 41277340]      -   | 227487,227486,227485,...      uc010cyy.1           BRCA1</span>
<span class="go">  [17]    chr17 [41243452, 41277468]      -   | 227489,227486,227485,...      uc010whs.1           BRCA1</span>
<span class="go">  [18]    chr17 [41243452, 41277500]      -   | 227488,227486,227485,...      uc010cyz.2           BRCA1</span>
<span class="go">  [19]    chr17 [41243452, 41277500]      -   | 227488,227486,227485,...      uc010cza.2           BRCA1</span>
<span class="go">  [20]    chr17 [41243452, 41277500]      -   |            227488,227474      uc010wht.1           BRCA1</span>
<span class="go">  -------</span>
<span class="go">  seqinfo: 93 sequences (1 circular) from hg19 genome</span>
</pre></div>


<p>Then get the genomic range of these transcripts by <code>seqnames()</code>, <code>start()</code> and <code>end()</code> functions on the <code>GRanages</code> object,</p>
<div class="highlight"><pre><span></span>thechr <span class="o">&lt;-</span> <span class="kp">as.character</span><span class="p">(</span><span class="kp">unique</span><span class="p">(</span>
    seqnames<span class="p">(</span>BRCA1_txs<span class="p">)</span>
<span class="p">))</span>
st <span class="o">&lt;-</span> <span class="kp">min</span><span class="p">(</span>start<span class="p">(</span>BRCA1_txs<span class="p">))</span> <span class="o">-</span> <span class="m">2e4</span>
en <span class="o">&lt;-</span> <span class="kp">max</span><span class="p">(</span>end<span class="p">(</span>BRCA1_txs<span class="p">))</span> <span class="o">+</span> <span class="m">1e3</span>
</pre></div>


<p>Some space are added at both ends so the plot won&rsquo;t tightly fit all transcripts and leave some room for the transcript names. </p>
<div class="highlight"><pre><span></span><span class="gp">&gt; </span><span class="kt">c</span><span class="p">(</span>thechr<span class="p">,</span> st<span class="p">,</span> en<span class="p">)</span>
<span class="go">[1] &quot;chr17&quot;    &quot;41176312&quot; &quot;41323420&quot;</span>
</pre></div>


<h4 id="via-exonsby">via <code>exonsBy()</code></h4>
<p>Another way to obtain the genomic range is getting the exact range of CDS (e.g. exons and UTRs) for each transcript via <code>exonsBy()</code>. </p>
<div class="highlight"><pre><span></span>BRCA1_cds_by_tx <span class="o">&lt;-</span> exonsBy<span class="p">(</span>
    Homo.sapiens<span class="p">,</span> by<span class="o">=</span><span class="s">&quot;tx&quot;</span><span class="p">,</span> use.names<span class="o">=</span><span class="kc">TRUE</span>
<span class="p">)[</span>BRCA1_txnames<span class="p">]</span>
</pre></div>


<p>The function returns a <code>GRangesList</code> object, a list of <code>GRanges</code> that each <code>GRanges</code> object corresponds to a transcript respectively.</p>
<div class="highlight"><pre><span></span><span class="gp">&gt; </span>BRCA1_cds_by_tx
<span class="go">GRangesList object of length 20:</span>
<span class="go">$uc010whl.2 </span>
<span class="go">GRanges object with 22 ranges and 3 metadata columns:</span>
<span class="go">       seqnames               ranges strand   |   exon_id   exon_name exon_rank</span>
<span class="go">          &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt;   | &lt;integer&gt; &lt;character&gt; &lt;integer&gt;</span>
<span class="go">   [1]    chr17 [41276034, 41276132]      -   |    227486        &lt;NA&gt;         1</span>
<span class="go">   [2]    chr17 [41267743, 41267796]      -   |    227485        &lt;NA&gt;         2</span>
<span class="go">   [3]    chr17 [41258473, 41258550]      -   |    227482        &lt;NA&gt;         3</span>
<span class="go">   [4]    chr17 [41256885, 41256973]      -   |    227481        &lt;NA&gt;         4</span>
<span class="go">   [5]    chr17 [41256139, 41256278]      -   |    227480        &lt;NA&gt;         5</span>
<span class="go">   ...      ...                  ...    ... ...       ...         ...       ...</span>
<span class="go">  [18]    chr17 [41209069, 41209152]      -   |    227462        &lt;NA&gt;        18</span>
<span class="go">  [19]    chr17 [41203080, 41203134]      -   |    227461        &lt;NA&gt;        19</span>
<span class="go">  [20]    chr17 [41201138, 41201211]      -   |    227459        &lt;NA&gt;        20</span>
<span class="go">  [21]    chr17 [41199660, 41199720]      -   |    227458        &lt;NA&gt;        21</span>
<span class="go">  [22]    chr17 [41196312, 41197819]      -   |    227457        &lt;NA&gt;        22</span>

<span class="go">...</span>
<span class="go">&lt;19 more elements&gt;</span>
<span class="go">-------</span>
<span class="go">seqinfo: 93 sequences (1 circular) from hg19 genome</span>
</pre></div>


<p><code>GRangesList</code> is not merely a R list structure, which can correctly propagate the GRanges-related functions to all the GRanges it contain.</p>
<div class="highlight"><pre><span></span><span class="gp">&gt; </span>start<span class="p">(</span>BRCA1_cds_by_tx<span class="p">)</span>
<span class="go">IntegerList of length 20</span>
<span class="go">[[&quot;uc010whl.2&quot;]] 41276034 41267743 41258473 ... 41201138 41199660 41196312</span>
<span class="go">[[&quot;uc002icp.4&quot;]] 41277199 41276034 41267743 ... 41201138 41199660 41196312</span>
<span class="go">...</span>
</pre></div>


<p>Here we only cares about the widest range, so the hierarchical structure is not useful. It would be better to flatten the <code>GRangesList</code> first,</p>
<div class="highlight"><pre><span></span><span class="gp">&gt; </span>BRCA1_cds_flatten <span class="o">&lt;-</span> <span class="kp">unlist</span><span class="p">(</span>BRCA1_cds_by_tx<span class="p">)</span>
<span class="gp">&gt; </span>BRCA1_cds_flatten
<span class="go">GRanges object with 284 ranges and 3 metadata columns:</span>
<span class="go">             seqnames               ranges strand   |   exon_id   exon_name exon_rank</span>
<span class="go">                &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt;   | &lt;integer&gt; &lt;character&gt; &lt;integer&gt;</span>
<span class="go">  uc010whl.2    chr17 [41276034, 41276132]      -   |    227486        &lt;NA&gt;         1</span>
<span class="go">  uc010whl.2    chr17 [41267743, 41267796]      -   |    227485        &lt;NA&gt;         2</span>
<span class="go">  uc010whl.2    chr17 [41258473, 41258550]      -   |    227482        &lt;NA&gt;         3</span>
<span class="go">  uc010whl.2    chr17 [41256885, 41256973]      -   |    227481        &lt;NA&gt;         4</span>
<span class="go">  uc010whl.2    chr17 [41256139, 41256278]      -   |    227480        &lt;NA&gt;         5</span>
<span class="go">         ...      ...                  ...    ... ...       ...         ...       ...</span>
<span class="go">  uc010cza.2    chr17 [41249261, 41249306]      -   |    227477        &lt;NA&gt;         7</span>
<span class="go">  uc010cza.2    chr17 [41247863, 41247939]      -   |    227476        &lt;NA&gt;         8</span>
<span class="go">  uc010cza.2    chr17 [41243452, 41246877]      -   |    227474        &lt;NA&gt;         9</span>
<span class="go">  uc010wht.1    chr17 [41277288, 41277500]      -   |    227488        &lt;NA&gt;         1</span>
<span class="go">  uc010wht.1    chr17 [41243452, 41246877]      -   |    227474        &lt;NA&gt;         2</span>
<span class="go">  -------</span>
<span class="go">  seqinfo: 93 sequences (1 circular) from hg19 genome</span>
</pre></div>


<p>We have the BRCA1 genomic region, rest of the plotting is the same.</p>
<h3 id="show-only-the-annotations-of-certain-genes">Show only the annotations of certain genes</h3>
<p>Before we start to create our own annotation subset, we first take a look at what Gviz generated. The <code>GeneRegionTrack</code> track store its annotation data at slot <code>range</code>.</p>
<div class="highlight"><pre><span></span><span class="gp">&gt; </span>grtrack<span class="o">@</span><span class="kp">range</span>
<span class="go">GRanges object with 459 ranges and 7 metadata columns:</span>
<span class="go">        seqnames               ranges strand   |     feature          id         exon  transcript        gene      symbol   density</span>
<span class="go">           &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt;   | &lt;character&gt; &lt;character&gt;  &lt;character&gt; &lt;character&gt; &lt;character&gt; &lt;character&gt; &lt;numeric&gt;</span>
<span class="go">    [1]    chr17 [41177258, 41177364]      +   |        utr5     unknown uc002icn.3_1  uc002icn.3        8153  uc002icn.3         1</span>
<span class="go">    [2]    chr17 [41177365, 41177466]      +   |         CDS     unknown uc002icn.3_1  uc002icn.3        8153  uc002icn.3         1</span>
<span class="go">    [3]    chr17 [41177977, 41178064]      +   |         CDS     unknown uc002icn.3_2  uc002icn.3        8153  uc002icn.3         1</span>
<span class="go">    [4]    chr17 [41179200, 41179309]      +   |         CDS     unknown uc002icn.3_3  uc002icn.3        8153  uc002icn.3         1</span>
<span class="go">    [5]    chr17 [41180078, 41180212]      +   |         CDS     unknown uc002icn.3_4  uc002icn.3        8153  uc002icn.3         1</span>
<span class="go">    ...      ...                  ...    ... ...         ...         ...          ...         ...         ...         ...       ...</span>
<span class="go">  [455]    chr17 [41277294, 41277468]      -   |        utr5     unknown uc010cyx.3_1  uc010cyx.3         672  uc010cyx.3         1</span>
<span class="go">  [456]    chr17 [41277294, 41277468]      -   |        utr5     unknown uc002idc.1_1  uc002idc.1         672  uc002idc.1         1</span>
<span class="go">  [457]    chr17 [41277294, 41277468]      -   |        utr5     unknown uc010whr.1_1  uc010whr.1         672  uc010whr.1         1</span>
<span class="go">  [458]    chr17 [41277294, 41277468]      -   |        utr5     unknown uc010whs.1_1  uc010whs.1         672  uc010whs.1         1</span>
<span class="go">  [459]    chr17 [41322143, 41322420]      -   |        utr5     unknown uc010whp.2_1  uc010whp.2         672  uc010whp.2         1</span>
<span class="go">  -------</span>
<span class="go">  seqinfo: 1 sequence from hg19 genome; no seqlengths</span>
</pre></div>


<p>So we filter out unrelated ranges by checking if the value of metadata column <code>transcript</code> is one of <em>BRCA1</em>&lsquo;s transcript IDs,</p>
<div class="highlight"><pre><span></span>BRCA_only_range <span class="o">&lt;-</span> grtrack<span class="o">@</span><span class="kp">range</span><span class="p">[</span>
    mcols<span class="p">(</span>grtrack<span class="o">@</span><span class="kp">range</span><span class="p">)</span><span class="o">$</span>transcript <span class="o">%in%</span> BRCA1_txnames
<span class="p">]</span>
grtrack<span class="o">@</span>range <span class="o">&lt;-</span> BRCA_only_range
</pre></div>


<p>or by less hacky way that use the new range to construct another <code>GeneRegionTrack</code>,</p>
<div class="highlight"><pre><span></span>grtrack_BRCA_only <span class="o">&lt;-</span> GeneRegionTrack<span class="p">(</span>
    BRCA_only_range<span class="p">,</span>
    chromosome <span class="o">=</span> thechr<span class="p">,</span> start <span class="o">=</span> st<span class="p">,</span> end <span class="o">=</span> en<span class="p">,</span>
    showId <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span>
    name <span class="o">=</span> <span class="s">&quot;Gene Annotation (BRCA1 only)&quot;</span>
<span class="p">)</span>
plotTracks<span class="p">(</span>
    <span class="kt">list</span><span class="p">(</span>itrack<span class="p">,</span> gtrack<span class="p">,</span> dtrack<span class="p">,</span> grtrack_BRCA_only<span class="p">),</span>
    from <span class="o">=</span> st<span class="p">,</span> to <span class="o">=</span> en
<span class="p">)</span>
</pre></div>


<div class="figure">
  <img src="https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/pics/seqdepth_BRCA1_only.png"/>
</div>

<h3 id="display-gene-symbols-at-annotation-track">Display gene symbols at annotation track</h3>
<p>It&rsquo;s more obvious now about how Gviz stores the annotation. All we need is to replace the symbol name with whatever we desire.</p>
<p>First, we extract the metadata of the <code>GeneRegionTrack</code>, and query for their gene symbols. Using either the transcript ID or Entrez ID will do. </p>
<div class="highlight"><pre><span></span>grtrack_range <span class="o">&lt;-</span> grtrack<span class="o">@</span><span class="kp">range</span>
range_mapping <span class="o">&lt;-</span> select<span class="p">(</span>
    Homo.sapiens<span class="p">,</span>
    keys <span class="o">=</span> mcols<span class="p">(</span>grtrack_range<span class="p">)</span><span class="o">$</span>symbol<span class="p">,</span>
    keytype <span class="o">=</span> <span class="s">&quot;TXNAME&quot;</span><span class="p">,</span>
    columns <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;ENTREZID&quot;</span><span class="p">,</span> <span class="s">&quot;SYMBOL&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="gp">&gt; </span><span class="kp">head</span><span class="p">(</span>range_mapping<span class="p">)</span>
<span class="go">      TXNAME SYMBOL ENTREZID</span>
<span class="go">1 uc002icn.3   RND2     8153</span>
<span class="go">2 uc002icn.3   RND2     8153</span>
<span class="go">3 uc002icn.3   RND2     8153</span>
<span class="go">4 uc002icn.3   RND2     8153</span>
<span class="go">5 uc002icn.3   RND2     8153</span>
<span class="go">6 uc002icn.3   RND2     8153</span>
</pre></div>


<p>Then we concatenate the information of transcript ID and gene symbol using <a href="https://cran.r-project.org/web/packages/stringr/index.html">stringr</a>.</p>
<div class="highlight"><pre><span></span><span class="kn">library</span><span class="p">(</span>stringr<span class="p">)</span>
new_symbols <span class="o">&lt;-</span> <span class="kp">with</span><span class="p">(</span>
    range_mapping<span class="p">,</span>
    str_c<span class="p">(</span>SYMBOL<span class="p">,</span> <span class="s">&quot; (&quot;</span><span class="p">,</span> TXNAME<span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">,</span> sep <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="gp">&gt; </span><span class="kp">head</span><span class="p">(</span><span class="kp">unique</span><span class="p">(</span>new_symbols<span class="p">))</span>
<span class="go">[1] &quot;RND2 (uc002icn.3)&quot; &quot;NBR2 (uc002idf.3)&quot; &quot;NBR2 (uc010czb.2)&quot;</span>
<span class="go">[4] &quot;NBR2 (uc002idg.3)&quot; &quot;NBR2 (uc002idh.3)&quot; &quot;NBR1 (uc010czd.3)&quot;</span>
</pre></div>


<p>Like how we extract <em>BRCA1</em>-only annotations, we construct a new <code>GeneRegionTrack</code>.</p>
<div class="highlight"><pre><span></span>grtrack_symbol <span class="o">&lt;-</span> GeneRegionTrack<span class="p">(</span>
    grtrack<span class="o">@</span><span class="kp">range</span><span class="p">,</span>
    chromosome <span class="o">=</span> thechr<span class="p">,</span> start <span class="o">=</span> st<span class="p">,</span> end <span class="o">=</span> en<span class="p">,</span>
    showId <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span>
    name <span class="o">=</span> <span class="s">&quot;Gene Annotation w. Symbol&quot;</span>
<span class="p">)</span>
symbol<span class="p">(</span>grtrack_symbol<span class="p">)</span> <span class="o">&lt;-</span> new_symbols
plotTracks<span class="p">(</span>
    <span class="kt">list</span><span class="p">(</span>itrack<span class="p">,</span> gtrack<span class="p">,</span> dtrack<span class="p">,</span> grtrack_symbol<span class="p">),</span>
    from <span class="o">=</span> st<span class="p">,</span> to <span class="o">=</span> en
<span class="p">)</span>
</pre></div>


<div class="figure">
  <img src="https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/pics/seqdepth_gene_symbol.png"/>
</div>

<h2 id="summary">Summary</h2>
<p>So we&rsquo;ve learnt how to plot using Gviz. You should go explore other data tracks or try to combine sequencing depth of multiple samples. I found the design of Gviz is clean and easy to modify. I think I&rsquo;ll use Gviz whenever genome-related plots are needed. </p>
<p>Really glad I&rsquo;ve tried it :)</p>
<h2 id="supplementary-plot-bam-files-directly">Supplementary - Plot BAM files directly</h2>
<p>We will start by replacing <code>DataTrack</code> with <code>AlignmentsTrack</code>. Also we select a smaller region this time so the read mapping can be clearly seen.</p>
<div class="highlight"><pre><span></span>st <span class="o">&lt;-</span> <span class="m">41.196e6L</span>
en <span class="o">&lt;-</span> <span class="m">41.202e6L</span>
gtrack <span class="o">&lt;-</span> GenomeAxisTrack<span class="p">(</span>cex <span class="o">=</span> <span class="m">1</span><span class="p">)</span>  <span class="c1"># set the font size larger</span>
altrack <span class="o">&lt;-</span> AlignmentsTrack<span class="p">(</span>
    <span class="s">&quot;myseq.bam&quot;</span><span class="p">,</span> isPaired <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> col.mates <span class="o">=</span> <span class="s">&quot;deeppink&quot;</span>
<span class="p">)</span>
plotTracks<span class="p">(</span>
    <span class="kt">list</span><span class="p">(</span>gtrack<span class="p">,</span> altrack<span class="p">,</span> grtrack<span class="p">),</span>
    from <span class="o">=</span> st<span class="p">,</span> to <span class="o">=</span> en
<span class="p">)</span>
</pre></div>


<div class="figure">
  <img src="https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/pics/seqdepth_BAM_default.png"/>
</div>

<p>To plot only the coverage, set the type as <code>coverage</code>.</p>
<div class="highlight"><pre><span></span>altrack <span class="o">&lt;-</span> AlignmentsTrack<span class="p">(</span>
    <span class="s">&quot;myseq.bam&quot;</span><span class="p">,</span> type <span class="o">=</span> <span class="s">&quot;coverage&quot;</span>
<span class="p">)</span>
</pre></div>


<div class="figure">
  <img src="https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/pics/seqdepth_BAM_coverage_only.png"/>
</div>

<h3 id="fancier-alignment-display">Fancier alignment display</h3>
<p>Spend some time reading the documentation, the alignment can be much more fancier. </p>
<p>For example, when looking at a much smaller genome region, we many want to see the sequence and read mismatches. It could be done by adding a new track <code>SequenceTrack</code> to include the genome sequence,</p>
<div class="highlight"><pre><span></span>small_st <span class="o">&lt;-</span> <span class="m">41267.735e3L</span>
small_en <span class="o">&lt;-</span> <span class="m">41267.805e3L</span>

<span class="kn">library</span><span class="p">(</span>BSgenome.Hsapiens.UCSC.hg19<span class="p">)</span>
strack <span class="o">&lt;-</span> SequenceTrack<span class="p">(</span>
    Hsapiens<span class="p">,</span>
    chromosome <span class="o">=</span> thechr<span class="p">,</span> from <span class="o">=</span> small_en<span class="p">,</span> to <span class="o">=</span> small_st<span class="p">,</span>
    cex<span class="o">=</span><span class="m">0.8</span>
<span class="p">)</span>
</pre></div>


<p>We tweak other tracks as well to make sure the figure won&rsquo;t explode by too much information. Gene annotations are collapsed down to one liner. Also, aligned read&rsquo;s height is increased to fit in individual letters (e.g., ATCG).</p>
<div class="highlight"><pre><span></span>grtrack_small <span class="o">&lt;-</span> GeneRegionTrack<span class="p">(</span>
   grtrack<span class="o">@</span><span class="kp">range</span><span class="p">,</span>
   chromosome <span class="o">=</span> thechr<span class="p">,</span>
   start <span class="o">=</span> small_st<span class="p">,</span> end <span class="o">=</span> small_en<span class="p">,</span>
   stacking <span class="o">=</span> <span class="s">&quot;dense&quot;</span><span class="p">,</span>
   name <span class="o">=</span> <span class="s">&quot;Gene Annotation&quot;</span>
<span class="p">)</span>
altrack <span class="o">&lt;-</span> AlignmentsTrack<span class="p">(</span>
    <span class="s">&quot;myseq.bam&quot;</span><span class="p">,</span>
    isPaired <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span>
    min.height <span class="o">=</span> <span class="m">12</span><span class="p">,</span> max.height <span class="o">=</span> <span class="m">15</span><span class="p">,</span> coverageHeight <span class="o">=</span> <span class="m">0.15</span><span class="p">,</span> size <span class="o">=</span> <span class="m">50</span>
<span class="p">)</span>
plotTracks<span class="p">(</span>
    <span class="kt">list</span><span class="p">(</span>gtrack<span class="p">,</span> altrack<span class="p">,</span> grtrack_small<span class="p">,</span> strack<span class="p">),</span>
    from <span class="o">=</span> small_st<span class="p">,</span> to <span class="o">=</span> small_en
<span class="p">)</span>
</pre></div>


<div class="figure">
  <img src="https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/pics/seqdepth_BAM_small_region.png"/>
</div>

<p>We found a C&gt;T SNP here!</p></section>
    <footer class="post-footer">
<section class="share">
    <h2>Share</h2>
    <a class="icon-twitter" href="https://twitter.com/share?text=Plot Sequencing Depth with Gviz&amp;url=https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="http://www.facebook.com/sharer/sharer.php?u=https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/"
        onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/"
        onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>    <section>
        <h2>Discuss</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          var disqus_shortname = 'liang2';
          var disqus_identifier = '/posts/2016/01/plot-seq-depth-gviz/';
          var disqus_url = 'https://blog.liang2.tw/posts/2016/01/plot-seq-depth-gviz/';
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
    </section>
    <footer>
</article>
	</main>
	<footer class="site-footer">
		<a class="subscribe icon-feed" href="https://blog.liang2.tw/feeds/all.atom.xml"><span class="tooltip">Atom</span></a>
		<div class="inner">
			<section>
				Browse articles by
				<a href="https://blog.liang2.tw/tags.html">Tags</a> |
				<a href="https://blog.liang2.tw/categories.html">Categories</a>
			</section>
			<section class="contact">
				Contact me by
				<a href="https://twitter.com/ccwang002">Twitter</a> |
				<a href="https://www.facebook.com/lbwang.2">Facebook</a> |
				<a href="https://keybase.io/liang2">Keybase</a> |
				<a href="https://github.com/ccwang002">GitHub</a> |
				<a href="https://bitbucket.org/ccwang002">Bitbucket</a> |
				<a href="mailto:me+blog@liang2.tw">Email</a> |
				<a href="https://www.linkedin.com/in/liangbowang/">LinkedIn</a>
			</section>
			<section class="copyright">
				This work is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
			</section>
			<section class="poweredby">
				Built using <a href="https://getpelican.com/">Pelican</a>.
				Powered by the <a href="https://kura.github.io/hauntr/">Hauntr</a> theme.
			</section>
		</div>
	</footer>
</body>
</html>