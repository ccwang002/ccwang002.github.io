<!DOCTYPE html>
<html lang="zh-Hant">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="author" content="Liang-Bo Wang" />
<meta name="description" content="整理了 server 從 HTTP 到 HTTPS 相關設定的調整。" />
<meta name="keywords" content="zh, pydoctw, https, letsencrypt">
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.95em%22 font-size=%2295%22>📖</text></svg>">
	<title>Python 官方文件中文化 Server HTTPS 使用 Let's Encrypt</title>

	<!-- og -->
<meta property="og:locale" content="zh_TW"/>
<meta property="og:site_name" content="Liang-Bo Wang's Blog"/>
<meta property="og:title" content="Python 官方文件中文化 Server HTTPS 使用 Let's Encrypt"/>
<meta property="og:description" content="整理了 server 從 HTTP 到 HTTPS 相關設定的調整。"/>
<meta property="og:locale" content=""/>
<meta property="og:url" content="https://blog.liang2.tw/posts/2016/02/pydoctw-https/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2016-02-21 14:00:00-06:00"/>
<meta property="article:modified_time" content="2022-05-13 12:58:39.552851-05:00"/>
<meta property="article:author" content="https://blog.liang2.tw/author/liang-bo-wang.html">
<meta property="article:section" content="Coding"/>
<meta property="article:tag" content="zh"/>
<meta property="article:tag" content="pydoctw"/>
<meta property="article:tag" content="https"/>
<meta property="article:tag" content="letsencrypt"/>
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ccwang002">
<meta name="twitter:title" content="Python 官方文件中文化 Server HTTPS 使用 Let's Encrypt">
<meta name="twitter:description" content="整理了 server 從 HTTP 到 HTTPS 相關設定的調整。">

	<!-- Feeds -->
	<link href="https://blog.liang2.tw/feeds/all.atom.xml"
		type="application/atom+xml" rel="alternate" title="Liang-Bo Wang's Blog" />

	<link rel="stylesheet" type="text/css" href="https://blog.liang2.tw/theme/styles/styles.css" />
	<link rel="stylesheet" href="https://blog.liang2.tw/theme/styles/pygments/light.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light" />
    <link rel="stylesheet" href="https://blog.liang2.tw/theme/styles/pygments/dark-monokai.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark" />
	<link rel="stylesheet" type="text/css" href="https://blog.liang2.tw/theme/katex-0.15.3/katex.min.css">
</head>

<body class="post-template no-js">
	<script>document.body.classList.remove('no-js');</script>
<svg
	xmlns="http://www.w3.org/2000/svg"
	style="display: none;"
>
	<symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
		<title>Following system color scheme</title>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
			stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			<circle cx="12" cy="12" r="9"></circle>
			<path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
		</svg>
	</symbol>
	<symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
		<title>Selected dark color scheme</title>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
			stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
			<path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
		</svg>
	</symbol>
	<symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
		<title>Selected light color scheme</title>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
			stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			<circle cx="12" cy="12" r="5"></circle>
			<line x1="12" y1="1" x2="12" y2="3"></line>
			<line x1="12" y1="21" x2="12" y2="23"></line>
			<line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
			<line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
			<line x1="1" y1="12" x2="3" y2="12"></line>
			<line x1="21" y1="12" x2="23" y2="12"></line>
			<line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
			<line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
		</svg>
	</symbol>
</svg>

<script>
	document.documentElement.dataset.color_scheme = localStorage.getItem("color_scheme") || "auto"
</script>
	<header class="site-head">
		<h1 class="blog-title"><a href="https://blog.liang2.tw">Liang-Bo Wang's Blog</a></h1>
		<h2 class="blog-description">
			<a href="https://blog.liang2.tw/about-me/">About</a> |
			<a href="https://blog.liang2.tw/talks/">Talks</a> |
			<a href="https://blog.liang2.tw/archives.html">Archives</a> |
			<button id="color-scheme-cycler" onClick="setColorScheme(nextColorScheme())">
                <svg aria-hidden="true" class="color-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="color-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="color-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="sr-only">Toggle light / dark / auto color theme</span>
            </button>
		</h2>
	</header>
	<main id="content" class="content" role="main">
<article class="post">
    <span class="post-meta">
        <time datetime="2016-02-21">Feb 21, 2016</time>
        in <a href="https://blog.liang2.tw/category/coding/">Coding</a>
    </span>
    <h1 class="post-title">
        <a href="https://blog.liang2.tw/posts/2016/02/pydoctw-https/" rel="bookmark" title="Permalink to Python 官方文件中文化 Server HTTPS 使用 Let's Encrypt">Python 官方文件中文化 Server HTTPS 使用 Let's Encrypt</a>
    </h1>
    <span class="post-meta">
                <a href="https://blog.liang2.tw/tag/zh/">zh</a>
                <a href="https://blog.liang2.tw/tag/pydoctw/">pydoctw</a>
                <a href="https://blog.liang2.tw/tag/https/">https</a>
                <a href="https://blog.liang2.tw/tag/letsencrypt/">letsencrypt</a>
    </span>
    <section class="post-content"><p>現在可以透過 <a href="https://docs.python.org.tw">https://docs.python.org.tw</a> 訪問 Python 官方文件中文化網站。</p>
<p>Server 本身的設定可以參考<a href="https://blog.liang2.tw/posts/2016/02/pydoctw-server/">之前的文章</a>。加入 HTTPS 就要設定相關的憑証，我選擇 <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> 做為憑証的簽署者。</p>
<p>Let&rsquo;s Encrypt (LE) 使用 AMCE (Automated Certificate Management Environment) protocol 去驗証你是否擁有你欲簽証的 domain。官網上有<a href="https://letsencrypt.org/howitworks/technology/">圖文說明</a>，簡單來說，LE 會要求你的 server 在特定的 path 加入特定的檔案，如果你做得到，就代表你擁有這個 domain。這樣的簽証第一次要在 LE server 上註冊，之後最長每 90 天認証一次。</p>
<div class="toc">
<ul>
<li><a href="#_1">參考資料</a></li>
<li><a href="#lets-encrypt-certificate">Let&rsquo;s Encrypt Certificate</a></li>
<li><a href="#systemd-timer-certificate">設定 systemd timer 定時更新 certificate</a><ul>
<li><a href="#systemd-service">Systemd service</a></li>
<li><a href="#systemd-timer">Systemd Timer</a></li>
</ul>
</li>
<li><a href="#nginx-http-redirect-to-https">nginx HTTP redirect to HTTPS</a></li>
<li><a href="#https">測試 HTTPS 設定</a></li>
<li><a href="#_2">心得</a></li>
<li><a href="#misc">Misc.</a></li>
</ul>
</div>
<h3 id="_1">參考資料</h3>
<p>我不是網路安全相關的專家，設定都是參考網路上的說明整理而成。LE certificate 的設定參考 <a href="https://robmclarty.com/blog/how-to-secure-your-web-app-using-https-with-letsencrypt"><em>How to Secure Your Web App Using HTTPS With Letsencrypt</em></a> by Rob McLarty 這篇文章。</p>
<h3 id="lets-encrypt-certificate">Let&rsquo;s Encrypt Certificate</h3>
<p>沒有使用 LE 官方的 client，而是用 <a href="https://daylightpirates.org/">Daniel Roesler</a> 所寫的 <a href="https://github.com/diafygi/acme-tiny/">acme-tiny</a>。這是一個不到 200 行的 Python script，可以自行檢查它有沒有做任何奇怪的事。<a href="https://github.com/diafygi/acme-tiny/">acme-tiny</a> 的 README 也有個設定教學，應該是大同小異。</p>
<p>基本上都是照著 <a href="https://robmclarty.com/blog/how-to-secure-your-web-app-using-https-with-letsencrypt"><em>How to Secure Your Web App Using HTTPS With Letsencrypt</em></a> 該篇文章做，不過有調整了以下的東西：</p>
<ol>
<li>建立 letsencrypt 帳號時，禁止使用 password login。<br>
   即： <code>adduser --disabled-password ...</code></li>
<li>使用 git 管理 <a href="https://github.com/diafygi/acme-tiny/">acme-tiny</a> script。</li>
<li>改用 systemd 控制 nginx，而不是透過 service。<br>
   即： <code>systemctl reload nginx</code></li>
<li>沒有用 crontab 而是使用 <a href="https://wiki.archlinux.org/index.php/Systemd/Timers">systemd Timers</a>。</li>
<li>重新導引 http 連線至 https。</li>
</ol>
<p>第 4、5 點設定比較多，整理到後面。</p>
<h3 id="systemd-timer-certificate">設定 systemd timer 定時更新 certificate</h3>
<p>這邊參考 <a href="http://www.certdepot.net/rhel7-use-systemd-timers/"><em>RHEL7: How to use Systemd timers.</em></a> 一文。</p>
<p>Systemd Timer 概念如同 crontab，但差別是使用 timer 即與 systemd 整合。<code>&lt;unit&gt;.timer</code> 可以定期執行 <code>&lt;unit&gt;.service</code>，所以 <unit> 執行的結果與狀態都能顯示在 systemd 中，也帶入了 journald 有的 logging 功能。</p>
<p>更新 certificate 的指令寫在 <code>/etc/letsencrypt/renew_cert.sh</code>。Shell script 的內容與參考文章一樣。</p>
<h4 id="systemd-service">Systemd service</h4>
<p>首先建立一個 renew_cert，以 Debian 為例放在 <code>/etc/systemd/system/renew_cert.service</code>，</p>
<div class="highlight"><pre><span></span><code class="language-ini"><span class="k">[Unit]</span><span class="w"></span>
<span class="na">Description</span><span class="o">=</span><span class="s">Renew Let&#39;s Encrypt cert</span><span class="w"></span>
<span class="na">After</span><span class="o">=</span><span class="s">syslog.target</span><span class="w"></span>

<span class="k">[Service]</span><span class="w"></span>
<span class="na">User</span><span class="o">=</span><span class="s">letsencrypt</span><span class="w"></span>
<span class="na">Group</span><span class="o">=</span><span class="s">letsencrypt</span><span class="w"></span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/etc/letsencrypt/renew_cert.sh</span><span class="w"></span>
<span class="na">Type</span><span class="o">=</span><span class="s">simple</span><span class="w"></span>
<span class="na">StandardError</span><span class="o">=</span><span class="s">syslog</span><span class="w"></span>

<span class="k">[Install]</span><span class="w"></span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span><span class="w"></span>
</code></pre></div>

<p>要手動更新 certificate 的時候執行這個 service 即可，</p>
<div class="highlight"><pre><span></span><code class="language-text">systemctl start renew_cert
</code></pre></div>

<p>我們不需要 enable 它，不然每次開機都會執行一次。看結果或記錄，</p>
<div class="highlight"><pre><span></span><code class="language-text">systemctl status renew_cert
journalctl -e -u renew_cert
</code></pre></div>

<h4 id="systemd-timer">Systemd Timer</h4>
<p>建立一個 <code>/etc/systemd/system/renew_cert.timer</code></p>
<div class="highlight"><pre><span></span><code class="language-ini"><span class="k">[Unit]</span><span class="w"></span>
<span class="na">Description</span><span class="o">=</span><span class="s">Update Let&#39;s Encrypt certificate every two months</span><span class="w"></span>

<span class="k">[Timer]</span><span class="w"></span>
<span class="na">OnCalendar</span><span class="o">=</span><span class="s">*-1/2-1 16:00:00</span><span class="w"></span>
<span class="na">Unit</span><span class="o">=</span><span class="s">renew_cert.service</span><span class="w"></span>

<span class="k">[Install]</span><span class="w"></span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span><span class="w"></span>
</code></pre></div>

<p>重點只有 <code>[Timer]</code> 這 directive。<code>Unit=</code> 表示要啟動的 service。<code>OnCalendar=</code><sup id="fnref:calendar"><a class="footnote-ref" href="#fn:calendar">1</a></sup> 則是設定這 timer 根據指定的時間點 (UTC 時間<sup id="fnref:utc"><a class="footnote-ref" href="#fn:utc">2</a></sup>) 啟動。</p>
<p>以這邊寫的時間 <code>*-1/2-1 16:00:00</code> 為例，代表每年的 1+2n 月 1 日 16:00 UTC 更新 certificate，即臺灣時間 1、3、5、……月 2 日凌晨更新。</p>
<p>啟用 timer，它需要被 enable 確保重開機時被執行。</p>
<div class="highlight"><pre><span></span><code class="language-text">systemctl enable renew_cert.timer
systemctl start renew_cert.timer
</code></pre></div>

<p>可以用 <code>systemctl list-timers</code> 檢查它下次執行的時間：</p>
<div class="highlight"><pre><span></span><code class="language-console"><span class="gp">$ </span>sudo systemctl list-timers renew_cert.timer
<span class="go">NEXT                         LEFT                LAST PASSED UNIT             ACTIVATES</span>
<span class="go">Tue 2016-03-01 16:00:00 UTC  1 weeks 2 days left n/a  n/a    renew_cert.timer renew_cert.service</span>
</code></pre></div>

<h3 id="nginx-http-redirect-to-https">nginx HTTP redirect to HTTPS</h3>
<p>（這邊設定我沒信心，有更好的設定方法歡迎告訴我 &gt; &lt;）</p>
<p>要解決的問題為，ACME challenge 是透過 HTTP，其餘的連線都轉到 HTTPS。</p>
<p>在 nginx 中把主要的設定檔中拿掉 <code>listen 80;</code> 與 ACM challenge 的部份。把它們移成新的 server block：</p>
<div class="highlight"><pre><span></span><code class="language-nginx"><span class="k">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">docs.python.org.tw</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1"># For Let&#39;s Encrypt ACME challenge files</span>
<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/.well-known/acme-challenge/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kn">alias</span><span class="w"> </span><span class="s">/var/www/challenges/</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kn">try_files</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="p">=</span><span class="mi">404</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kn">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="s">https://</span><span class="nv">$host$request_uri</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<h3 id="https">測試 HTTPS 設定</h3>
<p>用了 <a href="https://securityheaders.io/">securityheaders.io</a> 和 <a href="https://www.ssllabs.com/index.html">SSL Labs</a> 測試了一下，應該還可以：</p>
<figure>
  <img src="https://blog.liang2.tw/posts/2016/02/pydoctw-https/pics/pydoctw_securityheaders_report.png"/>
  <p class="caption center">Report from securityheaders.io (<a href="https://securityheaders.io/?q=https%3A%2F%2Fdocs.python.org.tw%2F3%2F">Live Report</a>)</p>
</figure>

<figure>
  <img src="https://blog.liang2.tw/posts/2016/02/pydoctw-https/pics/pydoctw_ssllabs_report.png"/>
  <p class="caption center">Report from SSL Labs (<a href="https://www.ssllabs.com/ssltest/analyze.html?d=docs.python.org.tw">Live Report</a>)</p>
</figure>

<h3 id="_2">心得</h3>
<p>總結來說，使用 <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> 不難，但也沒到非常簡單。</p>
<p>如果你願意把 root 和 private key 權限給它的話，用官方 client 提供的 <code>letsencrypt-auto</code> 步驟能更少，用 Apache 它聲稱能全自動設定。覺得 <a href="https://github.com/diafygi/acme-tiny/">acme-tiny</a> 指令太複雜的話，原作者也寫了一個 <a href="https://gethttpsforfree.com/">Get HTTPS for free!</a> 服務，用網頁的方式協助整個註冊流程。</p>
<p>要注意目前 public beta 階段，相同 domain 在 7 天只能被簽署 5 次，測試的時候不要太衝動不然就要等一週了。</p>
<h3 id="misc">Misc.</h3>
<p>建立 CSR (Certificate Signing Request) 檔時，可以加入自己的 email 地址，不然預設是 <code>webmaster@&lt;domain&gt;</code>：</p>
<div class="highlight"><pre><span></span><code class="language-bash">openssl req -new -sha256 <span class="se">\</span>
    -key /etc/letsencrypt/private/domain.key <span class="se">\</span>
    -subj <span class="s2">&quot;/CN=docs.python.org.tw/emailAddress=me+pydoctw@liang2.tw&quot;</span> <span class="se">\</span>
    &gt; /etc/letsencrypt/private/domain.csr
</code></pre></div>

<div class="footnote">
<hr>
<ol>
<li id="fn:calendar">
<p>除了 <code>OnCalendar</code> 還有很多設定 timer 的方式，如 <code>OnUnitActiveSec</code>。不過其他的時間算法，都會受有沒有開機，影響時間的計算。&#160;<a class="footnote-backref" href="#fnref:calendar" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:utc">
<p>Debian Jessie 的 <a href="https://www.freedesktop.org/software/systemd/man/systemd.time.html#Calendar%20Events">systemd.time (7)</a> Calendar Events 裡並沒有指定時區的方式，所以加上時區會有 parse error。但新版的 systemd 似乎支援時區。總之應該用 <code>systemctl list-timers</code> 確定執行的時間。&#160;<a class="footnote-backref" href="#fnref:utc" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div></section>
    <footer class="post-footer">
	<section
		class="utterances"
		data-repo="ccwang002/ccwang002.github.io"
		data-issue-term="pathname"
		data-label="Comment">
	</section>
	</footer>
</article>
	</main>
	<footer class="site-footer">
		<button class="subscribe"
			href="https://blog.liang2.tw/feeds/all.atom.xml"
			aria-label="Subscribe the Atom feed"
			data-tooltip="Subscribe"
		>
			<svg viewBox="0 0 24 24" width="24" height="24">
				<title>Atom feed</title>
				<circle cx="6.18" cy="17.82" r="2.18"/>
				<path d="m4 10.1v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9zm0-5.66v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56z"/>
			</svg>
		</button>
		<div class="inner">
			<section>
				Browse articles by
				<a href="https://blog.liang2.tw/tags.html">Tags</a> |
				<a href="https://blog.liang2.tw/categories.html">Categories</a>
			</section>
			<section class="contact">
				Contact me by
				<a href="https://twitter.com/lbwang2">Twitter</a> |
				<a href="https://www.facebook.com/lbwang.2">Facebook</a> |
				<a href="https://github.com/ccwang002">GitHub</a> |
				<a href="mailto:me+blog@liang2.tw">Email</a> |
				<a href="https://www.linkedin.com/in/liangbowang/">LinkedIn</a>
			</section>
			<section class="copyright">
				This work is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
			</section>
			<section class="powered-by">
				Built using <a href="https://getpelican.com/">Pelican</a>.
				Powered by the <a href="https://github.com/kura/hauntr">Hauntr</a> theme.
			</section>
		</div>
	</footer>
	<script src="https://blog.liang2.tw/theme/scripts/color_scheme.js"></script>
</body>
</html>