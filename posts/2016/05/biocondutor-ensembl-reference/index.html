<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="author" content="Liang-Bo Wang" />
<meta name="description" content="Using fundamental R/Biocondcutor packages (e.g. AnnotationHub, ensembldb and biomaRt) to query Ensembl genomic references or annotations." />
<meta name="keywords" content="en, r, bioconductor">
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.95em%22 font-size=%2295%22>ðŸ“–</text></svg>">
	<title>Ensembl Genomic Reference in Bioconductor</title>

	<!-- og -->
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="Liang-Bo Wang's Blog"/>
<meta property="og:title" content="Ensembl Genomic Reference in Bioconductor"/>
<meta property="og:description" content="Using fundamental R/Biocondcutor packages (e.g. AnnotationHub, ensembldb and biomaRt) to query Ensembl genomic references or annotations."/>
<meta property="og:locale" content=""/>
<meta property="og:url" content="https://blog.liang2.tw/posts/2016/05/biocondutor-ensembl-reference/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2016-05-21 18:00:00-05:00"/>
<meta property="article:modified_time" content="2022-05-13 12:53:46.634064-05:00"/>
<meta property="article:author" content="https://blog.liang2.tw/author/liang-bo-wang.html">
<meta property="article:section" content="Bioinfo"/>
<meta property="article:tag" content="en"/>
<meta property="article:tag" content="r"/>
<meta property="article:tag" content="bioconductor"/>
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ccwang002">
<meta name="twitter:title" content="Ensembl Genomic Reference in Bioconductor">
<meta name="twitter:description" content="Using fundamental R/Biocondcutor packages (e.g. AnnotationHub, ensembldb and biomaRt) to query Ensembl genomic references or annotations.">

	<!-- Feeds -->
	<link href="https://blog.liang2.tw/feeds/all.atom.xml"
		type="application/atom+xml" rel="alternate" title="Liang-Bo Wang's Blog" />

	<link rel="stylesheet" type="text/css" href="https://blog.liang2.tw/theme/styles/styles.css" />
	<link rel="stylesheet" href="https://blog.liang2.tw/theme/styles/pygments/light.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light" />
    <link rel="stylesheet" href="https://blog.liang2.tw/theme/styles/pygments/dark-monokai.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark" />
	<link rel="stylesheet" type="text/css" href="https://blog.liang2.tw/theme/katex-0.15.3/katex.min.css">
</head>

<body class="post-template no-js">
	<script>document.body.classList.remove('no-js');</script>
<svg
	xmlns="http://www.w3.org/2000/svg"
	style="display: none;"
>
	<symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
		<title>Following system color scheme</title>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
			stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			<circle cx="12" cy="12" r="9"></circle>
			<path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
		</svg>
	</symbol>
	<symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
		<title>Selected dark color scheme</title>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
			stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
			<path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
		</svg>
	</symbol>
	<symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
		<title>Selected light color scheme</title>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
			stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			<circle cx="12" cy="12" r="5"></circle>
			<line x1="12" y1="1" x2="12" y2="3"></line>
			<line x1="12" y1="21" x2="12" y2="23"></line>
			<line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
			<line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
			<line x1="1" y1="12" x2="3" y2="12"></line>
			<line x1="21" y1="12" x2="23" y2="12"></line>
			<line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
			<line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
		</svg>
	</symbol>
</svg>

<script>
	document.documentElement.dataset.color_scheme = localStorage.getItem("color_scheme") || "auto"
</script>
	<header class="site-head">
		<h1 class="blog-title"><a href="https://blog.liang2.tw">Liang-Bo Wang's Blog</a></h1>
		<h2 class="blog-description">
			<a href="https://blog.liang2.tw/about-me/">About</a> |
			<a href="https://blog.liang2.tw/talks/">Talks</a> |
			<a href="https://blog.liang2.tw/archives.html">Archives</a> |
			<button id="color-scheme-cycler" onClick="setColorScheme(nextColorScheme())">
                <svg aria-hidden="true" class="color-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="color-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="color-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="sr-only">Toggle light / dark / auto color theme</span>
            </button>
		</h2>
	</header>
	<main id="content" class="content" role="main">
<article class="post">
    <span class="post-meta">
        <time datetime="2016-05-21">May 21, 2016</time>
        in <a href="https://blog.liang2.tw/category/bioinfo/">Bioinfo</a>
    </span>
    <h1 class="post-title">
        <a href="https://blog.liang2.tw/posts/2016/05/biocondutor-ensembl-reference/" rel="bookmark" title="Permalink to Ensembl Genomic Reference in Bioconductor">Ensembl Genomic Reference in Bioconductor</a>
    </h1>
    <span class="post-meta">
                <a href="https://blog.liang2.tw/tag/en/">en</a>
                <a href="https://blog.liang2.tw/tag/r/">r</a>
                <a href="https://blog.liang2.tw/tag/bioconductor/">bioconductor</a>
    </span>
    <section class="post-content"><p><em><strong>TL;DR</strong> I gave a talk <a href="https://blog.liang2.tw/2016Talk-Genomics-in-R/">Genomics in R</a> about querying genomic annotations and references in R/Bioconductor. In this post, we re-visit all the operations in my talk using Ensembl references instead of UCSC/NCBI ones.</em></p>
<p>This post is part of the &ldquo;<a href="https://blog.liang2.tw/posts/2015/12/biocondutor-genomic-data/">Genomic Data Processing in Bioconductor</a>&rdquo; series. In that post, I mentioned several topics critical for genomic data analysis in Bioconductor:</p>
<ul>
<li>Annotation and genome reference (OrgDb, TxDb, OrganismDb, BSgenome)</li>
<li>Experiment data storage (ExpressionSets)</li>
<li>Operations on genome (GenomicRanges)</li>
<li>Genomic data visualization (Gviz, ggbio)</li>
</ul>
<p>Few days ago in a local R community meetup, I gave a talk <a href="https://blog.liang2.tw/2016Talk-Genomics-in-R/"><em>Genomics in R</em></a> covering the &ldquo;Annotation and genome reference&rdquo; part and a quick glance through &ldquo;Operations on genome&rdquo;, which should be sufficient for daily usage such as searching annotations in the subset of some genomic ranges. You can find the <a href="https://blog.liang2.tw/2016Talk-Genomics-in-R/">slides</a>, the <a href="https://www.youtube.com/watch?v=ZR4GYQ487j8">meetup screencast</a> (in Chinese) and the <a href="https://github.com/ccwang002/2016Talk-Genomics-in-R">accompanied source code</a> online. I don&rsquo;t think a write-up is needed for the talk. But if anyone is interested, feel free to drop your reply below. :)</p>
<h3 id="fundamental-bioconductor-packages">Fundamental Bioconductor packages</h3>
<p>Some Bioconductor packages are the building blocks for genomic data analysis. I put a table here containing all the classes covered in rest of the post. If you are not familiar with these classes and their methods, go through the <a href="https://blog.liang2.tw/2016Talk-Genomics-in-R/">talk slides</a> first, or at least follow the <a href="https://bioconductor.org/help/workflows/annotation/annotation/">annotation workflow</a> on Bioconductor.</p>
<table>
<thead>
<tr>
<th style="text-align: left;">R Class</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>OrgDb</code></td>
<td style="text-align: left;">Gene-based information for Homo sapiens; useful for mapping between gene IDs, Names, Symbols, GO and KEGG identifiers, etc.</td>
</tr>
<tr>
<td style="text-align: left;"><code>TxDb</code></td>
<td style="text-align: left;">Transcriptome ranges for the known gene track of Homo sapiens, e.g., introns, exons, UTR regions.</td>
</tr>
<tr>
<td style="text-align: left;"><code>OrganismDb</code></td>
<td style="text-align: left;">Collection of multiple annotations for a common organism and genome build.</td>
</tr>
<tr>
<td style="text-align: left;"><code>BSgenome</code></td>
<td style="text-align: left;">Full genome sequence for Homo sapiens.</td>
</tr>
<tr>
<td style="text-align: left;"><code>AnnotationHub</code></td>
<td style="text-align: left;">Provides a convenient interface to annotations from many different sources; objects are returned as fully parsed Bioconductor data objects or as the name of a file on disk.</td>
</tr>
</tbody>
</table>
<h3 id="ensembl-genome-browser-and-its-ecosystem">Ensembl genome browser and its ecosystem</h3>
<p>In Bioconductor, most annotations are built against NCBI and UCSC naming systems, which are also used in my talk. However, there is another naming system maintained by <a href="http://www.ensembl.org/index.html">Ensembl</a>, whose IDs are very recognizable with suffix &ldquo;ENSG&rdquo; and &ldquo;ENST&rdquo; for gene and transcript respectively.</p>
<p>I particularly enjoy the Ensembl genome browser. The information is well organized and structured. For example, take a look at the description page of <a href="http://www.ensembl.org/Homo_sapiens/Gene/Summary?db=core;g=ENSG00000100030">gene MAPK1</a>,</p>
<figure>
  <img src="https://blog.liang2.tw/posts/2016/05/biocondutor-ensembl-reference/pics/gene_MAPK1_ensembl_browser.png">
  <p class="caption center">Gene information page of MAP1 on Ensembl Genome Browser release 84 (<a href="http://www.ensembl.org/Homo_sapiens/Gene/Summary?db=core;g=ENSG00000100030">link</a>)</p>
</figure>

<p>The <a href="http://www.ensembl.org/Homo_sapiens/Gene/Compara_Tree?db=core;g=ENSG00000100030">gene tree</a> tab shows its homologs and paralogs. The <a href="http://www.ensembl.org/Homo_sapiens/Gene/Variation_Gene/Table?db=core;g=ENSG00000100030">variant table</a> tab shows various kinds of SNPs within MAPK1&rsquo;s transcript region. SNPs are annotated with their sources, different levels of supporting evidence, and SIFT/PolyPhen prediction on protein function change. Finally, there is a <a href="http://www.ensembl.org/Homo_sapiens/Gene/Matches?db=core;g=ENSG00000100030">external references</a> tab which links the Ensembl IDs with <a href="https://www.ncbi.nlm.nih.gov/CCDS/CcdsBrowse.cgi">NCBI CCDS</a> and <a href="http://www.ncbi.nlm.nih.gov/refseq/">NCBI RefSeq</a> IDs. There are many ways to explore different aspects of this gene, and it seems everything at multiple biological levels is simply connected.</p>
<p>I always think of the Ensembl ecosystem as a decent learning portal, so it is a pity if one cannot easily use its information in R/Bioconductor. After a quick research, I found using Ensembl annotations are quite straightforward even though the required files does not ship with Bioconductor. Also, there were some topics I failed to mention in the talk, such as AnnotationHub and genomic coordinate system conversion (e.g., from hg19 to hg38). I am going to cover these topics in the talk.</p>
<div class="toc">
<ul>
<li><a href="#fundamental-bioconductor-packages">Fundamental Bioconductor packages</a></li>
<li><a href="#ensembl-genome-browser-and-its-ecosystem">Ensembl genome browser and its ecosystem</a></li>
<li><a href="#orgdb">OrgDb</a></li>
<li><a href="#txdb">TxDb</a></li>
<li><a href="#bsgenome-and-annotationhub">BSgenome and AnnotationHub</a></li>
<li><a href="#biomart">biomaRt</a><ul>
<li><a href="#compatibility-with-annotationdbs-interface">Compatibility with AnnotationDb&rsquo;s interface</a></li>
<li><a href="#biomarts-original-interface">biomaRt&rsquo;s original interface</a></li>
</ul>
</li>
<li><a href="#conversion-between-genomic-coordinate-systems">Conversion between genomic coordinate systems</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
</div>
<h2 id="orgdb">OrgDb</h2>
<p>The same OrgDb object for human (<code>org.Hs.eg.db</code>) can be used. It relates different gene IDs, including Entrez and Ensembl gene ID. From its metadata, human&rsquo;s OrgDb gets updated frequently. Most of its data source were fetched during this March. So one should be able to use it for both hg19 and hg38 human reference.</p>
<div class="highlight"><pre><span></span><code><span class="nf">library</span><span class="p">(</span><span class="n">org.Hs.eg.db</span><span class="p">)</span>
<span class="n">human</span> <span class="o">&lt;-</span> <span class="n">org.Hs.eg.db</span>

<span class="n">mapk_gene_family_info</span> <span class="o">&lt;-</span> <span class="nf">select</span><span class="p">(</span>
    <span class="n">human</span><span class="p">,</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;MAPK1&quot;</span><span class="p">,</span> <span class="s">&quot;MAPK3&quot;</span><span class="p">,</span> <span class="s">&quot;MAPK6&quot;</span><span class="p">),</span>
    <span class="n">keytype</span> <span class="o">=</span> <span class="s">&quot;SYMBOL&quot;</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;ENTREZID&quot;</span><span class="p">,</span> <span class="s">&quot;ENSEMBL&quot;</span><span class="p">,</span> <span class="s">&quot;GENENAME&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">mapk_gene_family_info</span>
</code></pre></div>

<table>
<thead>
<tr>
<th style="text-align: left;">SYMBOL</th>
<th style="text-align: left;">ENTREZID</th>
<th style="text-align: left;">ENSEMBL</th>
<th style="text-align: left;">GENENAME</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">MAPK1</td>
<td style="text-align: left;">5594</td>
<td style="text-align: left;">ENSG00000100030</td>
<td style="text-align: left;">mitogen-activated protein kinase 1</td>
</tr>
<tr>
<td style="text-align: left;">MAPK3</td>
<td style="text-align: left;">5595</td>
<td style="text-align: left;">ENSG00000102882</td>
<td style="text-align: left;">mitogen-activated protein kinase 3</td>
</tr>
<tr>
<td style="text-align: left;">MAPK6</td>
<td style="text-align: left;">5597</td>
<td style="text-align: left;">ENSG00000069956</td>
<td style="text-align: left;">mitogen-activated protein kinase 6</td>
</tr>
</tbody>
</table>
<p>Here comes a small pitfall for Ensembl annotation. We cannot sufficiently map Ensembl&rsquo;s gene ID to its transcript ID,</p>
<div class="highlight"><pre><span></span><code><span class="nf">select</span><span class="p">(</span>
    <span class="n">human</span><span class="p">,</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">mapk_gene_family_info</span><span class="o">$</span><span class="n">ENSEMBL</span><span class="p">[[</span><span class="m">1</span><span class="p">]],</span>
    <span class="n">keytype</span> <span class="o">=</span> <span class="s">&quot;ENSEMBL&quot;</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;ENSEMBLTRANS&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># &#39;select()&#39; returned 1:1 mapping between keys and columns</span>
<span class="c1">#           ENSEMBL ENSEMBLTRANS</span>
<span class="c1"># 1 ENSG00000100030         &lt;NA&gt;</span>
</code></pre></div>

<p>We got <em>no</em> Ensembl transcript ID for MAPK1, which is impossible. Therefore, to find the real Ensembl transcript IDs, we need to find other references.</p>
<h2 id="txdb">TxDb</h2>
<p>There is no pre-built Ensembl TxDb object available on Bioconductor. But with the help of <a href="http://bioconductor.org/packages/release/bioc/html/ensembldb.html">ensembldb</a>, we can easily build the TxDb ourselves.</p>
<p>Following the instructions in ensembldb&rsquo;s <a href="http://bioconductor.org/packages/release/bioc/vignettes/ensembldb/inst/doc/ensembldb.html">vignette file</a>, we can build the TxDb object from the Ensembl latest release, which is release 84 (Mar, 2016) at the time of writing. Ensembl releases all human transcript records as GTF file, which can be found here <a href="ftp://ftp.ensembl.org/pub/release-84/gtf/homo_sapiens/Homo_sapiens.GRCh38.84.gtf.gz">ftp://ftp.ensembl.org/pub/release-84/gtf/homo_sapiens/Homo_sapiens.GRCh38.84.gtf.gz</a>.</p>
<p>After processing GTF file via <code>ensDbFromGtf()</code>, the generated data for creating the TxDb object will be stored in a SQLite3 database file <code>Homo_sapiens.GRCh38.84.sqlite</code> at the R working directory. Building TxDB is just one command away, <code>EnsDb()</code>. Putting two commands together, the script for building Ensembl TxDb is listed below. To prevent from rebuilding the TxDb every time the script is executed, we first check if the sqlite file exists,</p>
<div class="highlight"><pre><span></span><code><span class="c1"># xxx_DB in the vignette is just a string to the SQLite db file path</span>
<span class="n">ens84_txdb_pth</span> <span class="o">&lt;-</span> <span class="s">&#39;./Homo_sapiens.GRCh38.84.sqlite&#39;</span>
<span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="nf">file.exists</span><span class="p">(</span><span class="n">ens84_human_txdb_pth</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">ens84_txdb_pth</span> <span class="o">&lt;-</span> <span class="nf">ensDbFromGtf</span><span class="p">(</span><span class="n">gtf</span><span class="o">=</span><span class="s">&quot;Homo_sapiens.GRCh38.84.gtf.gz&quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">txdb_ens84</span> <span class="o">&lt;-</span> <span class="nf">EnsDb</span><span class="p">(</span><span class="n">ens84txdb_pth</span><span class="p">)</span>
<span class="n">txdb_ens84</span>  <span class="c1"># Preview the metadata</span>
</code></pre></div>

<p>The filtering syntax for finding desired genes or transcripts is different to the built-in TxDb object,</p>
<div class="highlight"><pre><span></span><code><span class="nf">transcripts</span><span class="p">(</span>
    <span class="n">txdb_ens84</span><span class="p">,</span>
    <span class="n">filter</span><span class="o">=</span><span class="nf">GeneidFilter</span><span class="p">(</span><span class="n">mapk_gene_family_info</span><span class="o">$</span><span class="n">ENSEMBL</span><span class="p">[[</span><span class="m">1</span><span class="p">]])</span>
<span class="p">)</span>
<span class="c1"># GRanges object with 4 ranges and 5 metadata columns:</span>
<span class="c1">#                   seqnames               ranges strand |           tx_id           tx_biotype</span>
<span class="c1">#                      &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt; |     &lt;character&gt;          &lt;character&gt;</span>
<span class="c1">#   ENST00000215832       22 [21754500, 21867629]      - | ENST00000215832       protein_coding</span>
<span class="c1">#   ENST00000491588       22 [21763984, 21769428]      - | ENST00000491588 processed_transcript</span>
<span class="c1">#   ENST00000398822       22 [21769040, 21867680]      - | ENST00000398822       protein_coding</span>
<span class="c1">#   ENST00000544786       22 [21769204, 21867440]      - | ENST00000544786       protein_coding</span>
<span class="c1">#                   tx_cds_seq_start tx_cds_seq_end         gene_id</span>
<span class="c1">#                          &lt;numeric&gt;      &lt;numeric&gt;     &lt;character&gt;</span>
<span class="c1">#   ENST00000215832         21769204       21867440 ENSG00000100030</span>
<span class="c1">#   ENST00000491588             &lt;NA&gt;           &lt;NA&gt; ENSG00000100030</span>
<span class="c1">#   ENST00000398822         21769204       21867440 ENSG00000100030</span>
<span class="c1">#   ENST00000544786         21769204       21867440 ENSG00000100030</span>
<span class="c1">#   -------</span>
<span class="c1">#   seqinfo: 1 sequence from GRCh38 genome</span>
</code></pre></div>

<p>So filtering is done by passing special filter functions to <code>filter=</code>. Likewise, there are <code>TxidFilter</code>, <code>TxbiotypeFilter</code>, and <code>GRangesFilter</code> for filtering on the respective columns.</p>
<div class="highlight"><pre><span></span><code><span class="n">tx_gr</span> <span class="o">&lt;-</span> <span class="nf">transcripts</span><span class="p">(</span>
    <span class="n">txdb_ens84</span><span class="p">,</span>
    <span class="n">filter</span><span class="o">=</span><span class="nf">TxidFilter</span><span class="p">(</span><span class="s">&quot;ENST00000215832&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">tr_gr</span>
<span class="c1"># GRanges object with 1 range and 5 metadata columns:</span>
<span class="c1">#                   seqnames               ranges strand |           tx_id     tx_biotype tx_cds_seq_start tx_cds_seq_end         gene_id</span>
<span class="c1">#                      &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt; |     &lt;character&gt;    &lt;character&gt;        &lt;numeric&gt;      &lt;numeric&gt;     &lt;character&gt;</span>
<span class="c1">#   ENST00000215832       22 [21754500, 21867629]      - | ENST00000215832 protein_coding         21769204       21867440 ENSG00000100030</span>
<span class="c1">#   -------</span>
<span class="c1">#   seqinfo: 1 sequence from GRCh38 genome</span>
</code></pre></div>

<p>Check the result with the online Ensembl genome browser. Note that Ensembl release 84 use hg38.</p>
<h2 id="bsgenome-and-annotationhub">BSgenome and AnnotationHub</h2>
<p>We can load the sequence from <code>BSgenome.Hsapiens.UCSC.hg38</code>, however, we can obtain the genome (chromosome) sequence of Ensembl using <a href="https://bioconductor.org/packages/release/bioc/html/AnnotationHub.html">AnnotationHub</a>. References of non-model organisms can be found on AnnotationHub, many of which are extracted from Ensembl. But they can be downloaded as Bioconductor objects directly so it should be easier to use.</p>
<p>First we create a AnnotationHub instance, it cached the metadata all available annotations locally for us to query.</p>
<div class="highlight"><pre><span></span><code><span class="n">ah</span> <span class="o">&lt;-</span> <span class="nf">AnnotationHub</span><span class="p">()</span>
<span class="nf">query</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Homo sapiens&quot;</span><span class="p">,</span> <span class="s">&quot;release-84&quot;</span><span class="p">))</span>
<span class="c1"># AnnotationHub with 5 records</span>
<span class="c1"># # snapshotDate(): 2016-05-12</span>
<span class="c1"># # $dataprovider: Ensembl</span>
<span class="c1"># # $species: Homo sapiens</span>
<span class="c1"># # $rdataclass: TwoBitFile</span>
<span class="c1"># # additional mcols(): taxonomyid, genome, description, tags, sourceurl, sourcetype</span>
<span class="c1"># # retrieve records with, e.g., &#39;object[[&quot;AH50558&quot;]]&#39;</span>
<span class="c1">#</span>
<span class="c1">#             title</span>
<span class="c1">#   AH50558 | Homo_sapiens.GRCh38.cdna.all.2bit</span>
<span class="c1">#   AH50559 | Homo_sapiens.GRCh38.dna.primary_assembly.2bit</span>
<span class="c1">#   AH50560 | Homo_sapiens.GRCh38.dna_rm.primary_assembly.2bit</span>
<span class="c1">#   AH50561 | Homo_sapiens.GRCh38.dna_sm.primary_assembly.2bit</span>
<span class="c1">#   AH50562 | Homo_sapiens.GRCh38.ncrna.2bit</span>
</code></pre></div>

<p>From the search results, human hg38 genome sequences are available as <a href="https://genome.ucsc.edu/goldenpath/help/twoBit.html">TwoBit</a> format. But having multiple results is confusing at first. After checking the Ensembl&rsquo;s <a href="ftp://ftp.ensembl.org/pub/release-84/fasta/homo_sapiens/dna/README">gnome DNA assembly readme</a>, what we should use here is the full DNA assembly without any masking (or you can decide it based on your application).</p>
<div class="highlight"><pre><span></span><code><span class="c1"># There are a plenty of query hits. Description of different file suffix:</span>
<span class="c1"># GRCh38.dna.*.2bit     genome sequence</span>
<span class="c1"># GRCh38.dna_rm.*.2bit  hard-masked genome sequence (masked regions are replaced with N&#39;s)</span>
<span class="c1"># GRCh38.dna_sm.*.2bit  soft-masked genome sequence (.............. are lower cased)</span>
<span class="n">ens84_human_dna</span> <span class="o">&lt;-</span> <span class="n">ah</span><span class="p">[[</span><span class="s">&quot;AH50559&quot;</span><span class="p">]]</span>
</code></pre></div>

<p>Then we can use it to obtain the DNA sequence of desired genomic range (in <code>GRagnes</code>).</p>
<div class="highlight"><pre><span></span><code><span class="nf">getSeq</span><span class="p">(</span><span class="n">ens84_human_dna</span><span class="p">,</span> <span class="n">tx_gr</span><span class="p">)</span>

<span class="c1">#   A DNAStringSet instance of length 1</span>
<span class="c1">#      width seq                              names</span>
<span class="c1"># [1] 113130 TTTATAGAGAAAA...CTCGGACCGATTGCCT ENST00000215832</span>
</code></pre></div>

<h2 id="biomart">biomaRt</h2>
<p><a href="http://www.ensembl.org/biomart/martview">BioMart</a> are a collections of database that can be accessed by the same API, including Ensembl, Uniprot and HapMap. <a href="https://bioconductor.org/packages/release/bioc/html/biomaRt.html">biomaRt</a> provides an R interface to these database resources. We will use BioMart for ID conversion between Ensembl and RefSeq. Its <a href="https://bioconductor.org/packages/release/bioc/vignettes/biomaRt/inst/doc/biomaRt.pdf">vignette</a> contains solutions to common scenarios so should be a good starting point to get familiar with it.</p>
<p>You could first explore which Marts are currently available by <code>listMarts()</code>,</p>
<div class="highlight"><pre><span></span><code><span class="nf">library</span><span class="p">(</span><span class="n">biomaRt</span><span class="p">)</span>
<span class="nf">listMarts</span><span class="p">()</span>
<span class="c1">#                biomart               version</span>
<span class="c1"># 1 ENSEMBL_MART_ENSEMBL      Ensembl Genes 84</span>
<span class="c1"># 2     ENSEMBL_MART_SNP  Ensembl Variation 84</span>
<span class="c1"># 3 ENSEMBL_MART_FUNCGEN Ensembl Regulation 84</span>
<span class="c1"># 4    ENSEMBL_MART_VEGA               Vega 64</span>
</code></pre></div>

<p>Here we will use Ensembl&rsquo;s biomart. Each mart contains multiple datasets, usually separated by different organisms. In our case, human&rsquo;s dataset is <code>hsapiens_gene_ensembl</code>. For other organisms, you can find their dataset by <code>listDatasets(ensembl)</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">ensembl</span> <span class="o">&lt;-</span> <span class="nf">useMart</span><span class="p">(</span><span class="s">&quot;ensembl&quot;</span><span class="p">)</span>
<span class="n">ensembl</span> <span class="o">&lt;-</span> <span class="nf">useDataset</span><span class="p">(</span><span class="s">&quot;hsapiens_gene_ensembl&quot;</span><span class="p">,</span> <span class="n">mart</span><span class="o">=</span><span class="n">ensembl</span><span class="p">)</span>
<span class="c1"># or equivalently</span>
<span class="n">ensembl</span> <span class="o">&lt;-</span> <span class="nf">useMart</span><span class="p">(</span><span class="s">&quot;ensembl&quot;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="s">&quot;hsapiens_gene_ensembl&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="compatibility-with-annotationdbs-interface">Compatibility with AnnotationDb&rsquo;s interface</h3>
<p>The way to query the <code>ensembl</code> Mart object is slightly different to how we query a AnnotationDb object. The major difference is the terminology. Luckily, Mart object provides a compatibility layer so we can still call functions such as <code>select(db, ...)</code>, <code>keytypes(db)</code>, <code>keys(db)</code> and <code>columns(db)</code>, which we frequently do<sup id="fnref:select-compat"><a class="footnote-ref" href="#fn:select-compat">1</a></sup> when using NCBI/UCSC references.</p>
<p>A Mart can have hundreds of keys and columns. So we select a part of them out by <code>grep()</code>,</p>
<div class="highlight"><pre><span></span><code><span class="nf">grep</span><span class="p">(</span><span class="s">&quot;^refseq&quot;</span><span class="p">,</span> <span class="nf">keytypes</span><span class="p">(</span><span class="n">ensembl</span><span class="p">),</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="c1"># [1] &quot;refseq_mrna&quot; &quot;refseq_mrna_predicted&quot; ...</span>
<span class="nf">grep</span><span class="p">(</span><span class="s">&quot;^ensembl&quot;</span><span class="p">,</span> <span class="nf">keytypes</span><span class="p">(</span><span class="n">ensembl</span><span class="p">),</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="c1"># [1] &quot;ensembl_exon_id&quot; &quot;ensembl_gene_id&quot; ...</span>
<span class="nf">grep</span><span class="p">(</span><span class="s">&quot;hsapiens_paralog_&quot;</span><span class="p">,</span> <span class="nf">columns</span><span class="p">(</span><span class="n">ensembl</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="c1"># [1] &quot;hsapiens_paralog_associated_gene_name&quot;</span>
<span class="c1"># [2] &quot;hsapiens_paralog_canonical_transcript_protein&quot;</span>
<span class="c1"># [3] &quot;hsapiens_paralog_chrom_end&quot;</span>
<span class="c1"># ...</span>
</code></pre></div>

<p>We start by finding the MAPK1&rsquo;s RefSeq transcript IDs and their corresponding Ensembl transcript IDs, which is something we cannot do by our locally built Ensembl TxDb nor the human OrgDb.</p>
<div class="highlight"><pre><span></span><code><span class="nf">select</span><span class="p">(</span>
    <span class="n">ensembl</span><span class="p">,</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;MAPK1&quot;</span><span class="p">),</span>
    <span class="n">keytype</span> <span class="o">=</span> <span class="s">&quot;hgnc_symbol&quot;</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span>  <span class="nf">c</span><span class="p">(</span>
        <span class="s">&quot;refseq_mrna&quot;</span><span class="p">,</span> <span class="s">&quot;ensembl_transcript_id&quot;</span><span class="p">,</span>
        <span class="s">&quot;hgnc_symbol&quot;</span><span class="p">,</span> <span class="s">&quot;entrezgene&quot;</span><span class="p">,</span>
        <span class="s">&quot;chromosome_name&quot;</span><span class="p">,</span>
        <span class="s">&quot;transcript_start&quot;</span><span class="p">,</span> <span class="s">&quot;transcript_end&quot;</span><span class="p">,</span> <span class="s">&quot;strand&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="c1">#   refseq_mrna ensembl_transcript_id hgnc_symbol entrezgene</span>
<span class="c1"># 1   NM_002745       ENST00000215832       MAPK1       5594</span>
<span class="c1"># 2                   ENST00000491588       MAPK1       5594</span>
<span class="c1"># 3   NM_138957       ENST00000398822       MAPK1       5594</span>
<span class="c1"># 4                   ENST00000544786       MAPK1       5594</span>
<span class="c1">#   chromosome_name transcript_start transcript_end strand</span>
<span class="c1"># 1              22         21754500       21867629     -1</span>
<span class="c1"># 2              22         21763984       21769428     -1</span>
<span class="c1"># 3              22         21769040       21867680     -1</span>
<span class="c1"># 4              22         21769204       21867440     -1</span>
</code></pre></div>

<p>So some of the MAPK1 Ensembl transcripts does not have RefSeq identifiers. This is common to see since RefSeq is more conservative about including new transcripts. Anyway, we can now translate our analysis result between a wider range of naming systems.</p>
<p>Moreover, what&rsquo;s awesome about BioMart is that almost all the information on the Ensembl genome browser can be retreived by BioMart. For example, getting the paralog and the mouse homolog of MAPK1,</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Get paralog of MAPK1</span>
<span class="nf">select</span><span class="p">(</span>
    <span class="n">ensembl</span><span class="p">,</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;ENSG00000100030&quot;</span><span class="p">),</span>
    <span class="n">keytype</span> <span class="o">=</span> <span class="s">&quot;ensembl_gene_id&quot;</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span>
        <span class="s">&quot;hsapiens_paralog_associated_gene_name&quot;</span><span class="p">,</span>
        <span class="s">&quot;hsapiens_paralog_orthology_type&quot;</span><span class="p">,</span>
        <span class="s">&quot;hsapiens_paralog_ensembl_peptide&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="c1">#   hsapiens_paralog_associated_gene_name hsapiens_paralog_orthology_type hsapiens_paralog_ensembl_peptide</span>
<span class="c1"># 1                                 MAPK3          within_species_paralog                  ENSP00000263025</span>
<span class="c1"># 2                                 MAPK6          within_species_paralog                  ENSP00000261845</span>
<span class="c1"># 3                                 MAPK4          within_species_paralog                  ENSP00000383234</span>
<span class="c1"># 4                                   NLK          within_species_paralog                  ENSP00000384625</span>
<span class="c1"># 5                                 MAPK7          within_species_paralog                  ENSP00000311005</span>

<span class="c1"># Get homolog of MAPK1 in mouse</span>
<span class="nf">select</span><span class="p">(</span>
    <span class="n">ensembl</span><span class="p">,</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;ENSG00000100030&quot;</span><span class="p">),</span>
    <span class="n">keytype</span> <span class="o">=</span> <span class="s">&quot;ensembl_gene_id&quot;</span><span class="p">,</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span>
        <span class="s">&quot;mmusculus_homolog_associated_gene_name&quot;</span><span class="p">,</span>
        <span class="s">&quot;mmusculus_homolog_orthology_type&quot;</span><span class="p">,</span>
        <span class="s">&quot;mmusculus_homolog_ensembl_peptide&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="c1">#   mmusculus_homolog_associated_gene_name mmusculus_homolog_orthology_type mmusculus_homolog_ensembl_peptide</span>
<span class="c1"># 1                                  Mapk1                 ortholog_one2one                ENSMUSP00000065983</span>
</code></pre></div>

<h3 id="biomarts-original-interface">biomaRt&rsquo;s original interface</h3>
<p>The <code>select()</code> function we use is not the original biomaRt&rsquo;s interface. In fact, keys and columns are interpreted as BioMart&rsquo;s <strong>filters</strong> and <strong>attributes</strong> respectively. To find all available filters and attributes,</p>
<div class="highlight"><pre><span></span><code><span class="n">filters</span> <span class="o">=</span> <span class="nf">listFilters</span><span class="p">(</span><span class="n">ensembl</span><span class="p">)</span>
<span class="n">attributes</span> <span class="o">=</span> <span class="nf">listAttributes</span><span class="p">(</span><span class="n">ensembl</span><span class="p">)</span>
</code></pre></div>

<p>each of the command return a data.frame that contains each filter&rsquo;s or attribute&rsquo;s name and description.</p>
<p>Behind the scene, arguments of <code>select(db, ...)</code> is converted to <code>getBM(mart, ...)</code>. For the same example of finding RefSeq and Ensembl transcript IDs, it can be re-written as</p>
<div class="highlight"><pre><span></span><code><span class="nf">getBM</span><span class="p">(</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span>
        <span class="s">&quot;refseq_mrna&quot;</span><span class="p">,</span> <span class="s">&quot;ensembl_transcript_id&quot;</span><span class="p">,</span>
        <span class="s">&quot;chromosome_name&quot;</span><span class="p">,</span>
        <span class="s">&quot;transcript_start&quot;</span><span class="p">,</span> <span class="s">&quot;transcript_end&quot;</span><span class="p">,</span> <span class="s">&quot;strand&quot;</span><span class="p">,</span>
        <span class="s">&quot;hgnc_symbol&quot;</span><span class="p">,</span> <span class="s">&quot;entrezgene&quot;</span><span class="p">,</span> <span class="s">&quot;ensembl_gene_id&quot;</span>
    <span class="p">),</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="s">&quot;hgnc_symbol&quot;</span><span class="p">,</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;MAPK1&quot;</span><span class="p">),</span>
    <span class="n">mart</span> <span class="o">=</span> <span class="n">ensembl</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="conversion-between-genomic-coordinate-systems">Conversion between genomic coordinate systems</h2>
<p>Somethings we need to convert between different verions of the reference. For example, today we&rsquo;d like to convert a batch of genomic locations of reference hg38 to that of hg19, so we can compare our new research with previous studies. It is a non-trivial task that can be currently handled by the following tools:</p>
<ul>
<li><a href="http://crossmap.sourceforge.net/">CrossMap</a> (used by Ensembl)</li>
<li><a href="https://genome.ucsc.edu/cgi-bin/hgLiftOver">liftOver</a> (used by UCSC)</li>
</ul>
<p>Frankly I don&rsquo;t have experience for such conversion in real study (the converted result still gives the sense of unease), but anyway here I follow <a href="http://genomicsclass.github.io/book/pages/bioc1_liftOver.html">the guide on PH525x series</a>. In Bioconductor, we can use UCSC&rsquo;s Chain file to apply the <code>liftOver()</code> method provided by package <code>rtracklayer</code>. To convert regions from hg38 to hg19, we need the <code>hg38ToHg19.over.chain</code> file, which can be found at <a href="ftp://hgdownload.cse.ucsc.edu/goldenPath/hg38/liftOver/">ftp://hgdownload.cse.ucsc.edu/goldenPath/hg38/liftOver/</a>.</p>
<p>We still use MAPK1 as an example of conversion. First extract MAPK1&rsquo;s genomic ranges in hg38 and hg19 respectively,</p>
<div class="highlight"><pre><span></span><code><span class="nf">library</span><span class="p">(</span><span class="n">TxDb.Hsapiens.UCSC.hg38.knownGene</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">TxDb.Hsapiens.UCSC.hg19.knownGene</span>
<span class="n">tx38</span> <span class="o">&lt;-</span> <span class="n">TxDb.Hsapiens.UCSC.hg38.knownGene</span>
<span class="n">tx19</span> <span class="o">&lt;-</span> <span class="n">TxDb.Hsapiens.UCSC.hg19.knownGene</span>
<span class="n">MAPK1_hg38</span> <span class="o">&lt;-</span> <span class="nf">genes</span><span class="p">(</span><span class="n">tx38</span><span class="p">,</span> <span class="n">filter</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">gene_id</span><span class="o">=</span><span class="s">&quot;5594&quot;</span><span class="p">))</span>
<span class="n">MAPK1_hg19</span> <span class="o">&lt;-</span> <span class="nf">genes</span><span class="p">(</span><span class="n">tx19</span><span class="p">,</span> <span class="n">filter</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">gene_id</span><span class="o">=</span><span class="s">&quot;5594&quot;</span><span class="p">))</span>
</code></pre></div>

<p>Then we convert <code>MAPK1_hg38</code> to use the hg19 coordinate system.</p>
<div class="highlight"><pre><span></span><code><span class="nf">library</span><span class="p">(</span><span class="n">rtracklayer</span><span class="p">)</span>
<span class="n">ch</span> <span class="o">&lt;-</span> <span class="nf">import.chain</span><span class="p">(</span><span class="s">&quot;./hg38ToHg19.over.chain&quot;</span><span class="p">)</span>
<span class="n">MAPK1_hg19_lifted</span> <span class="o">&lt;-</span> <span class="nf">liftOver</span><span class="p">(</span><span class="n">MAPK1_hg38</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>

<span class="n">MAPK1_hg19</span>
<span class="c1"># GRanges object with 1 range and 1 metadata column:</span>
<span class="c1">#        seqnames               ranges strand |     gene_id</span>
<span class="c1">#           &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt; | &lt;character&gt;</span>
<span class="c1">#   5594    chr22 [22113947, 22221970]      - |        5594</span>
<span class="c1">#   -------</span>
<span class="c1">#   seqinfo: 93 sequences (1 circular) from hg19 genome</span>

<span class="n">MAPK1_hg19_lifted</span>
<span class="c1"># GRangesList object of length 1:</span>
<span class="c1"># $5594</span>
<span class="c1"># GRanges object with 2 ranges and 1 metadata column:</span>
<span class="c1">#       seqnames               ranges strand |     gene_id</span>
<span class="c1">#          &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt; | &lt;character&gt;</span>
<span class="c1">#   [1]    chr22 [22113947, 22216652]      - |        5594</span>
<span class="c1">#   [2]    chr22 [22216654, 22221970]      - |        5594</span>
<span class="c1">#</span>
<span class="c1"># -------</span>
<span class="c1"># seqinfo: 1 sequence from an unspecified genome; no seqlengths</span>
</code></pre></div>

<p>So the conversion worked as expected, though it created a gap in the range (missing a base at 22216653). I haven&rsquo;t looked into the results. To ensure the correctness of the conversion, maybe a comparison with CrossMap is needed.</p>
<h2 id="summary">Summary</h2>
<p>We skimmed through OrgDb and TxDb again using the Ensembl references, including how to build the TxDb for Ensembl locally and obtain external annotations from AnnotationHub.</p>
<p>BioMart is an abundant resource to query across various types of databases and references, which can be used in conversion between different naming systems.</p>
<p>Finally, we know how to convert between different version of the reference. Though the correctness of the conversion requires further examination (not meaning it is wrong), at least the conversion by liftOver works as expected.</p>
<p>Starting here, you should have no trouble dealing with annotations in R anymore. For the next post, I plan to further explore the way to read sequencing analysis results in R.</p>
<div class="footnote">
<hr>
<ol>
<li id="fn:select-compat">
<p>Note that the <code>select(mart, ...)</code> compatibility does not apply to all existed filters (keys) and attributes (columns) of the given Mart.&#160;<a class="footnote-backref" href="#fnref:select-compat" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div></section>
    <footer class="post-footer">
	<section
		class="utterances"
		data-repo="ccwang002/ccwang002.github.io"
		data-issue-term="pathname"
		data-label="Comment">
	</section>
	</footer>
</article>
	</main>
	<footer class="site-footer">
		<button class="subscribe"
			href="https://blog.liang2.tw/feeds/all.atom.xml"
			aria-label="Subscribe the Atom feed"
			data-tooltip="Subscribe"
		>
			<svg viewBox="0 0 24 24" width="24" height="24">
				<title>Atom feed</title>
				<circle cx="6.18" cy="17.82" r="2.18"/>
				<path d="m4 10.1v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9zm0-5.66v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56z"/>
			</svg>
		</button>
		<div class="inner">
			<section>
				Browse articles by
				<a href="https://blog.liang2.tw/tags.html">Tags</a> |
				<a href="https://blog.liang2.tw/categories.html">Categories</a>
			</section>
			<section class="contact">
				Contact me by
				<a href="https://twitter.com/lbwang2">Twitter</a> |
				<a href="https://www.facebook.com/lbwang.2">Facebook</a> |
				<a href="https://github.com/ccwang002">GitHub</a> |
				<a href="mailto:me+blog@liang2.tw">Email</a> |
				<a href="https://www.linkedin.com/in/liangbowang/">LinkedIn</a>
			</section>
			<section class="copyright">
				This work is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
			</section>
			<section class="powered-by">
				Built using <a href="https://getpelican.com/">Pelican</a>.
				Powered by the <a href="https://github.com/kura/hauntr">Hauntr</a> theme.
			</section>
		</div>
	</footer>
	<script src="https://blog.liang2.tw/theme/scripts/color_scheme.js"></script>
</body>
</html>