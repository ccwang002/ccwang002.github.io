<!DOCTYPE html>
<html lang="zh-Hant">
<head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">
            <link href="https://blog.liang2.tw/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Liang2's Blog" />
        <link rel="shortcut icon" href="https://blog.liang2.tw/favicon.ico" />

		<link href="https://blog.liang2.tw/theme/css/haunter.css?0f9ace0e" rel="stylesheet" />

		<title>Jupyter Notebook Progress Bar</title>
		<!-- Justfont webfont -->
		<!-- Local development -->
		<!-- <script src="//s3-ap-northeast-1.amazonaws.com/justfont-user-script/jf-35439.js"></script> -->
		<!-- Proudction version -->
		<script src="https://blog.liang2.tw/theme/js/justfont.js" type="text/javascript" charset="utf-8"></script>
</head>

<body class="post-template">
    <header class="site-head">
			<h1 class="blog-title"><a href="https://blog.liang2.tw">Liang2's Blog</a></h1>
				<h2 class="blog-description">
					<a href="https://blog.liang2.tw/about-me/">About</a> |
					<a href="https://blog.liang2.tw/talks/">Talks</a> |
					<a href="https://blog.liang2.tw/archives.html">Archives</a>
				</h2>
    </header>
    <main id="content" class="content" role="main">
<article class="post">
    <span class="post-meta">
        <time datetime="Mar 23, 2016">Mar 23, 2016</time>
        in <a href="https://blog.liang2.tw/category/coding/">Coding</a>
    </span>
    <h1 class="post-title">
        <a href="https://blog.liang2.tw/posts/2016/03/notebook-progress-bar/" rel="bookmark" title="Permalink to Jupyter Notebook Progress Bar">Jupyter Notebook Progress Bar</a>
    </h1>
    <span class="post-meta">
                <a href="https://blog.liang2.tw/tag/zh/">zh</a>
                <a href="https://blog.liang2.tw/tag/jupyter/">jupyter</a>
                <a href="https://blog.liang2.tw/tag/notebook/">notebook</a>
    </span>
    <section class="post-content"><p>相信很多人都已經在使用 <a href="https://jupyter.org/">Jupyter (IPython) Notebook</a> 跑分析。隨著分析的資料越跑越多，有時候刷下去就是幾十分鐘甚至數小時。此時沒有個進度條還蠻無聊的，而且能讓自己感覺<strong>很有進度</strong>，何樂不為呢？</p>
<p>例如我<a href="https://blog.liang2.tw/play_aiohttp/?full#asyncio-progressbar-cover">去年介紹 aiohttp</a> 時就有用到 notebook 和 console 底下的進度條 (progress bar)。不過，這幾個月 Jupyter Notebook 4+ 架構上的調整，可能 code 都不能用了。剛好昨天的 Taipei.py 有人提到這事，就來整理一下吧。</p>
<div class="toc">
<ul>
<li><a href="#ipywidgets">IPywidgets 介紹</a><ul>
<li><a href="#_1">安裝</a></li>
</ul>
</li>
<li><a href="#_2">使用進度條</a></li>
<li><a href="#progress-bar-example-in-action">Progress bar example in action</a></li>
<li><a href="#misc">Misc. 螢幕截圖</a><ul>
<li><a href="#ffmpeg">FFmpeg 轉檔</a></li>
</ul>
</li>
</ul>
</div>
<h3 id="ipywidgets">IPywidgets 介紹</h3>
<p>Notebook 進度條使用 <a href="https://github.com/ipython/ipywidgets">ipywidgets</a> 中的元件實作。這件元件規範了 notebook client &lt;-&gt; server 間雙向的溝通，並且能把相關的 CSS / JS 包裝在一起。在 ipywidgets 範例的 <a href="http://nbviewer.jupyter.org/github/ipython/ipywidgets/blob/master/examples/Widget%20Basics.ipynb"><em>Widgets Basics</em></a> 中就有提到可能的用途：</p>
<blockquote>
<p>You can use widgets to <strong>build interactive GUIs</strong> for your notebooks. <br> 
You can also use widgets to <strong>synchronize stateful and stateless information</strong> between Python and JavaScript.</p>
</blockquote>
<p>所以除了像進度條這樣單向的從 python code 傳訊息到 notebook (HTML) front-end 之外，也可以做一些介面把 front-end 的值傳回 python code。</p>
<p>……只是要用個進度條而已，哪來這麼多背景知識。更多介紹可以參考 <a href="http://nbviewer.jupyter.org/github/ipython/ipywidgets/blob/master/examples/Index.ipynb">ipywidgets 官方範例</a>。</p>
<h4 id="_1">安裝</h4>
<p>使用 Python 3.5 示範。安裝除了 notebook 本身外，還要額外裝上 ipywidgets 這套件。</p>
<div class="highlight"><pre><span></span>pip install notebook ipywidgets
</pre></div>


<p>再用 <code>jupyter notebook</code> 即可啟用 notebook。</p>
<h3 id="_2">使用進度條</h3>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">IntProgress</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
</pre></div>


<p><code>IntProgress</code> 就是進度條，<code>display</code> 則是 IPython 顯示各種 Python 物件的函數，在這邊用它才能把 widget 以 HTML 顯示並與 python code 聯動。</p>
<p>建立一個進度條的方式很簡單。建立 <code>IntProgress</code> widget object，然後顯示它：</p>
<div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">IntProgress</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>


<div class="figure">
  <img src="https://blog.liang2.tw/posts/2016/03/notebook-progress-bar/pics/progressbar_default.png">
</div>

<p>預設是進度條有 100 個單位，初始值為 0。進度條的值與最大值的狀態分別存在 <code>.value</code>、<code>.max</code> 屬性裡：</p>
<div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">max</span>
<span class="go">(0, 100)</span>
</pre></div>


<p>只要修改 <code>p.value</code> 前面的進度條的狀態就會自動更新（不用重跑 <code>display(p)</code>）：</p>
<div class="highlight"><pre><span></span><span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">50</span>
</pre></div>


<div class="figure">
  <img src="https://blog.liang2.tw/posts/2016/03/notebook-progress-bar/pics/progressbar_50.png">
</div>

<div class="highlight"><pre><span></span><span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>


<div class="figure">
  <img src="https://blog.liang2.tw/posts/2016/03/notebook-progress-bar/pics/progressbar_100.png">
</div>

<p>當然，最大值調整也會即時更新。此外，還可以透過 <code>.description</code> 給進度條一個 label。重新做一個完整的例子：</p>
<div class="highlight"><pre><span></span><span class="n">p2</span> <span class="o">=</span> <span class="n">IntProgress</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="mi">56</span><span class="p">)</span>
<span class="n">p2</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">10</span>
<span class="n">p2</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Running&#39;</span>
<span class="n">display</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
</pre></div>


<div class="figure">
  <img src="https://blog.liang2.tw/posts/2016/03/notebook-progress-bar/pics/progressbar_full.png">
</div>

<p>完整的 code 就這樣，用起來非常方便。</p>
<h3 id="progress-bar-example-in-action">Progress bar example in action</h3>
<p>模擬一下真實情況，我們通常有一堆待做的 task，在這邊叫 <code>todo_tasks</code> 好了。</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="n">todo_tasks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;task </span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">)]</span>
</pre></div>


<p>只是個字串，但用 <code>time.sleep(sec)</code> 來模擬有在做事。</p>
<p>搭配進度條的時候，把實際動態做成底下的動畫。</p>
<div class="highlight"><pre><span></span><span class="c1"># Initialize a progess bar</span>
<span class="n">progress</span> <span class="o">=</span> <span class="n">IntProgress</span><span class="p">()</span>
<span class="n">progress</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">todo_tasks</span><span class="p">)</span>
<span class="n">progress</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;(Init)&#39;</span>
<span class="n">display</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>

<span class="c1"># Simulating task execution</span>
<span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">todo_tasks</span><span class="p">:</span>
    <span class="n">progress</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">progress</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">task</span>
<span class="n">progress</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;(Done)&#39;</span>
</pre></div>


<div class="figure">
  <video loop auto autoplay>
    <source src="https://blog.liang2.tw/posts/2016/03/notebook-progress-bar/pics/progressbar_demo.webm" type="video/webm">
    <source src="https://blog.liang2.tw/posts/2016/03/notebook-progress-bar/pics/progressbar_demo.mp4" type="video/mp4">
    Your browser doesn't support HTML5 video in WebM with VP8 or MP4 with H.264. You can still download the <a href="https://blog.liang2.tw/posts/2016/03/notebook-progress-bar/pics/progressbar_demo.mp4">screencast</a> and view it locally.
  </video>
  <p class="caption center">Progressbar in action</p>
</div>

<p>非常方便吧！</p>
<h3 id="misc">Misc. 螢幕截圖</h3>
<p>寫這篇文章花最多的時間是在截圖跟做動畫 XD</p>
<p>瀏覽器的截圖，現在 Firefox (45) 已經可以只選擇截某個 DOM，十分方便。</p>
<p>在最後動態的錄製花了不少時間。一開始想說是不是要用 GIF，但<a href="http://blog.imgur.com/2014/10/09/introducing-gifv/">都 2016 年了還用什麼 GIF 啊！</a>，雖然螢幕可以試著改 GIF palette 讓畫面不會很醜體積又小，但覺得用個 H.264 / VP9 簡單多了。</p>
<p>使用 QuickTime Screen Capture，開始錄的時候能只選擇螢幕一部份區域。以我 13&rdquo; retina 螢幕為例，會得到 1636x736 H.264 .mov 檔。但我覺得解析度不用這麼高，所以最後輸出成 480p (1148x480)  就好，順便裁了一點白邊。</p>
<p>透過 HTML5 <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video"><code>&lt;video&gt;</code></a> 能把 MP4 / WebM 當成動畫來使用：</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">video</span> <span class="na">loop</span> <span class="na">autoplay</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">source</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;vid.webm&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;video/webm&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">source</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;vid.mp4&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;video/mp4&quot;</span><span class="p">&gt;</span>
    Your browser doesn&#39;t support HTML5 video in WebM with VP8
    or MP4 with H.264. You can still download the 
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;vid.mp4&quot;</span><span class="p">&gt;</span>screencast<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span> and view it locally.
<span class="p">&lt;/</span><span class="nt">vide</span><span class="p">&gt;</span>
</pre></div>


<p>各家 web browser 的支援度可參考 caniuse.com：<a href="http://caniuse.com/#feat=webm">WebM</a>、<a href="http://caniuse.com/#feat=mpeg4">MP4</a></p>
<h4 id="ffmpeg">FFmpeg 轉檔</h4>
<p>筆記而已，沒有認真調參數讓輸出檔案最小。VP9 的部份參考 <a href="https://trac.ffmpeg.org/wiki/Encode/VP9">FFmepg</a><sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>。</p>
<div class="highlight"><pre><span></span><span class="c1"># H.264 MP4</span>
ffmpeg -i Untitled.mov <span class="se">\</span>
    -vcodec h264 <span class="se">\</span>
    -strict -2 -crf <span class="m">22</span> -preset slow -r <span class="m">24</span> <span class="se">\</span>
    -vf <span class="s2">&quot;crop=iw:ih-52:0:10, scale=-1:480&quot;</span> <span class="se">\</span>
    out.mp4

<span class="c1"># VP9 WebM</span>
ffmpeg -i Untitled.mov <span class="se">\</span>
    -vcodec libvpx-vp9 <span class="se">\</span>
    -b:v 150K -r <span class="m">24</span> <span class="se">\</span>
    -vf <span class="s2">&quot;crop=iw:ih-52:0:10, scale=-1:480&quot;</span> <span class="se">\</span>
    out.webm
</pre></div>


<p>4s 的檔案最後大約 60KB，相當不錯。我很多 PNG 截圖都大多了。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> du -sh ./* <span class="p">|</span> gsort -rh
<span class="go">744K    ./Untitled.mov</span>
<span class="go"> 60K    ./out.mp4</span>
<span class="go"> 52K    ./out.webm</span>
</pre></div>


<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>需要額外安裝 libvpx，例如：<code>brew install ffmepg --with-libvpx</code>&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div></section>
    <footer class="post-footer">
<section class="share">
    <h2>Share</h2>
    <a class="icon-twitter" href="https://twitter.com/share?text=Jupyter Notebook Progress Bar&amp;url=https://blog.liang2.tw/posts/2016/03/notebook-progress-bar/"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="http://www.facebook.com/sharer/sharer.php?u=https://blog.liang2.tw/posts/2016/03/notebook-progress-bar/"
        onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https://blog.liang2.tw/posts/2016/03/notebook-progress-bar/"
        onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>    <section>
        <h2>Discuss</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          var disqus_shortname = 'liang2';
          var disqus_identifier = '/posts/2016/03/notebook-progress-bar/';
          var disqus_url = 'https://blog.liang2.tw/posts/2016/03/notebook-progress-bar/';
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script>
    </section>
    <footer>
</article>
    </main>
    <footer class="site-footer">
		<a class="subscribe icon-feed" href="https://blog.liang2.tw/feeds/all.atom.xml"><span class="tooltip">Atom</span></a>
		<div class="inner">
			<section>
				Browse articles by
				<a href="https://blog.liang2.tw/tags/">Tags</a> |
				<a href="https://blog.liang2.tw/categories.html">Categories</a>
			</section>
			<section class="contact">
				Contact me by
				<a href="https://twitter.com/ccwang002">Twitter</a> |
				<a href="https://www.facebook.com/lbwang.2">Facebook</a> |
				<a href="https://keybase.io/liang2">Keybase</a> |
				<a href="https://github.com/ccwang002">GitHub</a> |
				<a href="https://bitbucket.org/ccwang002">Bitbucket</a> |
				<a href="mailto:me+blog@liang2.tw">Email</a> |
				<a href="https://www.linkedin.com/in/liangbowang/">LinkedIn</a>
			</section>
			<section class="copyright">
				This work is licensed under <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
			</section>
			<section class="poweredby">Built using <a href="http://getpelican.com/">Pelican</a>. Powered by the <a href="https://kura.io/hauntr/">Hauntr</a> theme.</section>
		</div>
    </footer>
</body>
</html>