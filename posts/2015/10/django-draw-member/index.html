<!DOCTYPE html>
<html lang="zh-Hant">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="author" content="Liang-Bo Wang" />
<meta name="description" content="æŠŠä¹‹å‰ç”¨ Flask æ¶çš„æŠ½ç±¤ç¶²ç«™æ”¹ç”¨ Django å¯¦ä½œï¼Œä¹Ÿè—‰é€™å€‹æ©Ÿæœƒæ¯”è¼ƒä¸€ä¸‹å…©å€‹ Framework è¨­è¨ˆæ¦‚å¿µçš„ä¸åŒã€‚" />
<meta name="keywords" content="zh, django, sqlite, python">
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.95em%22 font-size=%2295%22>ğŸ“–</text></svg>">
	<title>ç”¨ Django èˆ‡ SQLite æ¶æŠ½ç±¤ç¶²ç«™</title>

	<!-- og -->
<meta property="og:locale" content="zh_TW"/>
<meta property="og:site_name" content="Liang-Bo Wang's Blog"/>
<meta property="og:title" content="ç”¨ Django èˆ‡ SQLite æ¶æŠ½ç±¤ç¶²ç«™"/>
<meta property="og:description" content="æŠŠä¹‹å‰ç”¨ Flask æ¶çš„æŠ½ç±¤ç¶²ç«™æ”¹ç”¨ Django å¯¦ä½œï¼Œä¹Ÿè—‰é€™å€‹æ©Ÿæœƒæ¯”è¼ƒä¸€ä¸‹å…©å€‹ Framework è¨­è¨ˆæ¦‚å¿µçš„ä¸åŒã€‚"/>
<meta property="og:locale" content=""/>
<meta property="og:url" content="https://blog.liang2.tw/posts/2015/10/django-draw-member/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2015-10-04 14:55:00-05:00"/>
<meta property="article:modified_time" content="2022-05-13 13:06:42.360855-05:00"/>
<meta property="article:author" content="https://blog.liang2.tw/author/liang-bo-wang.html">
<meta property="article:section" content="Coding"/>
<meta property="article:tag" content="zh"/>
<meta property="article:tag" content="django"/>
<meta property="article:tag" content="sqlite"/>
<meta property="article:tag" content="python"/>
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ccwang002">
<meta name="twitter:title" content="ç”¨ Django èˆ‡ SQLite æ¶æŠ½ç±¤ç¶²ç«™">
<meta name="twitter:description" content="æŠŠä¹‹å‰ç”¨ Flask æ¶çš„æŠ½ç±¤ç¶²ç«™æ”¹ç”¨ Django å¯¦ä½œï¼Œä¹Ÿè—‰é€™å€‹æ©Ÿæœƒæ¯”è¼ƒä¸€ä¸‹å…©å€‹ Framework è¨­è¨ˆæ¦‚å¿µçš„ä¸åŒã€‚">

	<!-- Feeds -->
	<link href="https://blog.liang2.tw/feeds/all.atom.xml"
		type="application/atom+xml" rel="alternate" title="Liang-Bo Wang's Blog" />

	<link rel="stylesheet" type="text/css" href="https://blog.liang2.tw/theme/styles/styles.css" />
	<link rel="stylesheet" href="https://blog.liang2.tw/theme/styles/pygments/light.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light" />
    <link rel="stylesheet" href="https://blog.liang2.tw/theme/styles/pygments/dark-monokai.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark" />
	<link rel="stylesheet" type="text/css" href="https://blog.liang2.tw/theme/katex-0.16.2/katex.min.css">
</head>

<body class="post-template no-js">
	<script>document.body.classList.remove('no-js');</script>
<svg
	xmlns="http://www.w3.org/2000/svg"
	style="display: none;"
>
	<symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
		<title>Following system color scheme</title>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
			stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			<circle cx="12" cy="12" r="9"></circle>
			<path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
		</svg>
	</symbol>
	<symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
		<title>Selected dark color scheme</title>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
			stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
			<path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
		</svg>
	</symbol>
	<symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
		<title>Selected light color scheme</title>
		<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
			stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			<circle cx="12" cy="12" r="5"></circle>
			<line x1="12" y1="1" x2="12" y2="3"></line>
			<line x1="12" y1="21" x2="12" y2="23"></line>
			<line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
			<line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
			<line x1="1" y1="12" x2="3" y2="12"></line>
			<line x1="21" y1="12" x2="23" y2="12"></line>
			<line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
			<line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
		</svg>
	</symbol>
</svg>

<script>
	document.documentElement.dataset.color_scheme = localStorage.getItem("color_scheme") || "auto"
</script>
	<header class="site-head">
		<h1 class="blog-title"><a href="https://blog.liang2.tw">Liang-Bo Wang's Blog</a></h1>
		<h2 class="blog-description">
			<a href="https://blog.liang2.tw/about-me/">About</a> |
			<a href="https://blog.liang2.tw/talks/">Talks</a> |
			<a href="https://blog.liang2.tw/archives.html">Archives</a> |
			<button id="color-scheme-cycler" onClick="setColorScheme(nextColorScheme())">
                <svg aria-hidden="true" class="color-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="color-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="color-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="sr-only">Toggle light / dark / auto color theme</span>
            </button>
		</h2>
	</header>
	<main id="content" class="content" role="main">
<article class="post">
    <span class="post-meta">
        <time datetime="2015-10-04">Oct 04, 2015</time>
        in <a href="https://blog.liang2.tw/category/coding/">Coding</a>
    </span>
    <h1 class="post-title">
        <a href="https://blog.liang2.tw/posts/2015/10/django-draw-member/" rel="bookmark" title="Permalink to ç”¨ Django èˆ‡ SQLite æ¶æŠ½ç±¤ç¶²ç«™">ç”¨ Django èˆ‡ SQLite æ¶æŠ½ç±¤ç¶²ç«™</a>
    </h1>
    <span class="post-meta">
                <a href="https://blog.liang2.tw/tag/zh/">zh</a>
                <a href="https://blog.liang2.tw/tag/django/">django</a>
                <a href="https://blog.liang2.tw/tag/sqlite/">sqlite</a>
                <a href="https://blog.liang2.tw/tag/python/">python</a>
    </span>
    <section class="post-content"><h4 id="_1">å‰æƒ…æè¦</h4>
<p>æˆ‘æŠŠ LoveLive! å…©å­£çœ‹å®Œäº†ï¼Î¼&rsquo;s åœ¨ç¬¬ä¸€å­£çš„æˆé•·å……æ»¿æ„Ÿå‹•å•Šã€‚<strong>\çœŸå§«æœ€é«˜/</strong></p>
<p>â€¦â€¦å‘ƒå¥½å•¦ï¼Œä¹‹å‰è¬›äº†<a href="../../09/flask-draw-member">ç”¨ Flask å»æ¶ä¸€å€‹æŠ½ç±¤ç¶²ç«™</a>ã€‚ä¸éæˆ‘å€‘æœ€çµ‚çš„ç›®æ¨™æ˜¯ç”¨ Django å˜›ï¼Œæ‰€ä»¥æ¥ä¸‹ä¾†å°±è¦æ”¹å¯«ã€‚ä¹Ÿè—‰é€™å€‹æ©Ÿæœƒæ¯”è¼ƒä¸€ä¸‹å…©å€‹ Framework è¨­è¨ˆæ¦‚å¿µçš„ä¸åŒï¼ˆ<del>ä¾‹å¦‚ Django ä¸€é–‹å§‹å¯«æœ‰å¤šå†—</del>ã€<del>Flask å¯«åˆ°æœ€å¾Œæœ‰å¤šå†—</del>ï¼‰ã€‚</p>
<h3 id="from-flask-to-django">From Flask to Django</h3>
<p>ç‚ºäº†è½‰æ›ä½†åˆä¸è¦ä¸€ä¸‹å­æŠŠæ‰€æœ‰ Django çš„åŠŸèƒ½éƒ½æ”¾é€²ä¾†ï¼Œä¸­é–“éç¨‹æœ‰å¾ˆå¤šã€Œä¸å¸¸è¦‹çš„å¯«æ³•ã€ã€‚æƒ³è¦ç›´æ¥å¯« Django best practice çš„è©±ï¼Œå¯ä»¥åƒè€ƒ TP å¤§å¤§çš„<a href="https://github.com/uranusjr/django-tutorial-for-programmers">ã€Šç‚ºç¨‹å¼äººå¯«çš„ Django Tutorial ã€‹</a>ï¼Œä»–çš„è¦åŠƒæ˜¯ 30 å€‹å–®å…ƒåšä¸€å€‹è¨‚é¤ç³»çµ±ã€‚</p>
<p>éç¨‹ä¸­æœƒç”¨åˆ°å¾ˆå¤š Django APIï¼Œæ²’æœ‰è§£é‡‹çš„è©±å¯ä»¥åˆ°<a href="https://docs.djangoproject.com/en/1.8/">å®˜ç¶²</a>å»æŸ¥ä½¿ç”¨ã€‚å¦å¤–æˆ‘ç™¼ç¾å¦‚æœèƒ½ç”¨ debugger å» trace Django åŸ·è¡Œçš„æµç¨‹èƒ½å¹«åŠ©ç†è§£ï¼Œæƒ³è¦ä¸€å€‹ç²¾ç¾çš„ debugger çš„è©±å¯ä»¥è£åƒ PyCharm çš„ IDEã€‚</p>
<p>æ•´é«”çš„è¦åŠƒæœƒæ¼¸è¿‘æŠŠ Django çš„åŠŸèƒ½åŠ é€²ä¾†ï¼Œä¾åºæ‡‰è©²æ˜¯ï¼š</p>
<ul>
<li>Django View, Template</li>
<li>Django Model, ORM</li>
<li>Django Form</li>
<li>(Django Admin æ²’æœ‰ç”¨åˆ°)</li>
</ul>
<p>å¦‚æœçœ‹ <a href="https://docs.djangoproject.com/en/1.8/">Django doc</a> é¦–é çš„è©±ï¼Œä¹Ÿæ˜¯åˆ†é€™å¹¾å€‹éƒ¨ä»½ï¼Œé›–ç„¶é€™ç¯‡æ–‡ç« ä¸¦ä¸æœƒæŠŠæ‰€æœ‰æ¦‚å¿µéƒ½ä»‹ç´¹ä¸€éã€‚</p>
<p>å¦å¤–ï¼Œåœ¨æ”¹å¯«çš„æ™‚å€™æœƒè·³éç”¨ raw SQLï¼Œå› ç‚ºå®Œå…¨ä¸ç”¨ ORM æœ‰é»é›£éŠœæ¥å…¶ä»– Django éƒ¨ä»½ã€‚æœ‰èˆˆè¶£çš„è©±åœ¨è¬›å®Œ Model ä¹‹å¾Œå¯ä»¥åƒè€ƒ Detailsã€‚</p>
<div class="toc">
<ul>
<li><a href="#_1">å‰æƒ…æè¦</a></li>
<li><a href="#from-flask-to-django">From Flask to Django</a></li>
<li><a href="#django">Django åˆå§‹è¨­å®š</a><ul>
<li><a href="#django-server">Django server</a></li>
<li><a href="#django-app">ç¬¬ä¸€å€‹ Django app</a></li>
<li><a href="#django-settings">Django settings</a></li>
<li><a href="#database-migration">Database Migration</a></li>
</ul>
</li>
<li><a href="#url-dispatcher">URL dispatcher</a></li>
<li><a href="#django-model-and-orm">Django Model and ORM</a><ul>
<li><a href="#migration-the-tracker-of-model-changes">Migration the tracker of model changes</a></li>
<li><a href="#orm-queries-in-shell">ORM queries in shell</a></li>
<li><a href="#data-in-orm-and-fixtures">Data in ORM and fixtures</a></li>
</ul>
</li>
<li><a href="#django-template">Django Template</a></li>
<li><a href="#more-on-djangos-model-template-and-view-mtv">More on Django&rsquo;s model, template and view (MTV)</a></li>
<li><a href="#django-form">Django Form</a><ul>
<li><a href="#more-django-form-in-view">More Django form in view</a></li>
</ul>
</li>
<li><a href="#_2">ç¸½çµ</a></li>
<li><a href="#details">Details</a><ul>
<li><a href="#raw-sql">Raw SQL</a></li>
<li><a href="#better-queryset">Better QuerySet</a></li>
<li><a href="#timezone">Timezone</a></li>
<li><a href="#post-form-and-csrf">POST form and CSRF</a></li>
</ul>
</li>
</ul>
</div>
<h3 id="django">Django åˆå§‹è¨­å®š</h3>
<p>ä¸€æ¨£é–‹ä¸€å€‹ Python è™›æ“¬ç’°å¢ƒï¼ˆé€™æ™‚å€™å°±æ˜¯å®ƒçš„å¥½è™•äº†ï¼Œèƒ½æŠŠä¸åŒå°ˆæ¡ˆçš„å¥—ä»¶éš”é›¢ï¼‰ã€‚</p>
<div class="highlight"><pre><span></span><code>pip install django pytz ipython pyyaml
</code></pre></div>

<p><a href="http://pythonhosted.org/pytz/">pytz</a> åœ¨<a href="../../09/datetime-sqlite">å‰ä¸€ç¯‡</a>å·²ç¶“ä»‹ç´¹éï¼Œæ˜¯è™•ç†æ™‚å€çš„å¥—ä»¶ã€‚<a href="http://ipython.org/">IPython</a> å…¨åæ˜¯ Interactive Pythonï¼ŒåŒæ¨£æ˜¯ Python shell ä½†æä¾›äº†å¾ˆå¤šé™„åŠ åŠŸèƒ½ï¼Œæœ€å¸¸ç”¨çš„æ‡‰è©²æ˜¯è‡ªå‹•è£œå®Œã€‚<a href="http://pyyaml.org/">PyYAML</a> ç”¨ä¾†è™•ç† YAML ç‰©ä»¶ï¼Œå¯è£å¯ä¸è£ï¼Œä¸è£ä¹‹å¾Œçš„ä¾‹å­å°±ç”¨ JSON å³å¯ã€‚</p>
<p>æˆ‘å€‘çš„å°ˆæ¡ˆæ ¹ç›®éŒ„æ˜¯ <code>demo_django_draw_member</code>ã€‚å› ç‚º Django çš„è¨­å®šå¾ˆå¤šï¼Œå…ˆåœ¨é€™ç›®éŒ„ä¸‹ç”¨ <a href="https://docs.djangoproject.com/en/1.8/ref/contrib/admin/">django-admin</a> æŠŠåŸºæœ¬çš„æ¶æ§‹å»ºèµ·ä¾†ã€‚æˆ‘å€‘å»ºäº†ä¸€å€‹åç‚º <code>draw_site</code> çš„å°ˆæ¡ˆï¼ˆProjectï¼‰ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>VENV<span class="o">)</span> $ django-admin startproject draw_site
</code></pre></div>

<p>åŸ·è¡Œå®Œä¹‹å¾Œæ‡‰è©²æœƒå¤šå‡ºä¸€å †æª”æ¡ˆï¼Œçµæ§‹å¦‚ä¸‹ã€‚æ³¨æ„åˆ°æœ‰å…©å±¤ <code>draw_site</code>ã€‚</p>
<div class="highlight"><pre><span></span><code>demo_django_draw_member/
â””â”€â”€ draw_site/
    â”œâ”€â”€ draw_site/
    â”‚Â Â  â”œâ”€â”€ __init__.py
    â”‚Â Â  â”œâ”€â”€ settings.py
    â”‚Â Â  â”œâ”€â”€ urls.py
    â”‚Â Â  â””â”€â”€ wsgi.py
    â””â”€â”€ manage.py*
</code></pre></div>

<p>ä¹‹å¾Œå·¥ä½œçš„ç›®éŒ„å…¶å¯¦æ˜¯ <code>demo_django_draw_member/draw_site/</code>ï¼Œä¹Ÿå°±æ˜¯æœ‰ <code>manage.py</code> çš„é‚£å±¤ç›®éŒ„ï¼Œä¹‹å¾Œçš„è·¯å¾‘éƒ½æ˜¯ç›¸å°æ–¼ <code>demo_django_draw_member/draw_site/</code>ã€‚ä»‹ç´¹ä¸€ä¸‹æ¯å€‹æª”æ¡ˆã€‚</p>
<ul>
<li><code>manage.py</code> ä¹‹å¾Œå°±æœƒå–ä»£ django-admin çš„åŠŸèƒ½ã€‚å…©è€…æœ€å¤§çš„å·®åˆ¥æ˜¯ manage.py çŸ¥é“ project çš„è¨­å®šã€‚</li>
<li><code>draw_site/settings.py</code> è£¡é¢å­˜è‘— Django çš„å„ç¨®è¨­å®šï¼Œåƒ secret keyã€databaseã€template engineã€app ç­‰ã€‚</li>
<li><code>draw_site/urls.py</code> è£¡é¢å­˜è‘— URL dispatching è¨­å®šï¼Œå³å“ªå€‹è·¯å¾‘è¦ç”¨å“ªå€‹ function å»è™•ç†ã€‚</li>
<li><code>draw_site/wsgi.py</code> <a href="http://wsgi.org/">WSGI</a> æ˜¯è¦ç¯„ Python web server çš„æ¨™æº–ï¼Œé€šå¸¸ä¸æœƒå‹•é€™å€‹æª”æ¡ˆå°±ä¸ç´°æã€‚Flaskã€Django éƒ½æ˜¯ç›¸å®¹ WSGI çš„å¯¦ä½œã€‚</li>
</ul>
<p>ä¸€å€‹ Django ç”±ä¸€å€‹ project å’Œå¾ˆå¤šå€‹ apps æ‰€çµ„æˆã€‚æ¯å€‹ app å°±å°ˆæ³¨åœ¨ç¶²ç«™çš„æŸå€‹åŠŸèƒ½ä¸Šï¼Œå„è‡ªåŒ…è‘—å„è‡ªéœ€è¦çš„ database schemaã€templateã€view logicsã€‚é€™æ¨£çš„å¥½è™•æ˜¯åŒæ¨£çš„åŠŸèƒ½å°±ä¸ç”¨é‡å¯«ï¼ŒåŒæ™‚åœ¨å¾ˆå¤§çš„ç¶²ç«™æ™‚é€™æ¨£çš„çµæ§‹æœ‰åŠ©æ–¼ç®¡ç†é‹ä½œçš„é‚è¼¯ã€‚</p>
<h4 id="django-server">Django server</h4>
<p>å…ˆæŠŠ Django è·‘èµ·ä¾†çœ‹çœ‹å§ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>python manage.py runserver
<span class="go">...</span>
<span class="go">Django version 1.8.5, using settings &#39;draw_site.settings&#39;</span>
<span class="go">Starting development server at http://127.0.0.1:8000/</span>
</code></pre></div>

<figure class="align-center">
  <img src="https://blog.liang2.tw/posts/2015/10/django-draw-member/pics/django_initial.png"/>
  <figcaption>Django Hello World</figcaption>
</figure>

<p>é€™æ˜¯ Django å…§å»ºåœ¨ä»€éº¼ URL éƒ½æ²’è¨­å®šæ™‚çš„æ­¡è¿ç•«é¢ã€‚çœ‹åˆ°é€™å€‹è‡³å°‘è¡¨ç¤ºåŸºæœ¬çš„ settings æ­£å¸¸ã€‚Django è·Ÿ Flask ä¸€æ¨£ï¼Œå…§å»ºçš„ server æœƒåœ¨ source code æœ‰æ”¹è®Šçš„æ™‚å€™ reloadï¼Œæ‰€ä»¥ä¸€ç›´é–‹è‘—è·‘ä¹Ÿå¯ä»¥ã€‚</p>
<h4 id="django-app">ç¬¬ä¸€å€‹ Django app</h4>
<p>æˆ‘å€‘çš„ç¶²ç«™åªæœƒç”¨åˆ°ä¸€å€‹ appï¼ŒæŠŠå®ƒå»ºå‡ºä¾†å–åç‚º <code>draw_member</code>ã€‚</p>
<div class="highlight"><pre><span></span><code>python manage.py startapp draw_member
</code></pre></div>

<div class="highlight"><pre><span></span><code>demo_django_draw_member/
â””â”€â”€ draw_site/
    â”œâ”€â”€ draw_member/
    â”‚Â Â  â”œâ”€â”€ __init__.py
    â”‚Â Â  â”œâ”€â”€ admin.py
    â”‚Â Â  â”œâ”€â”€ migrations/
    â”‚Â Â  â”œâ”€â”€ models.py
    â”‚Â Â  â”œâ”€â”€ tests.py
    â”‚Â Â  â””â”€â”€ views.py
    â”œâ”€â”€ draw_site/
    â”‚Â Â  â””â”€â”€ ...
    â””â”€â”€ manage.py*
</code></pre></div>

<p>å¯ä»¥çœ‹åˆ° app èˆ‡ project çš„æ¶æ§‹æ˜¯ä¸ä¸€æ¨£çš„ã€‚</p>
<p>è¦æŠŠé€™å€‹æ–°çš„ app åŠ åˆ° project è£¡ï¼Œä¿®æ”¹ <code>draw_site/settings.py</code>ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># draw_site/settings.py</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;draw_member&#39;</span><span class="p">,</span>    <span class="c1"># åŠ é€™ä¸€è¡Œ</span>
    <span class="s1">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<p>é è¨­å…¶å¯¦è£äº†å¾ˆå¤š appã€‚æš«æ™‚ä¸ç†ä»–å€‘æ˜¯ä»€éº¼ã€‚</p>
<h4 id="django-settings">Django settings</h4>
<p>å…ˆç°¡å–®ä»‹ç´¹ä¸€ä¸‹ <code>draw_site/settings.py</code>ã€‚é™¤äº†å‰›å‰›ç”¨åˆ° INSTALLED_APPSï¼Œè¬›å¹¾å€‹è·Ÿé€™é‚Šæ¯”è¼ƒæœ‰é—œçš„åƒæ•¸ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Database</span>
<span class="c1"># https://docs.djangoproject.com/en/1.8/ref/settings/#databases</span>

<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.sqlite3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;db.sqlite3&#39;</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Internationalization</span>
<span class="c1"># https://docs.djangoproject.com/en/1.8/topics/i18n/</span>

<span class="n">LANGUAGE_CODE</span> <span class="o">=</span> <span class="s1">&#39;en-us&#39;</span>
<span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s1">&#39;UTC&#39;</span>
<span class="n">USE_TZ</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

<p>DATABSES è£¡å®šç¾©äº†ä½¿ç”¨çš„è³‡æ–™åº«ã€‚é è¨­æœƒä½¿ç”¨ <code>db.sqlite3</code> é€™å€‹ SQLite è³‡æ–™åº«ã€‚</p>
<p>å†ä¾†æ˜¯èªè¨€ã€æ™‚å€çš„è¨­å®šã€‚é è¨­æ˜¯ UTC ä¸¦ä¸”ä½¿ç”¨ timezoneï¼Œä¹Ÿå°±æ˜¯ server çš„æ™‚é–“éƒ½æ˜¯ç”¨ UTC è¨˜éŒ„çš„ã€‚</p>
<h4 id="database-migration">Database Migration</h4>
<p>åœ¨ä»€éº¼ code éƒ½é‚„æ²’å¯«ä¹‹å‰ï¼Œä»‹ç´¹ä¸€å€‹ database è§€å¿µï¼š<a href="https://docs.djangoproject.com/en/1.8/topics/migrations/">migration</a>ã€‚</p>
<p>åœ¨ä¹‹å‰çš„ä¾‹å­å¯ä»¥çŸ¥é“ï¼Œæˆ‘å€‘æœƒå…ˆè¨­è¨ˆä¸€å€‹è³‡æ–™åº«è©²å­˜ä»€éº¼æ±è¥¿ï¼Œæ•´å€‹ç¶²ç«™æµç¨‹æœƒæ€éº¼ç”¨é€™äº›è³‡æ–™ï¼Œé€™äº›å½¢æˆ table schemaã€‚ä½†æ˜¯éš¨è‘—æ™‚é–“ï¼Œå¯èƒ½ç¶²ç«™æœ‰æ–°çš„åŠŸèƒ½ï¼Œå¾ˆé›£èªªå®Œå…¨ä¸å»æ›´å‹• schemaã€‚</p>
<p>æ›´å‹• schema ä¸æ˜¯ä»¶ç°¡å–®çš„äº‹ï¼Œå¦‚æœæ˜¯ä¸Š production çš„ç¶²ç«™ï¼Œè³‡æ–™åº«æœƒæœ‰é‹ä½œä»¥ä¾†ç´¯ç©çš„è³‡æ–™ï¼Œç¸½ä¸èƒ½ schema æ”¹äº†é€™äº›è³‡æ–™å°±ä¸Ÿæ‰å§ï¼Ÿè€Œä¸”åœ¨ç¶²ç«™é–‹ç™¼çš„æ™‚å€™ï¼Œåœ¨ä¸åŒç‰ˆæœ¬çš„ï¼ˆæˆ–ä¸åŒäººé–‹ç™¼çš„ï¼‰code å°±å¯èƒ½æœ‰ä¸åŒçš„ schemaã€‚è¦æ€éº¼ç¢ºä¿ code èˆ‡ database çš„ç‹€æ…‹å°±è¦é  migrationã€‚</p>
<p>â€¦â€¦ä¸€é–‹å§‹å°±é€™éº¼è¤‡é›œï¼Ÿå¥½å•¦æˆ‘å€‘çš„ä¾‹å­æ²’æœ‰ç”¨åˆ° migration å¤§å¤šæ•¸çš„åŠŸèƒ½ï¼Œåªæœ‰ç”¨å®ƒ initiate databaseã€‚å…§å»ºçš„ app éƒ½æœ‰è‡ªå·±çš„ database schemaï¼Œå¯ä»¥ç”¨å®ƒæŠŠè³‡æ–™åº«çš„ table å»ºå‡ºä¾†ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>python manage.py migrate
<span class="go">Operations to perform:</span>
<span class="go">  Synchronize unmigrated apps: messages, staticfiles</span>
<span class="go">  Apply all migrations: sessions, auth, contenttypes, admin</span>
<span class="go">Synchronizing apps without migrations:</span>
<span class="go">  Creating tables...</span>
<span class="go">    Running deferred SQL...</span>
<span class="go">  Installing custom SQL...</span>
<span class="go">Running migrations:</span>
<span class="go">  Rendering model states... DONE</span>
<span class="go">  Applying contenttypes.0001_initial... OK</span>
<span class="go">  Applying auth.0001_initial... OK</span>
<span class="go">  Applying admin.0001_initial... OK</span>
<span class="go">  Applying contenttypes.0002_remove_content_type_name... OK</span>
<span class="go">  Applying auth.0002_alter_permission_name_max_length... OK</span>
<span class="go">  Applying auth.0003_alter_user_email_max_length... OK</span>
<span class="go">  Applying auth.0004_alter_user_username_opts... OK</span>
<span class="go">  Applying auth.0005_alter_user_last_login_null... OK</span>
<span class="go">  Applying auth.0006_require_contenttypes_0002... OK</span>
<span class="go">  Applying sessions.0001_initial... OK</span>
</code></pre></div>

<p>migration å°±æœƒä¸€æ­¥æ­¥æŠŠ database èª¿æ•´åˆ°ç¬¦åˆç¾åœ¨ code çš„ç‹€æ…‹ï¼Œé€™äº›èª¿æ•´å°±æœƒè¨˜éŒ„åœ¨ <code>&lt;app&gt;/migrations/</code> åº•ä¸‹ï¼Œç­‰ç­‰å°±æœƒçœ‹åˆ°äº†ã€‚</p>
<h3 id="url-dispatcher">URL dispatcher</h3>
<p>æˆ‘å€‘æ¥ä¸‹ä¾†è¦æ”¹é¦–é ï¼ŒæŠŠ Django é è¨­çš„ <code>/</code> é¦–é æ›æˆ Hello Worldã€‚</p>
<p>Flask URL routing æ˜¯ç›´æ¥ç”¨ decorator å¯«åœ¨ view function ä¸Šé¢ã€‚å¹«å¤§å®¶å›é¡§ä¸€ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;p&gt;Hello World!&lt;/p&gt;&quot;</span>
</code></pre></div>

<p>Django çš„ view å’Œ URL æ˜¯åˆ†é–‹çš„ï¼Œé¦–å…ˆæ˜¯ viewï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1"># draw_member/views.py</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>  <span class="c1"># å…ˆæš«æ™‚ç•™è‘—</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;Hello World!&lt;/p&gt;&quot;</span><span class="p">)</span>
</code></pre></div>

<p>çµæ§‹ä¸Šå¤§åŒå°ç•°ï¼ˆä¹Ÿå› ç‚ºæœ‰ <a href="http://wsgi.org/">WSGI</a> è¦ç¯„çš„é—œä¿‚å•¦ï¼‰ã€‚</p>
<p>å†ä¾†æ˜¯ URL è¨­å®šã€‚æˆ‘å€‘å…ˆæŠŠ URL åŠ åœ¨ project è¨­å®šã€‚é€™é‚Šå¯èƒ½è¦ºå¾—è¨­å®šæœ‰é»åˆ†æ•£æ¯”è¼ƒæ€ªï¼Œç­‰ä¸€ä¸‹å†æŠŠå®ƒæ”¾åˆ° app è£¡é¢ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># draw_site/urls.py</span>
<span class="sd">&quot;&quot;&quot;draw_site URL Configuration</span>

<span class="sd">The `urlpatterns` list routes URLs to views. For more information please see:</span>
<span class="sd">    https://docs.djangoproject.com/en/1.8/topics/http/urls/</span>
<span class="sd">...</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">draw_member.views</span> <span class="kn">import</span> <span class="n">home</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">home</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;home&quot;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">]</span>
</code></pre></div>

<p>æ¦‚å¿µä¹Ÿå¾ˆç°¡å–®ï¼ŒæŠŠè¦çš„ view function å¾ app import é€²ä¾†ï¼ˆæ‰€ä»¥ app ç›®éŒ„æ˜¯å€‹ Python moduleï¼Œåº•ä¸‹æœƒ <code>__init__.py</code>ï¼‰ï¼Œçµ¦ä¸€å€‹ regex è¡¨ç¤ºçš„è·¯å¾‘ï¼Œå¾Œé¢æ”¾ä¸Šè™•ç† function ä»¥åŠä¸€å€‹ optional çš„åå­—ï¼Œé€™å€‹åå­—å°±ä»£è¡¨äº†é€™å€‹ URL è·¯å¾‘ï¼Œä¹‹å¾Œå¯ä»¥åæŸ¥ã€‚</p>
<p>æ¸¬ä¸€ä¸‹ç¢ºèªè¨­å®šéƒ½æ˜¯æ­£ç¢ºçš„ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>curl -XGET <span class="s2">&quot;localhost:8000&quot;</span>
<span class="go">&lt;p&gt;Hello World!&lt;/p&gt;</span>
</code></pre></div>

<p>å†çœ‹ä¸€ä¸‹ <code>draw_site/urls.py</code>ï¼Œå¯ä»¥çœ‹åˆ° Django é è¨­æ”¾äº†å€‹ <code>/admin</code> å¾Œé¢ç”¨çš„æ˜¯ <code>include(app.urls)</code>ï¼Œè¡¨ç¤ºé€™ä¸€æ•´åŒ…åªè¦æ˜¯ admin/ é–‹é ­çš„ URL éƒ½äº¤çµ¦ admin.site.urls å»è™•ç†è·¯å¾‘ã€‚é€™æ¨£æ–¹ä¾¿ app åœ¨ä¸åŒç¶²ç«™ä¸­é‡è¦†åˆ©ç”¨ï¼Œå› ç‚ºå¯èƒ½æ”¾çš„è·¯å¾‘éƒ½ä¸ä¸€æ¨£ï¼Œä½†ä¸€å€‹ app å…§çš„ URL è™•ç†æœƒæœ‰ä¸€è‡´æ€§ã€‚</p>
<p>é¦¬ä¸Šä¾†æ”¹å¯«ä¸€ä¸‹ã€‚é¦–å…ˆåœ¨ app <strong>draw_member</strong> åº•ä¸‹åŠ ä¸€å€‹ <code>urls.py</code>ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># draw_member/urls.py</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">home</span>  <span class="c1"># explicit relative import</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">home</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;home&quot;</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>

<p>åŸºæœ¬ä¸Šæ ¼å¼å°±æ˜¯ç…§æŠ„åŸæœ¬å°±æœ‰çš„ã€‚å› ç‚ºæ”¾åœ¨åŒå€‹ app è£¡é¢äº†ï¼Œimport view æ™‚å°±å¯ä»¥ç”¨ explicit relative importï¼ˆé€™ä¸æ˜¯ relative import å–”ï¼‰</p>
<p>åŸæœ¬çš„ urls.py å°±æ”¹æˆæŠŠ URL çš„è™•ç†ã€Œdispatchã€çµ¦é€™å€‹ appï¼Œæ”¹æˆåº•ä¸‹é€™æ¨£ã€‚</p>
<div class="highlight"><pre><span></span><code># draw_site/urls.py
from django.conf.urls import include, url
from django.contrib import admin


urlpatterns = [
    url(r&#39;^admin/&#39;, include(admin.site.urls)),
    url(r&#39;^&#39;, include(&#39;draw_member.urls&#39;)),
]
</code></pre></div>

<p><code>r'^'</code> ä»£è¡¨å¾æ ¹ç›®éŒ„å°±äº¤çµ¦é€™å€‹ app å»ç®¡ç†ï¼Œä¹Ÿå› ç‚ºé€™æ¨£æ¯”è¼ƒå°ˆä¸€çš„è·¯å¾‘è¦æ”¾å‰é¢ï¼Œåƒæ˜¯ /adminã€‚ç”¨å­—ä¸²è¡¨ç¤ºåœ¨åŸ·è¡Œçš„æ™‚å€™æ‰ import é€™å€‹ moduleï¼Œä¸æƒ³ä¹Ÿå¯ä»¥æ‹¿æ‰å­—ä¸²æŠŠ app import é€²ä¾†ã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯æœ€åŸºæœ¬çš„ <a href="https://docs.djangoproject.com/en/1.8/topics/http/urls/">URL dispatching</a>ã€‚</p>
<h3 id="django-model-and-orm">Django Model and ORM</h3>
<p>æ¥è‘—è™•ç†è³‡æ–™åº«çš„å•é¡Œã€‚ç•¶ç„¶å¯ä»¥åœ¨ Django è£¡é¢å¯« raw SQLï¼Œä½†é€™é‚Šæä¾›å¦ä¸€å€‹æƒ³æ³•ï¼šObject-relational Mapping (ORM)ã€‚ORM æŠŠè³‡æ–™ç”¨ç‰©ä»¶å°å‘çš„æ–¹å¼æ•´ç†ï¼ŒæŠŠ SQLã€tableã€database çš„ç´°ç¯€äº¤çµ¦ ORM engine å»ç¿»è­¯ã€‚é€™å¯ä»¥åœ¨æ‰¾åˆ°éå¸¸å¤šä»‹ç´¹ï¼Œç›´æ¥è·³åˆ°å¯¦ä½œã€‚</p>
<pre style="font-family: Consolas, 'Courier New', monospace">
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ members             â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ id          INTEGER â”‚ <â”€â”
    â”‚ name           TEXT â”‚   â”‚
    â”‚ group_name     TEXT â”‚   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚ draw_histories      â”‚   â”‚ foreign
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚ key
    â”‚ memberid    INTEGER â”‚ â”€â”€â”˜
    â”‚ time       DATETIME â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>

<p>å›æƒ³ä¸€ä¸‹æˆ‘å€‘çš„ schema è¨­è¨ˆã€‚æ”¹ç”¨ ORM ä¾†æ€è€ƒæˆ‘å€‘å°±æœƒæœ‰æˆå“¡ï¼ˆMemberï¼‰ä»¥åŠæŠ½ç±¤æ­·å²ï¼ˆHistoryï¼‰å…©å¤§ modelsã€‚<strong>Member</strong> è¨˜éŒ„äº†åå­—èˆ‡æ‰€å±¬åœ˜é«”ï¼›<strong>History</strong> æœƒè¨˜éŒ„æ™‚é–“ã€é€™ç­†æŠ½ç±¤æ˜¯å±¬æ–¼å“ªå€‹æˆå“¡çš„ã€‚</p>
<p>åœ¨ Django ä¸­ï¼Œmodel å®šç¾©åœ¨ <code>models.py</code> è£¡é¢ï¼Œé¦¬ä¸Šä¾†å¯«å¯«çœ‹ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># draw_members/models.py</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.utils.timezone</span> <span class="kn">import</span> <span class="n">now</span>


<span class="k">class</span> <span class="nc">Member</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
    <span class="n">group_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_name</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">History</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">member</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Member</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;draw_histories&quot;</span><span class="p">)</span>
    <span class="c1"># now() will return datetime.utcnow()</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">now</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">member</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
</code></pre></div>

<p>ä¸€å€‹ class è£¡çš„å±¬æ€§å°±å°æ‡‰åˆ°ä¸€å€‹æ¬„ä½ï¼ˆFieldï¼‰ï¼Œæ¬„ä½æœƒæœ‰ä»–çš„å‹åˆ¥ä»¥åŠè³‡æ–™åº«å¯¦ä½œä¸Šçš„é™åˆ¶ï¼ˆä¾‹å¦‚å­—ä¸²æœ‰ä¸Šé™ï¼Œç•¶ç„¶ä¹Ÿå¯ä»¥ä¸è¨­ï¼‰ã€‚Field type å¯ä»¥åƒè€ƒ<a href="https://docs.djangoproject.com/en/1.8/ref/models/fields/#field-types">å®˜ç¶²</a>ã€‚</p>
<p><strong>Member</strong> åº•ä¸‹éƒ½æ˜¯å­—ä¸²æ‰€ä»¥æ˜¯ <code>CharField</code>ã€‚ <strong>History</strong> ç¨å¾®è¤‡é›œä¸€é»ï¼Œæ™‚é–“çš„è¨˜éŒ„ date ç”¨ <code>DateTimeField</code>ï¼Œé€™æ¨£æ¬„ä½æ‹¿å›ä¾†å°±æœƒè½‰æ›æˆ Python datetime objectï¼›å¦ä¸€å€‹ member ç”¨çš„æ˜¯ <code>ForeignKey</code>ï¼Œä¹Ÿå°±æ˜¯ relationship fieldï¼Œä¾†è¡¨ç¤ºé€™ç­†æŠ½ç±¤å±¬æ–¼æ‹¿å€‹æˆå“¡ã€‚å¾Œé¢çš„ <code>related_name</code> æä¾›äº†åæŸ¥åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯èƒ½å¾ä¸€å€‹ member å»æŸ¥ä»–æ‰€æœ‰çš„ historiesã€‚</p>
<p>åŒæ™‚å…ˆå¯«å¥½å…©å€‹ class åº•ä¸‹çš„ <code>__str__</code>ï¼Œé€™æ¨£ç­‰ä¸‹åœ¨ Python shell æ“ä½œæ™‚å®¹æ˜“è¾¨èªæ¯å€‹ç‰©ä»¶çš„å…§å®¹ã€‚</p>
<h4 id="migration-the-tracker-of-model-changes">Migration the tracker of model changes</h4>
<p>å¤šèªªç„¡ç”¨ï¼Œé¦¬ä¸Šä¾†è©¦ä¸€è©¦ã€‚</p>
<p>â€¦â€¦ç­‰ç­‰ï¼Œæƒ³åˆ° migration äº†å—ï¼Ÿæ¯æ¬¡æ›´å‹• database model éƒ½è¦è·‘ migrationï¼Œç¢ºä¿ code èˆ‡è³‡æ–™åº«ç‹€æ…‹ä¸€è‡´ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>python manage.py makemigrations draw_member
<span class="go">python manage.py makemigrations draw_member</span>
<span class="go">Migrations for &#39;draw_member&#39;:</span>
<span class="go">  0001_initial.py:</span>
<span class="go">    - Create model History</span>
<span class="go">    - Create model Member</span>
<span class="go">    - Add field member to history</span>
</code></pre></div>

<p>å¯ä»¥çœ‹åˆ° Django å¾ˆè°æ˜çš„çŸ¥é“æˆ‘å€‘å¤šå®šç¾©äº†å…©å€‹ modelsï¼Œè£¡é¢æœ‰äº›å°æ‡‰åˆ°è³‡æ–™åº«çš„æ¬„ä½å‹æ…‹ã€‚é€™äº›è³‡è¨Šæœƒå¯«åœ¨ migration file è£¡é¢ï¼Œ</p>
<div class="highlight"><pre><span></span><code><span class="c1"># draw_member/migrations/0001_initial.py</span>
<span class="k">class</span> <span class="nc">Migration</span><span class="p">(</span><span class="n">migrations</span><span class="o">.</span><span class="n">Migration</span><span class="p">):</span>

    <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">]</span>

    <span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">migrations</span><span class="o">.</span><span class="n">CreateModel</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;History&#39;</span><span class="p">,</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">serialize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">auto_created</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">django</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">)),</span>
            <span class="p">],</span>
        <span class="p">),</span>
        <span class="n">migrations</span><span class="o">.</span><span class="n">CreateModel</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Member&#39;</span><span class="p">,</span>
            <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">serialize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">auto_created</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">256</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;group_name&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">256</span><span class="p">)),</span>
            <span class="p">],</span>
        <span class="p">),</span>
        <span class="n">migrations</span><span class="o">.</span><span class="n">AddField</span><span class="p">(</span>
            <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;history&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;member&#39;</span><span class="p">,</span>
            <span class="n">field</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="s1">&#39;draw_member.Member&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;draw_histories&#39;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">]</span>
</code></pre></div>

<p>æ³¨æ„åˆ° Django ORM è‡ªå‹•å¹«æˆ‘å€‘åŠ äº† <code>id</code> é€™å€‹ primary keyï¼Œç­‰ç­‰å°±æœƒç”¨åˆ°ã€‚Migration è£¡é¢çš„ç´°ç¯€ç­‰å° Django æ›´ç†Ÿäº†ä¹‹å¾Œå°±èƒ½æ…¢æ…¢äº†è§£äº†ã€‚</p>
<p>æœ‰äº†æ–°çš„ migration å°±è¦åŒæ­¥è³‡æ–™åº«çš„ç‹€æ…‹ï¼Œ</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>python manage.py migrate
<span class="go">...</span>
<span class="go">Running migrations:</span>
<span class="go">  Rendering model states... DONE</span>
<span class="go">  Applying draw_member.0001_initial... OK</span>
</code></pre></div>

<h4 id="orm-queries-in-shell">ORM queries in shell</h4>
<p>æ¥ä¸‹ä¾†æˆ‘å€‘æ“ä½œä¸€ä¸‹ ORMã€‚</p>
<div class="highlight"><pre><span></span><code>$ python manage.py shell
</code></pre></div>

<p>å°±æœƒæ‰“é–‹ä¸€å€‹ Python shellã€‚å¦‚æœè£äº† IPython å°±æœƒæ‰“é–‹ IPython shellã€‚
é€™å€‹èˆ‡ä¸€èˆ¬çš„æœ‰ä»€éº¼å·®åˆ¥å‘¢ï¼Ÿä»–æœƒå¸¶æœ‰ Django project çš„è¨­å®šã€‚å¦‚æœæ˜¯å¾ä¸€èˆ¬çš„ shell å¯ä»¥å…ˆè·‘ä»¥ä¸‹çš„æŒ‡ä»¤ä¾†é”åˆ°ç›¸åŒçš„æ•ˆæœã€‚</p>
<div class="highlight"><pre><span></span><code><span class="go">$ DJANGO_SETTINGS_MODULE=&quot;draw_site.settings&quot; python</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">django</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">django</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>In [1]: from draw_member.models import Member, History
In [2]: m1 = Member(name=&quot;é«˜å‚ ç©‚ä¹ƒæœ&quot;, group_name=&quot;Î¼&#39;s&quot;)
In [4]: m2 = Member(name=&quot;å¹³æ²¢ å”¯&quot;, group_name=&quot;K-ON!&quot;)
In [5]: m1, m2
Out[5]: (&lt;Member: é«˜å‚ ç©‚ä¹ƒæœ of Î¼&#39;s&gt;, &lt;Member: å¹³æ²¢ å”¯ of K-ON!&gt;)
In [7]: m1.save()
In [8]: m2.save()
In [6]: h1 = History(member=m1)
In [9]: h1.save()
</code></pre></div>

<p>ä½¿ç”¨ä¸Šå°±æŠŠè³‡æ–™ç•¶ä½œç‰©ä»¶ä¾†æ“ä½œï¼Œå¦‚åŒ ORM å­—é¢çš„æ„æ€ã€‚æ³¨æ„åªæœ‰åœ¨ <code>.save()</code> æ‰çœŸæ­£è¢«å­˜åˆ°è³‡æ–™è£¡ã€‚æ‹¿æ²’æœ‰å­˜çš„ object ä¾†æ“ä½œ database å°±æœƒå‡ºç¾ exceptionã€‚</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">h_failed</span> <span class="o">=</span> <span class="n">History</span><span class="p">(</span><span class="n">member</span><span class="o">=</span><span class="n">Member</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;FF&#39;</span><span class="p">,</span> <span class="n">group_name</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h_failed</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">IntegrityError</span>: <span class="n">NOT NULL constraint failed: draw_member_history.member_id</span>
</code></pre></div>

<p>è¦ºå¾—éº»ç…©çš„è©±ï¼Œç”¨ <code>Model.objects.create()</code> å°±å¯ä»¥ä¸€æ­¥æå®šã€‚æ­£ç¢ºçš„å­˜å¥½ä¹‹å¾Œï¼Œç¾åœ¨è³‡æ–™åº«å·²ç¶“æœ‰è³‡æ–™äº†ã€‚æˆ‘å€‘å¯ä»¥å…ˆåœ¨ SQLite è£¡ç¢ºèªã€‚</p>
<div class="highlight"><pre><span></span><code><span class="go">-- sqlite3 db.sqlite3</span>
<span class="gp">sqlite&gt;</span><span class="w"> </span><span class="p">.</span><span class="n">header</span><span class="w"> </span><span class="k">on</span><span class="w"></span>
<span class="gp">sqlite&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">draw_member_member</span><span class="p">;</span><span class="w"></span>
<span class="go">id|name|group_name</span>
<span class="go">1|é«˜å‚ ç©‚ä¹ƒæœ|Î¼&#39;s</span>
<span class="go">2|å¹³æ²¢ å”¯|K-ON!</span>
<span class="gp">sqlite&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">draw_member_history</span><span class="p">;</span><span class="w"></span>
<span class="go">id|time|member_id</span>
<span class="go">1|2015-10-05 15:17:32.061384|1</span>
</code></pre></div>

<p>é€éåƒå‰›å‰› object çš„æ“ä½œï¼Œæˆ‘å€‘ä¹Ÿèƒ½å»ºå‡ºå¦‚åŒæ‰‹å¯« SQL ä¸€æ¨£çš„è³‡æ–™åº«ï¼Œç•¶ç„¶åƒ <code>id</code>ã€<code>member_id</code> é€™äº›æ¬„ä½æ˜¯ ORM engine è‡ªå‹•å¹«æˆ‘å€‘åšå‡ºä¾†çš„ï¼Œé€™äº›å¯ä»¥è‡ªè¨‚ï¼Œä¸éé è¨­çš„è¡Œç‚ºä¸é›£ç†è§£ã€‚</p>
<p>è¦æ€éº¼å¾ ORM åƒå‰›å‰›ä¸‹ SQL ä¸€æ¨£æ’ˆè³‡æ–™å‘¢ï¼Ÿ</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">draw_member.models</span> <span class="kn">import</span> <span class="n">Member</span><span class="p">,</span> <span class="n">History</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">[&lt;Member: é«˜å‚ ç©‚ä¹ƒæœ of Î¼&#39;s&gt;, &lt;Member: å¹³æ²¢ å”¯ of K-ON!&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">History</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">[&lt;History: é«˜å‚ ç©‚ä¹ƒæœ at 2015-10-05 15:17:32.061384+00:00&gt;]</span>
</code></pre></div>

<p>è³‡æ–™é€é <code>Model.objects</code> é€™å€‹ Manager å»æŸ¥è©¢ï¼Œç´°ç¯€å°±å»çœ‹ Django é—œæ–¼ <a href="https://docs.djangoproject.com/en/1.8/topics/db/queries">Making queries</a> çš„å…§å®¹å§ã€‚æŸ¥è©¢è³‡æ–™åº«å°±æœƒå›å‚³ <a href="https://docs.djangoproject.com/en/1.8/ref/models/querysets/#django.db.models.query.QuerySet">QuerySet</a>ï¼Œé€™ä¸¦ä¸æœƒçœŸçš„å»ã€ŒæŸ¥ã€è³‡æ–™åº«ï¼Œä½†å…ˆæŠŠæŒ‡ä»¤å­˜è‘—ç­‰çœŸçš„è¦ç”¨åˆ°å€¼æ™‚æ‰å»è¨ˆç®—ï¼Œä¹Ÿå°±æ˜¯ lazy evaluationã€‚</p>
<p>QuerySet åº•ä¸‹å°±æœ‰å¾ˆå¤šå°æ‡‰åˆ° SQL æŒ‡ä»¤çš„æŸ¥è©¢ï¼Œåƒæ˜¯æ‹¿å›æ‰€æœ‰ objects çš„ <code>QuerySet.all()</code>ï¼Œå‰é¢å·²ç¶“ç”¨éäº†ã€‚æˆ–è€…ç¯©é¸çš„ <code>QuerySet.filter()</code>ï¼Œ</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">group_name</span><span class="o">=</span><span class="s1">&#39;K-ON!&#39;</span><span class="p">)</span>
<span class="go">[&lt;Member: å¹³æ²¢ å”¯ of K-ON!&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">group_name__contains</span><span class="o">=</span><span class="s1">&#39;!&#39;</span><span class="p">)</span>
<span class="go">[&lt;Member: å¹³æ²¢ å”¯ of K-ON!&gt;]</span>
</code></pre></div>

<p>å…¶ä¸­ <code>&lt;field&gt;__contains</code> å°±æ˜¯ Django ORM ç‚ºäº†å¯¦åšåƒ SQL <code>LIKE</code> æŒ‡ä»¤çš„å°æ‡‰æ¬„ä½ã€‚</p>
<p>å…ˆè¬›å¹¾å€‹æœ‰é—œçš„ï¼Œé¦–å…ˆæ¯å€‹ Model éƒ½æœ‰å€‹ primary key <code>pk</code>ï¼Œé è¨­æŒ‡åˆ° <code>Model.id</code> é€™å€‹æ¬„ä½ä¸Šï¼Œå¦ç”¨ <code>QuerySet.get()</code> å¯ä»¥æ‹¿åˆ°å–®ä¸€ç‰©ä»¶ï¼Œé€™æ™‚å€™è¬ç”¨çš„ pk å°±æ´¾ä¸Šç”¨å ´äº†ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">&lt;Member: é«˜å‚ ç©‚ä¹ƒæœ of Î¼&#39;s&gt;</span>
</code></pre></div>

<p>æŸ¥ relation ä¹Ÿå¾ˆç°¡å–®ï¼Œ</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">h1</span> <span class="o">=</span> <span class="n">History</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h1</span><span class="o">.</span><span class="n">member</span>
<span class="go">&lt;Member: é«˜å‚ ç©‚ä¹ƒæœ of Î¼&#39;s&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">h1</span><span class="o">.</span><span class="n">member</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;é«˜å‚ ç©‚ä¹ƒæœ&#39;</span>
</code></pre></div>

<p>é‚„è¨˜å¾—ä¹‹å‰è¨­å¾— <code>related_name="draw_histories"</code>ï¼Œè¡¨ç¤ºæˆ‘å€‘èƒ½å¾ <strong>Member</strong> åæŸ¥å›å»è©²äººç›¸é—œçš„æ­·å²ï¼Œ</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">m1</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m1</span><span class="o">.</span><span class="n">draw_histories</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">[&lt;History: é«˜å‚ ç©‚ä¹ƒæœ at 2015-10-05 15:17:32.061384+00:00&gt;]</span>
</code></pre></div>

<p>æœ€å¾Œæˆ‘å€‘ä¾†åˆªè³‡æ–™ï¼Œ</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">History</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</code></pre></div>

<p>ç•¶ç„¶ä¸€é–‹å§‹æˆ‘å€‘å¯ä»¥æš´åŠ›æŠŠ <code>db.sqlite3</code> æ•´å€‹åˆªæ‰å†é‡æ–° <code>python manage.py migrate</code> ä¸€æ¬¡å°±å¯ä»¥è®“ database å°æ‡‰çš„ table éƒ½å»ºç«‹å¥½ï¼Œä¸éåªé©ç”¨æ–¼ SQLite è€Œå·²ã€‚æˆ–è€…ï¼Œæ­£ç¢ºçš„ã€Œæ¸…ç©ºè³‡æ–™åº«ã€åšæ³•æ˜¯ç”¨ <code>flush</code> æŒ‡ä»¤ï¼Œ</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>python manage.py flush
<span class="go">You have requested a flush of the database.</span>
<span class="go">This will IRREVERSIBLY DESTROY all data currently in the &#39;draw_site/db.sqlite3&#39; database,</span>
<span class="go">and return each table to an empty state.</span>
<span class="go">Are you sure you want to do this?</span>

<span class="go">    Type &#39;yes&#39; to continue, or &#39;no&#39; to cancel: yes</span>
<span class="go">Installed 0 object(s) from 0 fixture(s)</span>
<span class="go">Installed 0 object(s) from 0 fixture(s)</span>
</code></pre></div>

<h4 id="data-in-orm-and-fixtures">Data in ORM and fixtures</h4>
<p>æˆ‘å€‘æŠŠ <code>members.csv</code> çš„è³‡æ–™å¡«åˆ°è³‡æ–™åº«å§ã€‚é€™é‚Šå°±ä¸ç”¨ç´°èªªäº†ã€‚</p>
<div class="highlight"><pre><span></span><code>In [1]: import csv
In [2]: with open(&#39;../../draw_member/members.csv&#39;, newline=&#39;&#39;) as f:
   ...:    csv_reader = csv.DictReader(f)
   ...:    members = [
   ...:    (row[&#39;åå­—&#39;], row[&#39;åœ˜é«”&#39;])
   ...:    for row in csv_reader
   ...:    ]
In [3]: from draw_member.models import Member
In [4]: for m in members:
   ...:     Member(name=m[0], group_name=m[1]).save()
   ...:
</code></pre></div>

<p>å¯ä»¥è‡ªå·±æª¢æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯ 14 å€‹äººéƒ½å¯«åˆ°è³‡æ–™åº«äº†ã€‚</p>
<p>ä¸éç¾åœ¨æœ‰å€‹å•é¡Œæ˜¯ï¼Œä¹‹å¾Œå¯èƒ½æœƒå¸¸å¸¸æŠŠè³‡æ–™åº«ç æ‰é‡ç·´ï¼Œæˆ–è€…è¦æŠŠé€™äº›ï¼ˆæˆ–å¾ˆå¤šä¾†æºï¼‰çš„è³‡æ–™è®€åˆ°è³‡æ–™åº«ï¼Œæ¯æ¬¡éƒ½é‡æ–°è®€å¯«ä¹Ÿæ˜¯å¯ä»¥ï¼Œä½†æœ‰æ²’æœ‰åˆ¥çš„åšæ³•èƒ½æŠŠè³‡æ–™å…ˆå­˜èµ·ä¾†ï¼Ÿ</p>
<p>é€™é‚Šå°±è¦ä»‹ç´¹ <a href="https://docs.djangoproject.com/en/1.8/howto/initial-data/#providing-initial-data-with-fixtures">Django fixtures</a> äº†ã€‚ä»–èƒ½æŠŠè³‡æ–™åº«çš„è³‡æ–™å­˜æˆ JSONã€YAMLï¼ˆéœ€è¦ <a href="http://pyyaml.org/">PyYAML</a>ï¼‰ç­‰æ ¼å¼ã€‚</p>
<p>ä¸€èˆ¬ fixtures æ˜¯è¢«åœ¨ <code>&lt;app&gt;/fixtures/</code> ç›®éŒ„åº•ä¸‹ï¼Œè¨˜å¾—å…ˆæŠŠç›®éŒ„å»ºå‡ºä¾†ã€‚</p>
<div class="highlight"><pre><span></span><code>mkdir draw_member/fixtures
</code></pre></div>

<p>æ ¹æ“š database çš„å…§å®¹å»ºç«‹ fixtures å¯ä»¥ä½¿ç”¨ <code>dumpdata</code> æŒ‡ä»¤ï¼š</p>
<div class="highlight"><pre><span></span><code>python manage.py dumpdata <span class="se">\</span>
    --format<span class="o">=</span>yaml <span class="se">\</span>
    --indent<span class="o">=</span><span class="m">4</span> <span class="se">\</span>
    --output draw_member/fixtures/anime_members.yaml
    draw_member.Member <span class="se">\</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># draw_member/fixtures/anime_members.yaml</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">fields</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">group_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\u03BC</span><span class="s">&#39;s&quot;</span><span class="p p-Indicator">,</span><span class="nt"> name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\u9AD8\u5742</span><span class="nv"> </span><span class="se">\u7A42\u4E43\u679C</span><span class="s">&quot;</span><span class="p p-Indicator">}</span><span class="w"></span>
<span class="w">    </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">draw_member.member</span><span class="w"></span>
<span class="w">    </span><span class="nt">pk</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">fields</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">group_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\u03BC</span><span class="s">&#39;s&quot;</span><span class="p p-Indicator">,</span><span class="nt"> name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\u7D62\u702C</span><span class="nv"> </span><span class="se">\u7D75\u91CC</span><span class="s">&quot;</span><span class="p p-Indicator">}</span><span class="w"></span>
<span class="w">    </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">draw_member.member</span><span class="w"></span>
<span class="w">    </span><span class="nt">pk</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"></span>
<span class="c1"># ...</span><span class="w"></span>
</code></pre></div>

<p>ç”¨ JSON è¼¸å‡ºä¹Ÿå¯ä»¥ï¼Œæ”¹æˆ <code>--format=json</code> å°±å¯ä»¥äº†</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;model&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;draw_member.member&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;pk&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;fields&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;\u9ad8\u5742 \u7a42\u4e43\u679c&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;group_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;\u03bc&#39;s&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
</code></pre></div>

<p>æˆ‘å€‘å¯ä»¥ç”¨ <code>python manage.py flush</code> æŠŠè³‡æ–™åº«æ¸…æ‰ï¼Œæ¨¡æ“¬è³‡æ–™çš„è®€å…¥ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>python manage.py loaddata anime_members.yaml
<span class="go">Installed 14 object(s) from 1 fixture(s)</span>
</code></pre></div>

<p>é€™æ¨£è³‡æ–™çš„å­˜å–å°±ä»‹ç´¹å¾—å·®ä¸å¤šäº†ã€‚æ›´å¤šçš„ç´°ç¯€å¯ä»¥åƒè€ƒ<a href="https://docs.djangoproject.com/en/1.8/#the-model-layer">å®˜ç¶² model layer</a> çš„èªªæ˜ã€‚</p>
<h3 id="django-template">Django Template</h3>
<p>åœ¨é€²è¡Œä¸‹å»ä¹‹å‰ï¼Œå…ˆç¢ºèªæˆ‘å€‘çš„ç›®éŒ„çµæ§‹æ˜¯ä¸€æ¨£çš„ã€‚</p>
<div class="highlight"><pre><span></span><code>demo_django_draw_member/
â””â”€â”€ draw_site/
    â”œâ”€â”€ db.sqlite3
    â”œâ”€â”€ draw_member/
    â”‚Â Â  â”œâ”€â”€ __init__.py
    â”‚Â Â  â”œâ”€â”€ admin.py
    â”‚Â Â  â”œâ”€â”€ fixtures/
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ anime_members.json
    â”‚Â Â  â”‚Â Â  â””â”€â”€ anime_members.yaml
    â”‚Â Â  â”œâ”€â”€ migrations/
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 0001_initial.py
    â”‚Â Â  â”‚Â Â  â””â”€â”€ __init__.py
    â”‚Â Â  â”œâ”€â”€ models.py
    â”‚Â Â  â”œâ”€â”€ tests.py
    â”‚Â Â  â”œâ”€â”€ urls.py
    â”‚Â Â  â””â”€â”€ views.py
    â”œâ”€â”€ draw_site/
    â”‚Â Â  â”œâ”€â”€ __init__.py
    â”‚Â Â  â”œâ”€â”€ settings.py
    â”‚Â Â  â”œâ”€â”€ urls.py
    â”‚Â Â  â””â”€â”€ wsgi.py
    â””â”€â”€ manage.py*
</code></pre></div>

<p>Django çš„ template é è¨­æ˜¯æ”¾åœ¨ <code>&lt;app&gt;/templates/</code> åº•ä¸‹ã€‚ä¸éç‚ºäº†åœ¨è·¨ app æ™‚ä¸è¦è¡åˆ°åå­—ï¼Œæˆ‘å€‘æœƒå¤šåŒ…ä¸€å±¤ app ç‚ºåçš„è³‡æ–™å¤¾ã€‚</p>
<div class="highlight"><pre><span></span><code>mkdir -p draw_member/templates/draw_member
</code></pre></div>

<p>å®ƒè·Ÿ Flask ç”¨çš„ Jinja2 templates ä¹çœ‹ä¸‹éå¸¸é¡ä¼¼ï¼ˆJinja2 æ¨¡ä»¿ Django templateï¼‰ï¼Œå…©è€…æœ€å¤§çš„å·®åˆ¥æ˜¯åœ¨ Jinja2 è£¡èƒ½å¾ˆè‡ªç”±çš„ä½¿ç”¨ Python functionï¼Œä¸é Django é çš„æ˜¯ template tag ä»¥åŠ filterã€‚æˆ‘å€‘çš„ä¾‹å­å…©è€…æ˜¯æ²’å·®å¤šå°‘ã€‚</p>
<p>ä¸€æ¨£å…ˆæŠŠ <code>base.html</code> ä»¥åŠ <code>home.html</code> åšå‡ºä¾†ã€‚æˆ‘å€‘ä¹Ÿå…ˆæŠŠ Form å¯«ä¸Šäº†ï¼Œæš«æ™‚å…ˆç”¨ GETã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c">{# draw_member/templates/draw_member/base.html #}</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span>æŠ½ç±¤ç³»çµ±<span class="cp">{%</span> <span class="k">endblock</span> <span class="nv">title</span> <span class="cp">%}</span><span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="p">&lt;</span><span class="nt">hr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>åŠŸèƒ½åˆ—<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;home&#39;</span> <span class="cp">%}</span><span class="s">&quot;</span><span class="p">&gt;</span>é¦–é ï¼ˆæŠ½ç±¤ï¼‰<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;history&#39;</span> <span class="cp">%}</span><span class="s">&quot;</span><span class="p">&gt;</span>æ­·å²è¨˜éŒ„<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c">{# draw_member/templates/draw_member/home.html #}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;draw_member/base.html&#39;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>ä¾†æŠ½å‡ºå¿«æ¨‚çš„å¤¥ä¼´å§ï¼<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>é¸æ“‡è¦è¢«æŠ½çš„åœ˜é«”<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;draw&#39;</span> <span class="cp">%}</span><span class="s">&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;get&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;group_name&quot;</span><span class="p">&gt;</span>åœ˜éšŠåç¨±ï¼š<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;radio&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;group_name&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Î¼&#39;s&quot;</span><span class="p">&gt;</span>Î¼&#39;s
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;radio&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;group_name&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;K-ON!&quot;</span><span class="p">&gt;</span>K-ON!
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;radio&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;group_name&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;ALL&quot;</span> <span class="na">checked</span><span class="p">&gt;</span>ï¼ˆå…¨ï¼‰
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Submit&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="nv">content</span> <span class="cp">%}</span>
</code></pre></div>

<p>æ•´é«”çš„æ¦‚å¿µæ‡‰è©²å¾ˆå¥½ç†è§£ã€‚<code>{% url 'xxxx' %}</code> å°±æ˜¯ URL resolverï¼Œé‚„è¨˜å¾—åœ¨ <code>urls.py</code> çš„è¨­å®šæ™‚æœ‰çµ¦å€‹ <code>name</code> åƒæ•¸å—ï¼Œé€™é‚Šå°±æœƒæ ¹æ“šé‚£å€‹åå­—å›å‚³æ­£ç¢ºçš„ç¶²å€ã€‚</p>
<p>é †ä¾¿æ›´æ–°ä¸€ä¸‹ URL æŠŠé€™äº› view å…ˆåŠ å¥½ï¼Œä¸ç„¶ç­‰ä¸‹ runserver æœƒèªªæ‰¾ä¸åˆ°é€™äº›ç¶²å€ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># draw_members/urls.py</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">home</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">history</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">home</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;home&quot;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^draw/$&#39;</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;draw&quot;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^history/$&#39;</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;history&quot;</span><span class="p">)</span>
<span class="p">]</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># draw_members/views.py</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>


<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;Hello World!&lt;/p&gt;&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;Draw&lt;/p&gt;&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;History&lt;/p&gt;&quot;</span><span class="p">)</span>
</code></pre></div>

<p>ç·Šæ¥è‘—æ”¹å¯«æˆ‘å€‘çš„é¦–é ï¼Œè®“å®ƒç”¨ä¸Š <code>home.html</code>ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;draw_member/home.html&#39;</span><span class="p">)</span>
</code></pre></div>

<figure class="align-center">
  <img src="https://blog.liang2.tw/posts/2015/10/django-draw-member/pics/django_home.png"/>
  <figcaption>åŠ ä¸Š template çš„é¦–é </figcaption>
</figure>

<p>Template æ›´å¤šçš„èªªæ˜å¯ä»¥åƒè€ƒ<a href="https://docs.djangoproject.com/en/1.8/#the-template-layer">å®˜ç¶² template layer</a> çš„èªªæ˜ã€‚</p>
<h3 id="more-on-djangos-model-template-and-view-mtv">More on Django&rsquo;s model, template and view (MTV)</h3>
<p>æˆ‘å€‘æŠŠæœ€é‡è¦çš„æŠ½ç±¤åŠŸèƒ½å¯¦ä½œå‡ºä¾†å§ã€‚</p>
<p>é€™é‚Šéœ€è¦ç†è§£çš„å°±æ˜¯ï¼ŒDjango æœƒæŠŠå‚³åˆ° GET / POST çš„åƒæ•¸ä»¥ dict å­˜åœ¨ <code>request.GET</code> / <code>request.POST</code> è£¡é¢ï¼Œ<code>@require_GET</code> é™åˆ¶åªèƒ½ä½¿ç”¨ GET å»æºé€šã€‚</p>
<p>å…¶ä»–çš„é‚è¼¯éƒ½æ˜¯ç…§æŠ„ä»¥å‰çš„ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.http</span> <span class="kn">import</span> <span class="n">require_GET</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Member</span><span class="p">,</span> <span class="n">History</span>

<span class="nd">@require_GET</span>
<span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Retrieve all related members</span>
    <span class="n">group_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group_name&#39;</span><span class="p">,</span> <span class="s1">&#39;ALL&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="s1">&#39;ALL&#39;</span><span class="p">:</span>
        <span class="n">valid_members</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">valid_members</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">group_name</span><span class="o">=</span><span class="n">group_name</span><span class="p">)</span>
    <span class="c1"># Raise 404 if no members are found given the group name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_members</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s2">&quot;No member in group &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">group_name</span><span class="p">)</span>
    <span class="c1"># Lucky draw</span>
    <span class="n">lucky_member</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_members</span><span class="p">)</span>
    <span class="c1"># Update history</span>
    <span class="n">draw_history</span> <span class="o">=</span> <span class="n">History</span><span class="p">(</span><span class="n">member</span><span class="o">=</span><span class="n">lucky_member</span><span class="p">)</span>
    <span class="n">draw_history</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
        <span class="s2">&quot;&lt;p&gt;</span><span class="si">{0.name}</span><span class="s2">ï¼ˆåœ˜é«”ï¼š</span><span class="si">{0.group_name}</span><span class="s2">ï¼‰&lt;/p&gt;&quot;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lucky_member</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>

<p>ç”¨ ORM å¯«èµ·ä¾†æ¯” raw SQL ä¹¾æ·¨å¤šäº†ï¼Œä¸éä¸€é–‹å§‹è¦æŠŠå°æ‡‰çš„ function éƒ½è¨˜èµ·ä¾†å°±æ˜¯ã€‚
é¦¬ä¸Šæ¸¬è©¦ä¸€ä¸‹ï¼Œä¸€æ¨£å·æ‡¶å…ˆä¸å»å¯« templateã€‚</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>curl -XGET <span class="s2">&quot;localhost:8000/draw/?group=ALL&quot;</span>
<span class="go">&lt;p&gt;å°æ³‰ èŠ±é™½ï¼ˆåœ˜é«”ï¼šÎ¼&#39;sï¼‰&lt;/p&gt;</span>
</code></pre></div>

<p>å¦‚æœæ˜¯å¾é¦–é å»é»çš„ï¼Œè§€å¯Ÿä¸€ä¸‹ç¶²å€çš„è®ŠåŒ–ã€‚ä¾‹å¦‚ï¼š<code>http://localhost:8000/draw/?group_name=K-ON!</code>ï¼Œå¯ä»¥çœ‹åˆ° form çš„é¸é …ç›´æ¥å¯«åœ¨ç¶²å€åˆ—ã€‚é€™æ˜¯ä½¿ç”¨ POST èˆ‡ GET æœ€å¤§çš„ä¸åŒã€‚</p>
<p>å†ä¾†æŠŠæ­·å²è¨˜éŒ„çš„éƒ¨ä»½ä¹Ÿå¯«ä¸€ä¸‹ï¼Œä¹ŸæŠŠ template éƒ½è£œä¸Šã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c">{# draw_member/templates/history.html #}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;draw_member/base.html&#39;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span>æŠ½ç±¤æ­·å²<span class="cp">{%</span> <span class="k">endblock</span> <span class="nv">title</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>æŠ½ç±¤æ­·å²ï¼ˆæœ€è¿‘ 10 ç­†ï¼‰<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">table</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>åå­—<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>åœ˜é«”<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>æŠ½ä¸­æ™‚é–“<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">for</span> <span class="nv">history</span> <span class="k">in</span> <span class="nv">recent_histories</span> <span class="cp">%}</span>
      <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">history.member.name</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">history.member.group_name</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">history.time</span><span class="o">|</span><span class="nf">date</span><span class="s2">:&quot;r&quot;</span><span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
    <span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="nv">content</span> <span class="cp">%}</span>
</code></pre></div>

<p>history.html èˆ‡æœ¬ä¾† Flask ä¸ä¸€æ¨£çš„åœ°æ–¹ï¼Œåœ¨ç”¨ä¸Šäº† <code>date:"r"</code> çš„ filterï¼Œå‚³çš„åƒæ•¸æ¥åœ¨ <code>:</code> ä¹‹å¾Œã€‚ä¹Ÿæ›´æ–°å°æ‡‰ view çš„å‹•ä½œï¼Œ</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">recent_draws</span> <span class="o">=</span> <span class="n">History</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;draw_member/history.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;recent_histories&#39;</span><span class="p">:</span> <span class="n">recent_draws</span><span class="p">,</span>
    <span class="p">})</span>
</code></pre></div>

<figure class="align-center">
  <img src="https://blog.liang2.tw/posts/2015/10/django-draw-member/pics/django_history.png"/>
</figure>

<p>å¯ä»¥çœ‹åˆ°é è¨­ç”¨çš„æ˜¯ UTC æ™‚å€ï¼Œæ™‚å€çš„è½‰æ›ç´°ç¯€æ”¾åˆ°æ–‡æœ«å§ã€‚æˆ‘å€‘å¯ä»¥åœ¨ view è£¡æ›´æ”¹è¦å‘ˆç¾çš„æ™‚å€ï¼Œ</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.utils.timezone</span> <span class="kn">import</span> <span class="n">activate</span>

<span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">activate</span><span class="p">(</span><span class="s1">&#39;Asia/Taipei&#39;</span><span class="p">)</span>
    <span class="c1"># ...</span>
</code></pre></div>

<figure class="align-center">
  <img src="https://blog.liang2.tw/posts/2015/10/django-draw-member/pics/django_history_tz.png"/>
</figure>

<p>é€™æ¨£åŸºæœ¬åŠŸèƒ½å°±æå®šå•¦ï¼ç´°ç¯€ä¸€æ¨£åƒè€ƒ<a href="https://docs.djangoproject.com/en/1.8/#the-view-layer">å®˜ç¶² view layer</a> çš„èªªæ˜ã€‚</p>
<h3 id="django-form">Django Form</h3>
<p>ç›´æ¥æŠŠ form å¯«åœ¨ template è£¡é¢ä¹Ÿæ˜¯å¯ä»¥ï¼Œæœ‰æ™‚å€™ form å¯èƒ½è·Ÿ model æ¯æ¯ç›¸é—œï¼Œè€Œä¸” form input å¤šäº†ä¹‹å¾Œæ¯å€‹æ¬„ä½éƒ½è¦è‡ªå·±è®€å¯«ä¹Ÿå¤ªä¸ç›´è¦ºã€‚æƒ³è¦é©—è¨¼ä½¿ç”¨è€…çš„ input çš„è©±å°±æ›´è¤‡é›œäº†ã€‚</p>
<p>æ–¼æ˜¯å°±æœ‰äº† Django Formã€‚é¦¬ä¸Šä¾†çœ‹ç”¨èµ·ä¾†æ˜¯æ€éº¼æ¨£ã€‚</p>
<div class="highlight"><pre><span></span><code># draw_member/forms.py
from django import forms

class DrawForm(forms.Form):
    GROUP_CHOICES = [
        (&quot;Î¼&#39;s&quot;, &quot;Î¼&#39;s&quot;),
        (&quot;K-ON!&quot;, &quot;K-ON!&quot;),
        (&quot;ALL&quot;, &quot;ï¼ˆå…¨ï¼‰&quot;),
    ]
    group = forms.ChoiceField(
        choices=GROUP_CHOICES,
        label=&#39;åœ˜éšŠåç¨±&#39;,
        label_suffix=&#39;ï¼š&#39;,
        widget=forms.RadioSelect,
        initial=&#39;ALL&#39;
    )
</code></pre></div>

<p>å»ºäº†ä¸€å€‹æ–°çš„ form classï¼Œåƒ Model ä¸€æ¨£ï¼Œè£¡é¢è¦å®šäº†æ¯å€‹æ¬„ä½çš„å±¬æ€§ã€‚æˆ‘å€‘é€™é‚Šåªæœ‰ä¸€å€‹ <code>group</code> æ˜¯å€‹å–®é¸çš„ ChoiceFieldï¼Œ<code>choices</code> æ˜¯å€‹ list of two-item tuplesï¼Œç¬¬ä¸€å€‹æ˜¯å…§éƒ¨çš„å€¼ï¼Œç¬¬äºŒå€‹æ˜¯é¡¯ç¤ºçš„å­—ã€‚å…¶ä»–çš„éƒ½æ˜¯ç´°ç¯€çš„èª¿æ•´ã€‚</p>
<p>æŠŠé€™å€‹ form ç”¨åˆ° view è£¡é¢ã€‚æ–°å»ºä¸€å€‹ form object <code>form</code>ï¼Œç„¶å¾ŒæŠŠé€™å€‹è®Šæ•¸ <code>form</code> å‚³é€² template è£¡é¢ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">DrawForm</span>

<span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">DrawForm</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;draw_member/home.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
    <span class="p">})</span>
</code></pre></div>

<p>å†ä¾†ä¿®æ”¹ templateï¼Œå°±ä¸ç”¨è‡ªå·±å¯« form çš„å…§å®¹äº†ï¼Œæ”¹æˆ <code>{{ form }}</code> Django å°±æœƒè‡ªå‹•ç”¢ç”Ÿã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c">{# draw_member/home.html #}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;draw_member/base.html&#39;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>ä¾†æŠ½å‡ºå¿«æ¨‚çš„å¤¥ä¼´å§ï¼<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>é¸æ“‡è¦è¢«æŠ½çš„åœ˜é«”<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;draw&#39;</span> <span class="cp">%}</span><span class="s">&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;get&quot;</span><span class="p">&gt;</span>
    <span class="cp">{{</span> <span class="nv">form</span> <span class="cp">}}</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Submit&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="nv">content</span> <span class="cp">%}</span>
</code></pre></div>

<figure class="align-center">
  <img src="https://blog.liang2.tw/posts/2015/10/django-draw-member/pics/django_form.png"/>
</figure>

<p>ä¸éé€™å€‹é•·å¾—è·Ÿæˆ‘å€‘åŸæœ¬çš„ form ä¸ä¸€æ¨£å˜›ã€‚å¥½åœ¨ Django form æ˜¯å¾ˆå½ˆæ€§çš„ï¼Œform åœ¨è¢« render æˆ HTML æ™‚å¯ä»¥æä¾›ç´°ç¯€çš„èª¿æ•´ï¼Œå¤§å®¶å¯ä»¥åƒè€ƒ<a href="https://docs.djangoproject.com/en/1.8/topics/forms/#form-rendering-options">å®˜ç¶² Form rendering options</a> èª¿æ•´ã€‚æˆ‘ç›´æ¥çµ¦èª¿å¥½çš„çµæœå§ã€‚</p>
<div class="highlight"><pre><span></span><code>  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;draw&#39;</span> <span class="cp">%}</span><span class="s">&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;get&quot;</span><span class="p">&gt;</span>
    <span class="cp">{{</span> <span class="nv">form.group.label_tag</span> <span class="cp">}}</span>
    <span class="cp">{%</span> <span class="k">for</span> <span class="nv">radio</span> <span class="k">in</span> <span class="nv">form.group</span> <span class="cp">%}</span>
      <span class="cp">{{</span> <span class="nv">radio.tag</span> <span class="cp">}}{{</span> <span class="nv">radio.choice_label</span> <span class="cp">}}</span>
    <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Submit&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>

<p>ç”¨çµæœå»å°ç…§æ¯å€‹ <code>{{ ... }}</code> éƒ¨ä»¶å°æ‡‰çš„ HTML å…ƒç´ å§ã€‚</p>
<h4 id="more-django-form-in-view">More Django form in view</h4>
<p>Form çš„åŠŸèƒ½å¯ä¸åªé€™æ¨£ï¼Œå¯ä»¥åœ¨å‰µå»º DrawForm æ™‚ç›´æ¥æŠŠ <code>request.GET</code> å‚³å…¥ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># draw_member/views.py</span>
<span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Retrieve all related members</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">DrawForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="s1">&#39;ALL&#39;</span><span class="p">:</span>
            <span class="n">valid_members</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">valid_members</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">group_name</span><span class="o">=</span><span class="n">group_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Raise 404 if no members are found given the group name</span>
        <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s2">&quot;No member in group &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span>
                      <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="c1"># Lucky draw</span>
    <span class="n">lucky_member</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_members</span><span class="p">)</span>
    <span class="c1"># ...</span>
</code></pre></div>

<p>ç”¨ <code>form.is_valid()</code> å¯ä»¥é©—è¨¼æ¯å€‹æ¬„ä½çš„è³‡æ–™æ˜¯ä¸æ˜¯æ­£ç¢ºçš„ã€‚</p>
<p>æˆ‘å€‘ä¹Ÿé †ä¾¿æŠŠ /draw åŠ ä¸Š template å§ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c">{# draw_member/draw.html #}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;draw_member/base.html&#39;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span>æŠ½ç±¤çµæœ<span class="cp">{%</span> <span class="k">endblock</span> <span class="nv">title</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>æŠ½ç±¤çµæœ<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">lucky_member.name</span> <span class="cp">}}</span>ï¼ˆåœ˜é«”ï¼š<span class="cp">{{</span> <span class="nv">lucky_member.group_name</span> <span class="cp">}}</span>ï¼‰<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="nv">content</span> <span class="cp">%}</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># draw_member/views.py</span>
<span class="k">def</span> <span class="nf">draw</span><span class="p">():</span>
    <span class="c1"># ...</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;draw_member/draw.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;lucky_member&#39;</span><span class="p">:</span> <span class="n">lucky_member</span>
    <span class="p">})</span>
</code></pre></div>

<p>æ›´å¤š Forms çš„ä»‹ç´¹ä¸€æ¨£åƒè€ƒ<a href="https://docs.djangoproject.com/en/1.8/#forms">å®˜ç¶²</a>ã€‚</p>
<h3 id="_2">ç¸½çµ</h3>
<p>åšå®Œçš„æˆå“åœ¨ <a href="https://github.com/ccwang002/draw_member_django">Github</a> ä¸Šï¼Œåƒè€ƒ README å°±å¯ä»¥è¨­å®šå¥½ç’°å¢ƒäº†ã€‚</p>
<p>é€™æ¨£å°±æŠŠ Django æœ€åŸºæœ¬çš„ Model, View, Template, Form å¹¾å€‹å¤§éƒ¨ä»½é«”é©—ä¸€éäº†ã€‚å¯ä»¥æ„Ÿè¦ºå‡ºä¾† Django æä¾›çš„åŠŸèƒ½æ¯” Flask å¤šå¾ˆå¤šï¼Œä½†ä¹Ÿä»£è¡¨è¦èŠ±æ›´å¤šçš„æ™‚å€™å­¸ç¿’ä½¿ç”¨å®ƒã€‚å…¶å¯¦æ”¹å¯«åˆ°æœ€å¾Œæˆ‘å€‘çš„ code éå¸¸å°‘ï¼Œå¯ä»¥ç‚ºäº†çµæ§‹åŒ–çš„ code é‚„æ¯”è¼ƒå¤šã€‚</p>
<p>ç•¶ç„¶é€™ä¸ä»£è¡¨å°±å­¸æœƒ Django äº†ã€‚æœ€å¾Œä¾†ä»‹ç´¹å¹¾å€‹å¯ä»¥æ¥çºŒå­¸ç¿’çš„ Django è³‡æºï¼š</p>
<ul>
<li><a href="https://github.com/uranusjr/django-tutorial-for-programmers">ã€Šç‚ºç¨‹å¼äººå¯«çš„ Django Tutorial ã€‹</a>æ˜¯å€‹çœŸæ­£å¾é›¶åˆ°ä¸€çš„ 30 å¤©å­¸ç¿’è¦åŠƒï¼ˆé›–ç„¶æˆ‘å­¸äº†å¥½å¹¾å€‹æœˆ T___Tï¼‰ï¼Œæœ‰äº†é€™å€‹æŠ½ç±¤ç¨‹å¼çš„æ¦‚å¿µå†å»è®€ä¸€æ¬¡æ‡‰è©²æœƒæ›´æ¸…æ¥šæ•´å€‹ Django çš„è¨­è¨ˆã€‚ä½œè€…ï¼šTzu-ping Chung (@uranusjr)</li>
<li><a href="http://masteringdjango.com"><em>Mastering Django: Core</em></a>, the successor to <a href="http://www.djangobook.com/en/2.0/index.html"><em>The Django Book</em></a> last updated in 2009, is the definitive guide to Django targeting the latest Django version 1.8 at the time of writing.</li>
</ul>
<p>æ›´å¤šçš„ Django æŠ€èƒ½æ¨¹é¸æ“‡è«‹è¦‹ TP çš„ <a href="https://github.com/uranusjr/django-tutorial-for-programmers/blob/master/30-moving-on.md">lesson 30</a>ã€‚</p>
<h3 id="details">Details</h3>
<p>è·Ÿ Flask ä¸€æ¨£ï¼Œåº•ä¸‹è¨˜éŒ„ä¸€äº›ç´°ç¯€æˆ–æ”¹å–„ç­‰ç­‰ç‚ºäº†é¿å…ç¯‡å¹…éé•·ï¼ˆå·²ç¶“å¤ªé•·äº†ï¼‰è€Œç§»è‡³æ­¤çš„æ®µè½ã€‚</p>
<h4 id="raw-sql">Raw SQL</h4>
<p>åœ¨ä»‹ç´¹ Django Model çš„æ™‚å€™ç›´æ¥ç”¨äº† ORMï¼Œä½†å¯¦éš›ä¸Š Django æ˜¯å¯ä»¥å¯« raw SQL äº†ï¼Œè€Œä¸”é‚„æœ‰ã€Œè°æ˜ç‰ˆã€çš„ raw SQL èƒ½å¤ æ‹¿å›å°æ‡‰çš„ model objectã€‚é¦¬ä¸Šä¾†çœ‹æ€éº¼å›äº‹ã€‚</p>
<p>å…ˆä¾†çœ‹è°æ˜ç‰ˆçš„ raw SQLï¼Œä½¿ç”¨ <code>Model.objects.raw</code> æ‹¿å›æ‰€æœ‰åœ˜é«”æ˜¯ K-ON é¡çš„æˆå“¡ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s2">SELECT id, name, group_name</span>
<span class="gp">... </span><span class="s2">FROM draw_member_member</span>
<span class="gp">... </span><span class="s2">WHERE group_name LIKE &#39;K-ON</span><span class="si">%%</span><span class="s2">&#39;</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span><span class="p">))</span>
<span class="go">[&lt;Member: å¹³æ²¢ å”¯ of K-ON!&gt;,</span>
<span class="go"> &lt;Member: ç§‹å±± æ¾ª of K-ON!&gt;,</span>
<span class="go"> &lt;Member: ç”°äº•ä¸­ å¾‹ of K-ON!&gt;,</span>
<span class="go"> &lt;Member: ç´å¹ ç´¬ of K-ON!&gt;,</span>
<span class="go"> &lt;Member: ä¸­é‡ æ¢“ of K-ON!&gt;]</span>
</code></pre></div>

<p>æœƒå›å‚³ä¸€å€‹ RawQuerySetï¼Œè£¡é¢å…¶å¯¦ä¹Ÿæ˜¯ Member objectsï¼Œé€™æ˜¯é  Django å»èªå°æ‡‰çš„ primary keyï¼Œä¹Ÿå°±æ˜¯èªªåœ¨ raw() SQL query è£¡ä¸€å®šè¦æ”¾ primary keyã€‚æ³¨æ„é‚£å€‹ <code>%</code> éœ€è¦è¢« escape å› ç‚º raw() çš„ SQL query æ˜¯èƒ½æ”¾åƒæ•¸çš„ï¼ˆå°±åƒ Python å…§å»º str %-formattingï¼‰ã€‚</p>
<p>ä¸éæˆ‘å€‘æ€éº¼çŸ¥é“ Member æ˜¯å­˜åœ¨å“ªå€‹ table å‘¢ï¼Ÿé è¨­æ˜¯ <code>&lt;app&gt;_&lt;model&gt;</code>ï¼Œä½†è³‡è¨Šåœ¨ meta options è£¡çš„ <code>db_table</code>ï¼Œä¹Ÿèƒ½è¢«è¦†å¯«ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">Member</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span>
<span class="go">&#39;draw_member_member&#39;</span>
</code></pre></div>

<p>å› ç‚º Member è£¡é¢æœ‰åƒ nameã€group_name ç­‰æ¬„ä½ï¼Œåœ¨ä¸‹ query çš„æ™‚å€™ä¸ä¸€å®šéƒ½æœƒå¯«åœ¨ SELECT è£¡é¢æŠŠæ‹¿å€¼å›ä¾†ï¼Œé‚£éº¼é€™äº›æ¬„ä½å°±æ˜¯ deferred ç‹€æ…‹ï¼Œåªæœ‰åœ¨çœŸçš„æ‹¿å€¼æ™‚æ‰æœƒå»è·Ÿ database è¦ã€‚ä¸€èˆ¬ä½¿ç”¨ä¸æœƒæœ‰æ„Ÿè¦ºå…©è€…çš„å·®ç•°ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;SELECT id FROM draw_member_member&quot;</span>
<span class="gp">... </span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="go">draw_member.models.Member_Deferred_group_name_name</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">get_deferred_fields</span><span class="p">()</span>
<span class="go">{&#39;group_name&#39;, &#39;name&#39;}</span>
</code></pre></div>

<p>ä½†æˆ‘å°±æ˜¯ä¸æƒ³ç”¨ ORMï¼Œé€Ÿåº¦æ…¢ï¼Œä¹Ÿæ²’è¾¦æ³•å¯«è¤‡é›œçš„ queryï¼ˆæˆ°ï¼‰ã€‚é€™å°±å›æ­¸åˆ°æœ€å‚³çµ±çš„ database connection, cursor é€™äº›æ¦‚å¿µï¼Œå°±åƒæ²’æœ‰ SQLAlchemy çš„ Flaskã€‚</p>
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s2">SELECT name</span>
<span class="gp">... </span><span class="s2">FROM draw_member_member</span>
<span class="gp">... </span><span class="s2">WHERE group_name LIKE </span><span class="si">%s</span><span class="s2"></span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;K-ON&quot;</span><span class="p">]))</span>
<span class="go">[(&#39;å¹³æ²¢ å”¯&#39;,), (&#39;ç§‹å±± æ¾ª&#39;,), (&#39;ç”°äº•ä¸­ å¾‹&#39;,), (&#39;ç´å¹ ç´¬&#39;,), (&#39;ä¸­é‡ æ¢“&#39;,)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s2">SELECT member_id, time</span>
<span class="gp">... </span><span class="s2">FROM draw_member_history</span>
<span class="gp">... </span><span class="s2">LIMIT 3</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span><span class="p">))</span>
<span class="go">[(8, datetime.datetime(2015, 10, 5, 17, 36, 41, 608078, tzinfo=&lt;UTC&gt;)),</span>
<span class="go"> (11, datetime.datetime(2015, 10, 5, 17, 37, 26, 164830, tzinfo=&lt;UTC&gt;)),</span>
<span class="go"> (11, datetime.datetime(2015, 10, 5, 17, 37, 37, 483697, tzinfo=&lt;UTC&gt;))]</span>
</code></pre></div>

<p>Here you go.</p>
<h4 id="better-queryset">Better QuerySet</h4>
<p>çœ‹éäº† raw SQL ä¹‹å¾Œï¼Œæˆ‘å€‘ä¾†æƒ³æƒ³ ORM çš„æ”¹å–„å§ã€‚é›–ç„¶èªªæ¯æ¬¡è¦æŸ¥è©¢çš„æ™‚å€™åƒå¯« SQL ä¸€æ¨£æŠŠ query çµ„åˆå‡ºä¾†ä¹Ÿå¯ä»¥ï¼Œä½†ç”¨ ORM çš„å¥½è™•æ‡‰è©²æ˜¯èƒ½æŠŠé€™äº›å¯¦ä½œç´°ç¯€è·Ÿã€ŒåŒ…è£èµ·ä¾†ã€ã€‚ä¾‹å¦‚æœ€è¿‘ n æ¬¡æŠ½ç±¤è¨˜éŒ„ã€æ‰€æœ‰æˆå“¡çš„åœ˜é«”åç¨±ï¼ˆç›®å‰æ˜¯å¯«æ­»åœ¨ DrawForm è£¡é¢ï¼‰ã€‚</p>
<p>é€™æ™‚å€™å°±å¯ä»¥æŠŠå¸¸ç”¨çš„ query è®Šæˆä¸€å€‹ methodï¼Œä¾‹å¦‚æœ€è¿‘ 10 æ¬¡æŠ½ç±¤è¨˜éŒ„å°±åªè¦ç”¨ <code>History.objects.recent(10)</code> å°±å¯ä»¥äº†ã€‚</p>
<p>é€™å…¶å¯¦æœ‰å¾ˆå¤šåšæ³•ï¼Œåƒæ˜¯å¯«ä¸€å€‹ classmethodã€Override default Managerã€Override default QuerySetã€‚å“ªå€‹æ–¹æ³•æ¯”è¼ƒå¥½å‘¢ï¼Ÿåœ¨ <a href="http://stackoverflow.com/a/2213341">StackOverflow</a>ã€<a href="https://groups.google.com/forum/#!topic/django-users/0WSdnWFTuUg">mail list</a> éƒ½æœ‰è¨è«–ã€‚åŸºæœ¬ä¸Šéƒ½èƒ½é”åˆ°ç›¸åŒçš„æ•ˆæœï¼Œä½†å¾Œå…©è€…çš„åšæ³•æ˜¯æ¯”è¼ƒåå¥½çš„ï¼Œå› ç‚º Manager(or QuerySet for Django 1.7+) è² è²¬è™•ç† model å°æ‡‰åˆ°çš„ database table ç­‰ç´šçš„æ“ä½œï¼Œä½† classmethod æ‡‰è©²æ˜¯è™•ç†å·²ç¶“å¾ table row ä¸­æ‹¿å‡ºçš„ä¸€å€‹ model object ç›¸é—œçš„æ“ä½œã€‚å¦‚æœæŠŠåŒæ¨£æ€§è³ªçš„ code æ”¾åœ¨ä¸€èµ·ï¼Œå°±æ‡‰è©²ä½¿ç”¨ Manager(QuerySet)ã€‚</p>
<p>è€Œä¸” TP ä¹Ÿåœ¨ Gitter ä¸Šé–‹ç¤ºäº†ï¼Œå°±æ˜¯é€™æ¨£ï¼ˆçµæ¡ˆï¼‰ã€‚ä¾†æ”¹å¯« modelã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># draw_member/models.py</span>
<span class="k">class</span> <span class="nc">MemberQuerySet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">QuerySet</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">unique_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;group_name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">HistoryQuerySet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">QuerySet</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">recent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-time&#39;</span><span class="p">)[:</span><span class="n">n</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Member</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">MemberQuerySet</span><span class="o">.</span><span class="n">as_manager</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">History</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">HistoryQuerySet</span><span class="o">.</span><span class="n">as_manager</span><span class="p">()</span>
</code></pre></div>

<p>åœ¨ Member æˆ‘å€‘å®šç¾©äº†ä¸€å€‹ <code>unique_groups</code> æ‹¿å›æ‰€æœ‰åœ˜é«”çš„åç¨±ï¼›åœ¨ History å®šç¾©äº† <code>recent</code> æ‹¿å‡ºæŒ‰æ™‚é–“æ’åºæœ€å‰é¢ n å€‹ã€‚æ–°å®šç¾©çš„ <code>QuerySet.as_manager()</code> å°±å–ä»£æ‰æœ¬ä¾†çš„ <code>Model.objects</code>ã€‚</p>
<p>æ¥è‘—ä¾†æ”¹å¯« view æŠŠä¹‹å‰å¯«çš„ query æ›æ‰ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1">#draw_member/views.py</span>
<span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">recent_draws</span> <span class="o">=</span> <span class="n">History</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">recent</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="c1"># ...</span>
</code></pre></div>

<p>é€™æ¨£å°±ç°¡æ½”ä¸€é»ã€‚å†ä¾†é †ä¾¿æŠŠ form æ”¹å¾—æ¯”è¼ƒå½ˆæ€§ï¼Œä¸è¦æŠŠåœ˜é«”åå¯«æ­»ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1">#draw_member/forms.py</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Member</span>


<span class="k">def</span> <span class="nf">member_group_choices</span><span class="p">():</span>
    <span class="n">valid_groups</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>
    <span class="n">choices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">valid_groups</span><span class="p">:</span>
        <span class="n">choices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">grp</span><span class="p">,</span> <span class="n">grp</span><span class="p">))</span>
    <span class="n">choices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;ï¼ˆå…¨ï¼‰&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">choices</span>


<span class="k">class</span> <span class="nc">DrawForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">ChoiceField</span><span class="p">(</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">member_group_choices</span><span class="p">,</span>
        <span class="c1"># ...</span>
    <span class="p">)</span>
</code></pre></div>

<h4 id="timezone">Timezone</h4>
<p>æ„Ÿè¦ºæœ€è¿‘ä¸€ç›´åœ¨å¯«<a href="../../09/datetime-sqlite/">æ™‚å€ç›¸é—œçš„æ±è¥¿</a>å•Šã€‚åŸºæœ¬ä¸Š server è¨˜éŒ„çš„æ™‚é–“éƒ½ç”¨ UTC å•é¡Œå°±å°‘å¾ˆå¤šï¼Œä½†æœ€å¾Œé‚„æ˜¯è¦å‘ˆç¾ä¸€å€‹ä½¿ç”¨è€…ç”¨çš„æ™‚å€ã€‚</p>
<p>ä½†å•é¡Œæ˜¯ HTTP header è£¡é¢ä¸¦æ²’æœ‰é€™æ¨£çš„è³‡è¨Šï¼Œæ‰€ä»¥ä¸€ä¾†ç”¨ geoip å»çŒœï¼ŒäºŒä¾†ç”¨å¯«å€‹ javascript åœ¨ä½¿ç”¨è€…è¼‰å…¥çš„æ™‚å€™å»åˆ¤æ–·æ™‚å€ï¼Œç¸½ä¹‹æ˜¯å€‹è¦å¦å¤–è¨˜éŒ„çš„æ±è¥¿ã€‚ç´°ç¯€<a href="https://docs.djangoproject.com/en/1.8/topics/i18n/timezones/#selecting-the-current-time-zone">å®˜ç¶²ä¸Šä¹Ÿæœ‰èªªæ˜</a>ã€‚</p>
<p>åœ¨æ–‡ä¸­æ˜¯ä½¿ç”¨ <code>activate('Aisa/Taipei')</code> æŠŠæ™‚å€æ”¹æˆ UTC+8ã€‚é€™é‚Šä»‹ç´¹å¦ä¸€å€‹æ–¹å¼ï¼Œæ˜¯å¯«åœ¨ template è£¡é¢çš„ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c">{# draw_member/templates/draw_member/history.html #}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
  <span class="cp">{%</span> <span class="k">load</span> <span class="nv">tz</span> <span class="cp">%}</span>
  <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>æŠ½ç±¤æ­·å²ï¼ˆæœ€è¿‘ 10 ç­†ï¼‰<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">table</span><span class="p">&gt;</span>
  <span class="c">{# ... #}</span>
    <span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">timezone</span> <span class="s1">&#39;Asia/Taipei&#39;</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">for</span> <span class="nv">history</span> <span class="k">in</span> <span class="nv">recent_histories</span> <span class="cp">%}</span>
      <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span><span class="c">{# ... #}</span><span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">endtimezone</span> <span class="cp">%}</span>
    <span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="nv">content</span> <span class="cp">%}</span>
</code></pre></div>

<h4 id="post-form-and-csrf">POST form and CSRF</h4>
<p>å¿˜è¨˜è¬›äº†ï¼Œæˆ‘å€‘çš„ form ç›®å‰æ˜¯ç”¨ <code>action="get"</code>ï¼Œç•¶ç„¶å¯ä»¥æ”¹å›ç”¨ POSTï¼Œä¹Ÿå¾ˆç°¡å–®ï¼Œå°± GET æ›æˆ POST å°±å¥½äº†ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c1"># draw_site/views.py</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.http</span> <span class="kn">import</span> <span class="n">require_POST</span>

<span class="nd">@require_POST</span>
<span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># Retrieve all related members</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">DrawForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
    <span class="c1"># ...</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c">{# draw_site/templates/home.html #}</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;draw&#39;</span> <span class="cp">%}</span><span class="s">&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
</code></pre></div>

<p>é¦¬ä¸Šä¾†è©¦è©¦çœ‹ã€‚</p>
<figure class="align-center">
  <img src="https://blog.liang2.tw/posts/2015/10/django-draw-member/pics/django_csrf_failed.png"/>
  <figcaption>POST form without CSRF token</figcaption>
</figure>

<p>æ‹¿åˆ°äº†ä¸€å€‹ 403 Forbidden &ldquo;CSRF verification failed.&rdquo;ã€‚CSRF (Cross Site Request Forgery) åœ¨ <a href="https://zh.wikipedia.org/wiki/%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0">wiki</a> æœ‰æ¯”è¼ƒå®Œæ•´çš„ä»‹ç´¹ï¼Œé€™æ˜¯ä¸€ç¨®æ”»æ“Šæ‰‹æ³•ï¼Œåœ¨ä½¿ç”¨è€…ç™»å…¥ç¶²ç«™ä¹‹å¾Œï¼ˆsession ç‚ºç™»å…¥ç‹€æ…‹ï¼‰ï¼Œå½é€ ä¸€å€‹è·Ÿç¶²ç«™ä¸Šä¸€æ¨£çš„ form ä¾†å½è£ä½¿ç”¨è€…çš„è¡Œç‚ºã€‚ä¾‹å¦‚è³¼ç¥¨ç³»çµ±è²·ç¥¨ï¼Œå¦‚æœæ²’æª¢æŸ¥çš„è©±ï¼Œæˆ‘å¯ä»¥æ‹¿ä½¿ç”¨è€…çš„ session å»ç¶²ç«™ä¸Šéš¨ä¾¿è²·ç¥¨ï¼Œç¶²ç«™éƒ½æœƒèªç‚ºæ˜¯ä½¿ç”¨è€…åœ¨æ“ä½œã€‚</p>
<p>å› æ­¤ <a href="https://docs.djangoproject.com/en/1.8/ref/csrf/">CSRF token</a> ç”¨ä¾†é˜²ç¯„é€™å€‹å½é€ ï¼Œåœ¨ç”¢ç”Ÿ form çš„æ™‚å€™ï¼Œç¶²ç«™æœƒå†ç”¢ç”Ÿä¸€å€‹æ¬„ä½çš„å€¼ï¼Œé€™å€‹æ¬„ä½çš„å€¼æ¯æ¬¡éƒ½æœƒæ”¹è®Šï¼Œé€™æ¨£å°±èƒ½ç¢ºå®šé€™å€‹ form æ˜¯å¾ç¶²ç«™ä¸Šæ‹¿åˆ°çš„ã€‚Django è™•ç† CSRF protection æ˜¯é€é <a href="https://docs.djangoproject.com/en/1.8/topics/http/middleware/">Middleware</a>ï¼Œä¸€å€‹ä»¥å‰æ²’æœ‰æåˆ°çš„æ¦‚å¿µï¼Œè¡¨ç¤ºä»–æ˜¯æ¯”è¼ƒåº•å±¤çš„æ±è¥¿ã€‚ç›¸å°è€Œè¨€ï¼Œä¹Ÿä¸ç”¨æ”¹æˆ‘å€‘çš„ codeï¼Œåœ¨é€™å€‹ä¾‹å­å°±åªè¦æŠŠ <code>{% csrf_token %}</code> åŠ åˆ° form è£¡é¢å°±å¯ä»¥äº†ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="c">{# draw_site/templates/home.html #}</span>
  <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;draw&#39;</span> <span class="cp">%}</span><span class="s">&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
    <span class="c">{# ... #}</span>
    <span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Submit&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div></section>
    <footer class="post-footer">
	<section
		class="utterances"
		data-repo="ccwang002/ccwang002.github.io"
		data-issue-term="pathname"
		data-label="Comment">
	</section>
	</footer>
</article>
	</main>
	<footer class="site-footer">
		<button class="subscribe"
			href="https://blog.liang2.tw/feeds/all.atom.xml"
			aria-label="Subscribe the Atom feed"
			data-tooltip="Subscribe"
		>
			<svg viewBox="0 0 24 24" width="24" height="24">
				<title>Atom feed</title>
				<circle cx="6.18" cy="17.82" r="2.18"/>
				<path d="m4 10.1v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9zm0-5.66v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56z"/>
			</svg>
		</button>
		<div class="inner">
			<section>
				Browse articles by
				<a href="https://blog.liang2.tw/tags.html">Tags</a> |
				<a href="https://blog.liang2.tw/categories.html">Categories</a>
			</section>
			<section class="contact">
				Contact me by
				<a href="https://twitter.com/lbwang2">Twitter</a> |
				<a href="https://www.facebook.com/lbwang.2">Facebook</a> |
				<a href="https://github.com/ccwang002">GitHub</a> |
				<a href="mailto:me+blog@liang2.tw">Email</a> |
				<a href="https://www.linkedin.com/in/liangbowang/">LinkedIn</a>
			</section>
			<section class="copyright">
				This work is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
			</section>
			<section class="powered-by">
				Built using <a href="https://getpelican.com/">Pelican</a>.
				Powered by the <a href="https://github.com/kura/hauntr">Hauntr</a> theme.
			</section>
		</div>
	</footer>
	<script src="https://blog.liang2.tw/theme/scripts/color_scheme.js"></script>
</body>
</html>