<!DOCTYPE html>
<html lang="zh-Hant">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">
<meta name="author" content="Liang-Bo Wang" />
<meta name="description" content="為了實驗室的專題生而寫。 目標其實是 Django + Django ORM + PostgreSQL，不過一次接觸太多會有反效果，先操作比較簡單的才好上手。所以這邊講 …" />
<meta name="keywords" content="zh, flask, sqlite, jinja2, python">
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.95em%22 font-size=%2295%22>📖</text></svg>">
	<title>用 Flask 與 SQLite 架抽籤網站</title>

	<!-- og -->
<meta property="og:locale" content="zh_TW"/>
<meta property="og:site_name" content="Liang-Bo Wang's Blog"/>
<meta property="og:title" content="用 Flask 與 SQLite 架抽籤網站"/>
<meta property="og:description" content="為了實驗室的專題生而寫。 目標其實是 Django + Django ORM + PostgreSQL，不過一次接觸太多會有反效果，先操作比較簡單的才好上手。所以這邊講 …"/>
<meta property="og:locale" content=""/>
<meta property="og:url" content="https://blog.liang2.tw/posts/2015/09/flask-draw-member/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2015-09-28 12:00:00-05:00"/>
<meta property="article:modified_time" content="2022-05-13 13:06:34.417289-05:00"/>
<meta property="article:author" content="https://blog.liang2.tw/author/liang-bo-wang.html">
<meta property="article:section" content="Coding"/>
<meta property="article:tag" content="zh"/>
<meta property="article:tag" content="flask"/>
<meta property="article:tag" content="sqlite"/>
<meta property="article:tag" content="jinja2"/>
<meta property="article:tag" content="python"/>
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ccwang002">
<meta name="twitter:title" content="用 Flask 與 SQLite 架抽籤網站">
<meta name="twitter:description" content="為了實驗室的專題生而寫。 目標其實是 Django + Django ORM + PostgreSQL，不過一次接觸太多會有反效果，先操作比較簡單的才好上手。所以這邊講 …">

	<!-- Feeds -->
	<link href="https://blog.liang2.tw/feeds/all.atom.xml"
		type="application/atom+xml" rel="alternate" title="Liang-Bo Wang's Blog" />

	<link rel="stylesheet" type="text/css" href="https://blog.liang2.tw/theme/styles/styles.css" />
	<link rel="stylesheet" type="text/css" href="https://blog.liang2.tw/theme/katex-0.15.3/katex.min.css">
</head>

<body class="post-template">
	<header class="site-head">
		<h1 class="blog-title"><a href="https://blog.liang2.tw">Liang-Bo Wang's Blog</a></h1>
		<h2 class="blog-description">
			<a href="https://blog.liang2.tw/about-me/">About</a> |
			<a href="https://blog.liang2.tw/talks/">Talks</a> |
			<a href="https://blog.liang2.tw/archives.html">Archives</a> |
			<button class="theme-toggle" aria-label="auto" aria-live="polite">🌙</button>
		</h2>
	</header>
	<main id="content" class="content" role="main">
<article class="post">
    <span class="post-meta">
        <time datetime="2015-09-28">Sep 28, 2015</time>
        in <a href="https://blog.liang2.tw/category/coding/">Coding</a>
    </span>
    <h1 class="post-title">
        <a href="https://blog.liang2.tw/posts/2015/09/flask-draw-member/" rel="bookmark" title="Permalink to 用 Flask 與 SQLite 架抽籤網站">用 Flask 與 SQLite 架抽籤網站</a>
    </h1>
    <span class="post-meta">
                <a href="https://blog.liang2.tw/tag/zh/">zh</a>
                <a href="https://blog.liang2.tw/tag/flask/">flask</a>
                <a href="https://blog.liang2.tw/tag/sqlite/">sqlite</a>
                <a href="https://blog.liang2.tw/tag/jinja2/">jinja2</a>
                <a href="https://blog.liang2.tw/tag/python/">python</a>
    </span>
    <section class="post-content"><p>為了實驗室的專題生而寫。</p>
<p>目標其實是 Django + Django ORM + PostgreSQL，不過一次接觸太多會有反效果，先操作比較簡單的才好上手。所以這邊講的並不是 best practice，但使用最少（底層）的知識與工具。如果一開始讓太多套件（像 SQLAlchemy）做掉了細節部份，反而不太能掌握到重要的概念以及為什麼需要這些套件。</p>
<p><strong>本篇文章非常長，應該沒辦法幾分鐘內讀完。對象是初學者學習簡單網站架設。</strong></p>
<p>這個專案的目標：因為大家 meeting 的時候都不問問題，教授需要一個抽籤點人問問題的工具。我們實驗室有分成幾個組別，所以抽籤的時候也要能針對單個組別抽。</p>
<p>以下使用 <a href="https://zh.wikipedia.org/wiki/LoveLive!">LoveLive!</a> 還有 <a href="https://zh.wikipedia.org/wiki/K-ON！輕音部">K-ON!</a> 的成員來當例子。<strong>先聲明我兩個動畫都沒有看過，如果有什麼名字打錯請告訴我，絕對不是故意的。</strong>（2016-06-14 更新：我把兩個動畫都看完了！）</p>
<div class="toc">
<ul>
<li><a href="#_1">資料設計</a></li>
<li><a href="#_2">網站架構規劃</a></li>
<li><a href="#_3">實作環境設定</a><ul>
<li><a href="#python">Python 環境</a></li>
<li><a href="#flaskjinja2">安裝 Flask、Jinja2 等套件</a></li>
<li><a href="#sqlite-database">SQLite Database</a></li>
</ul>
</li>
<li><a href="#csv">把 CSV 寫進資料庫</a></li>
<li><a href="#flask">Flask 基本架構</a></li>
<li><a href="#flask-sqlite">Flask 與 SQLite 資料庫讀取</a></li>
<li><a href="#first-view-first-template">First view, first template</a></li>
<li><a href="#_4">抽籤功能</a><ul>
<li><a href="#get-vs-post">GET vs POST</a></li>
<li><a href="#form">Form</a></li>
<li><a href="#request-form-post-handling-in-flask">Request (Form / POST) handling in Flask</a></li>
<li><a href="#demo">Demo</a></li>
</ul>
</li>
<li><a href="#more-on-templates">More on templates</a></li>
<li><a href="#_5">歷史記錄</a><ul>
<li><a href="#datetime">時間處理用 datetime</a></li>
</ul>
</li>
<li><a href="#whats-next">What&rsquo;s Next</a></li>
<li><a href="#static-files-and-better-theme">Static files and better theme</a></li>
<li><a href="#more-how-web-works">More how web works</a></li>
<li><a href="#object-relational-model-orm">Object Relational Model (ORM)</a></li>
<li><a href="#django">Django</a></li>
<li><a href="#_6">總結</a></li>
<li><a href="#details">Details</a><ul>
<li><a href="#sqlite-table-info">SQLite table info</a></li>
<li><a href="#sqlite-foreign-key-check">SQLite foreign key check</a></li>
<li><a href="#_7">重新讀入資料</a></li>
<li><a href="#datetime-in-sqlite-and-python">Datetime in SQLite and Python</a></li>
</ul>
</li>
</ul>
</div>
<h3 id="_1">資料設計</h3>
<p>我們先假設所有檔案都放在同個資料夾裡，估且叫 <code>draw_member</code>。之後沒有額外說明的話，都是在這個目錄下操作。</p>
<p>原始資料用 CSV 格式來儲存，有「名字」以及「團體」兩個欄位。不過考慮到可能會把檔案匯出，在原始檔案多加一個「最近被抽到的日期」欄位，希望最近被抽到的會比其他人再被抽到的機會低一點。</p>
<p>這個 CSV 檔案命名為 <code>members.csv</code>。一開始沒有人被抽到，所以最後一欄都先設成空的<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>，第一行是每一欄欄位的名稱。如果從資料庫匯出，這欄位就會有值。</p>
<div class="highlight"><pre><span></span><code class="language-text">&quot;名字&quot;,&quot;團體&quot;,&quot;最近被抽到的日期&quot;
&quot;高坂 穂乃果&quot;,&quot;μ&#39;s&quot;,&quot;&quot;
&quot;絢瀬 絵里&quot;,&quot;μ&#39;s&quot;,&quot;&quot;
&quot;南 ことり&quot;,&quot;μ&#39;s&quot;,&quot;&quot;
&quot;園田 海未&quot;,&quot;μ&#39;s&quot;,&quot;&quot;
&quot;星空 凛&quot;,&quot;μ&#39;s&quot;,&quot;&quot;
&quot;西木野 真姫&quot;,&quot;μ&#39;s&quot;,&quot;&quot;
&quot;東條 希&quot;,&quot;μ&#39;s&quot;,&quot;&quot;
&quot;小泉 花陽&quot;,&quot;μ&#39;s&quot;,&quot;&quot;
&quot;矢澤 にこ&quot;,&quot;μ&#39;s&quot;,&quot;&quot;
&quot;平沢 唯&quot;,&quot;K-ON!&quot;,&quot;&quot;
&quot;秋山 澪&quot;,&quot;K-ON!&quot;,&quot;&quot;
&quot;田井中 律&quot;,&quot;K-ON!&quot;,&quot;&quot;
&quot;琴吹 紬&quot;,&quot;K-ON!&quot;,&quot;&quot;
&quot;中野 梓&quot;,&quot;K-ON!&quot;,&quot;&quot;
</code></pre></div>

<p>首先我們先確定會用 Python 把資料讀出來。在 Python 當中有個叫 <code>csv</code> 的內建模組（module）可以處理 CSV 的檔案讀寫。在這邊我們選用 <a href="https://docs.python.org/3.5/library/csv.html#csv.DictReader">csv.DictReader</a>，它預設會把檔案的第一行當成欄位名稱，然後根據這名稱，每一行都會產生一個 <code>dict</code> 物件。</p>
<div class="highlight"><pre><span></span><code class="language-python"><span class="kn">import</span> <span class="nn">csv</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./members.csv&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>

<p>可以把這段程式碼直接打在 Python REPL 裡或者存成一個檔案後再用 Python 執行它，結果都會是：</p>
<div class="highlight"><pre><span></span><code class="language-python"><span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;高坂 穂乃果&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s2">&quot;μ&#39;s&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;絢瀬 絵里&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s2">&quot;μ&#39;s&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;南 ことり&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s2">&quot;μ&#39;s&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;園田 海未&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s2">&quot;μ&#39;s&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;星空 凛&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s2">&quot;μ&#39;s&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;西木野 真姫&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s2">&quot;μ&#39;s&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;東條 希&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s2">&quot;μ&#39;s&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;小泉 花陽&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s2">&quot;μ&#39;s&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;矢澤 にこ&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s2">&quot;μ&#39;s&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;平沢 唯&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s1">&#39;K-ON!&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;秋山 澪&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s1">&#39;K-ON!&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;田井中 律&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s1">&#39;K-ON!&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;琴吹 紬&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s1">&#39;K-ON!&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="s1">&#39;名字&#39;</span><span class="p">:</span> <span class="s1">&#39;中野 梓&#39;</span><span class="p">,</span> <span class="s1">&#39;團體&#39;</span><span class="p">:</span> <span class="s1">&#39;K-ON!&#39;</span><span class="p">}</span>
</code></pre></div>

<p>如果不要直接 <code>print(row)</code> ，而是稍微整理一下資料再輸出，改成：</p>
<div class="highlight"><pre><span></span><code class="language-python"><span class="kn">import</span> <span class="nn">csv</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./members.csv&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;名字&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;團體&#39;</span><span class="p">]))</span>
</code></pre></div>

<p>則輸出結果會是：</p>
<div class="highlight"><pre><span></span><code class="language-text">高坂 穂乃果 of μ&#39;s
絢瀬 絵里 of μ&#39;s
南 ことり of μ&#39;s
園田 海未 of μ&#39;s
星空 凛 of μ&#39;s
西木野 真姫 of μ&#39;s
東條 希 of μ&#39;s
小泉 花陽 of μ&#39;s
矢澤 にこ of μ&#39;s
平沢 唯 of K-ON!
秋山 澪 of K-ON!
田井中 律 of K-ON!
琴吹 紬 of K-ON!
中野 梓 of K-ON!
</code></pre></div>

<p>這樣就確定我們有辦法把資料用 Python 讀取了。要拿每個欄位的內容也很簡單，像要名字的話，只要用 <code>row['名字']</code>。</p>
<h3 id="_2">網站架構規劃</h3>
<p>這個抽籤網站主要就幾個功能：</p>
<ul>
<li><strong>首頁</strong>可以選擇其中一個團體或所有人去抽籤<ul>
<li>送出之後可以看到結果</li>
<li>並且把這個抽籤結果更新到歷史記錄裡</li>
</ul>
</li>
<li><strong>歷史記錄</strong>列出過去被抽到的記錄</li>
<li><strong>更新成員</strong>清除所有資料，重新讀入</li>
</ul>
<p>每一頁我們要有個功能表列，方便功能的切換。</p>
<p>所以資料庫的部份會有兩張表格：<strong>members</strong> 以及 <strong>draw_histories</strong> 分別記錄成員以及被抽過的時間。</p>
<pre style="font-family: Consolas, 'Courier New', monospace">
    ┌─────────────────────┐
    │ members             │
    ├─────────────────────┤
    │ id          INTEGER │ <─┐
    │ name           TEXT │   │
    │ group_name     TEXT │   │
    └─────────────────────┘   │
                              │
    ┌─────────────────────┐   │
    │ draw_histories      │   │ foreign
    ├─────────────────────┤   │ key
    │ memberid    INTEGER │ ──┘
    │ time       DATETIME │
    └─────────────────────┘
</pre>

<p>Table <strong>members</strong> 應該很好理解，一個欄位是名字 name，一個是團體名稱 group_name。其中 id 這個欄位是程式內部在使用的，它會在讀入資料的時候自動產生。</p>
<p>Table <strong>draw_histories</strong> 記錄每次抽籤發生的時間 time 還有誰被抽到 memberid，可以發現 memberid 是用成員的 id，因此我們多加一個限制是這欄位的值應該要在 members 裡的 id 中出現過。</p>
<h3 id="_3">實作環境設定</h3>
<p>我們選用 <a href="http://flask.pocoo.org/">Flask</a> 架設 server，因為它一開始用相當簡單。資料的部份會讀到 <a href="https://www.sqlite.org/">SQLite</a> 資料庫。</p>
<blockquote>
<p><em>Flask</em> is a microframework for Python based on Werkzeug, Jinja 2 and good intentions. (Flask official site)</p>
<p><em>SQLite</em> is a software library that implements a self-contained, serverless, zero-configuration, transactional SQL database engine. (SQLite official site)</p>
</blockquote>
<h4 id="python">Python 環境</h4>
<p>使用 <a href="https://www.python.org/downloads/">Python 3.5</a>。理論上 SQLite 就已經裝好了能直接使用。一般在開發 Python 程式的時候會使用虛擬環境，好處虛擬環境安裝的 Python 套件可以獨立管理，不受系統或其他虛擬環境影響。我們用內建的 <a href="https://docs.python.org/3.5/library/venv.html#module-venv">venv</a> 建立一個名稱為 <code>VENV</code> 的虛擬環境：</p>
<div class="highlight"><pre><span></span><code class="language-bash">$ python3.5 -m venv VENV
</code></pre></div>

<p>這時候目錄底下就會多一個 <code>VENV</code> 資料夾，裡面是個完整的 Python 執行結構，就好像在這個路徑安裝 Python 一樣。先暫時不管它怎麼做到虛擬隔離，知道怎麼用就好。使用跟離開分別是：</p>
<div class="highlight"><pre><span></span><code class="language-bash">$ <span class="nb">source</span> VENV/bin/activate
<span class="o">(</span>VENV<span class="o">)</span> $ which python
<span class="c1"># /path/to/draw_member/VENV/bin/python</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code class="language-bash"><span class="o">(</span>VENV<span class="o">)</span> $ deactivate
$  <span class="c1"># 前面的 (VENV) 會消失</span>
</code></pre></div>

<h4 id="flaskjinja2">安裝 Flask、Jinja2 等套件</h4>
<p>Python 使用 pip 管理安裝的套件，</p>
<div class="highlight"><pre><span></span><code class="language-bash"><span class="o">(</span>VENV<span class="o">)</span> $ pip install flask jinja2
<span class="c1"># Collecting flask</span>
<span class="c1"># Collecting jinja2</span>
<span class="c1"># ... (連帶裝了相關的套件）</span>
</code></pre></div>

<p>這時候如果查看裝了哪些套件就會看到：</p>
<div class="highlight"><pre><span></span><code class="language-bash"><span class="o">(</span>VENV<span class="o">)</span> $ pip freeze
<span class="c1"># Flask==0.10.1</span>
<span class="c1"># itsdangerous==0.24</span>
<span class="c1"># Jinja2==2.8</span>
<span class="c1"># MarkupSafe==0.23</span>
<span class="c1"># Werkzeug==0.10.4</span>
</code></pre></div>

<p>為了方便之後把環境安裝在別的電腦上，記得用</p>
<div class="highlight"><pre><span></span><code class="language-bash">pip freeze &gt; requirements.txt
</code></pre></div>

<p>把套件版本的資訊都存在一個檔案裡的好處是，下次把要環境架起來就只要</p>
<div class="highlight"><pre><span></span><code class="language-bash">pip install -r requirements.txt
</code></pre></div>

<p>就設定完成了。</p>
<h4 id="sqlite-database">SQLite Database</h4>
<p>我們先把 SQLite 每個資料表設定好，這樣之後在寫程式就只要專心讀寫資料就好了。根據前面建的模型，我們可以轉換成 SQL 語法：</p>
<div class="highlight"><pre><span></span><code class="language-sql"><span class="c1">-- create_db.sql</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">members</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">ASC</span><span class="w"> </span><span class="n">AUTOINCREMENT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">group_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">draw_histories</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">memberid</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">time</span><span class="w"> </span><span class="n">DATETIME</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="s1">&#39;now&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;localtime&#39;</span><span class="p">)),</span><span class="w"></span>
<span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">memberid</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">members</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</code></pre></div>

<p>把這串 SQL 寫到一個檔案 <code>create_db.sql</code> 後就可以實際測試一下。我們把兩個成員寫到檔案裡面，</p>
<div class="highlight"><pre><span></span><code class="language-bash">$ sqlite3 -init create_db.sql test.db
</code></pre></div>

<div class="highlight"><pre><span></span><code class="language-sqlite3"><span class="go">-- Loading resources from create_db.sql</span>

<span class="go">SQLite version 3.8.11.1 2015-07-29 20:00:57</span>
<span class="go">Enter &quot;.help&quot; for usage hints.</span>
<span class="gp">sqlite&gt;</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">members</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">group_name</span><span class="p">)</span><span class="w"></span>
<span class="gp">   ...&gt;</span><span class="w"> </span><span class="k">VALUES</span><span class="w"></span>
<span class="gp">   ...&gt;</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;高坂 穂乃果&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;μ&#39;&#39;s&#39;</span><span class="p">),</span><span class="w"></span>
<span class="gp">   ...&gt;</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;平沢 唯&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;K-ON!&#39;</span><span class="p">);</span><span class="w"></span>
<span class="gp">sqlite&gt;</span><span class="w"> </span><span class="p">.</span><span class="n">header</span><span class="w"> </span><span class="k">on</span><span class="w"></span>
<span class="gp">sqlite&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">members</span><span class="p">;</span><span class="w"></span>
<span class="go">id|name|group_name</span>
<span class="go">1|高坂 穂乃果|μ&#39;s</span>
<span class="go">2|平沢 唯|K-ON!</span>
</code></pre></div>

<p><code>sqlite3 -init xxx.sql</code> 意思是把 <code>xxx.sql</code> 裡面的 SQL 指令都執行了一遍，所以一進到 SQLite shell 裡面就建立好表格了。</p>
<p>再來我們模擬幾次抽籤的過程。注意到我們之前有寫 <strong>draw_histories</strong>.time 的預設值，所以抽籤只要寫是誰就可以了，時間 SQLite 會自動根據指令執行的時間給值。不過我們都試一下吧。</p>
<div class="highlight"><pre><span></span><code class="language-sqlite3"><span class="gp">sqlite&gt;</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">draw_histories</span><span class="w"> </span><span class="p">(</span><span class="n">memberid</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="gp">sqlite&gt;</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">draw_histories</span><span class="w"> </span><span class="p">(</span><span class="n">memberid</span><span class="p">,</span><span class="w"> </span><span class="k">time</span><span class="p">)</span><span class="w"></span>
<span class="gp">   ...&gt;</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">datetime</span><span class="p">(</span><span class="s1">&#39;2015-09-25 16:30&#39;</span><span class="p">));</span><span class="w"></span>
</code></pre></div>

<p>所以第一次 INSERT 指令抽了果果以及小唯各一次。第二次 INSERT 再抽了一次小唯，這次還有額外指定時間為的 9 月 25 號下午 4 點半。關於 SQLite 裡 <code>datetime</code> 的更多使用方式可以參考<a href="https://sqlite.org/lang_datefunc.html">官網說明文件</a>，我們的例子只要這樣就足夠了。</p>
<div class="highlight"><pre><span></span><code class="language-sqlite3"><span class="gp">sqlite&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">draw_histories</span><span class="p">;</span><span class="w"></span>
<span class="go">memberid|time</span>
<span class="go">1|2015-09-28 16:55:03</span>
<span class="go">2|2015-09-28 16:55:03</span>
<span class="go">2|2015-09-25 16:30:00</span>
</code></pre></div>

<p>前兩個就是第一次 INSERT 所建立的抽籤歷史，跟你下指令的時間有關。第二次 INSERT 有給定時間，所以記錄永遠是 9 月 25 號下午。</p>
<p><strong>draw_histories</strong> 只儲存了 member_id，我們可以做一個比較複雜的查詢，把成員的名字跟所屬團體一起列出來。</p>
<div class="highlight"><pre><span></span><code class="language-sqlite3"><span class="gp">sqlite&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">group_name</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="k">time</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">draw_time</span><span class="w"></span>
<span class="gp">   ...&gt;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">draw_histories</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">members</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">m</span><span class="w"></span>
<span class="gp">   ...&gt;</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">memberid</span><span class="w"></span>
<span class="gp">   ...&gt;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="k">time</span><span class="w"> </span><span class="k">ASC</span><span class="p">;</span><span class="w"></span>
<span class="go">id|name|group_name|draw_time</span>
<span class="go">2|平沢 唯|K-ON!|2015-09-25 16:30:00</span>
<span class="go">1|高坂 穂乃果|μ&#39;s|2015-09-28 16:55:03</span>
<span class="go">2|平沢 唯|K-ON!|2015-09-28 16:55:03</span>
</code></pre></div>

<h3 id="csv">把 CSV 寫進資料庫</h3>
<p>我們就把之後要用的資料庫取名為 <code>members.db</code>。我們先把初始的資料寫進資料庫裡。</p>
<p>這邊只有多一個在 Python 裡操作 SQLite 的步驟。透過 Python 內建的 <a href="https://docs.python.org/3.5/library/sqlite3.html">sqlite</a> module 就可以控制資料庫存取。先確定有這些檔案了：</p>
<ul>
<li><code>members.csv</code>: 所有成員資料</li>
<li><code>create_db.sql</code>: 資料庫 schema</li>
</ul>
<p>先 import 用到的 module</p>
<div class="highlight"><pre><span></span><code class="language-pycon"><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">csv</span>
</code></pre></div>

<p>把成員資料從 CSV 讀進來，跟之前一樣，只是我們稍微整理一下格式，存在 <code>members</code> 這個變數。</p>
<div class="highlight"><pre><span></span><code class="language-pycon"><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./members.csv&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">members</span> <span class="o">=</span> <span class="p">[</span>
<span class="gp">... </span>        <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;名字&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;團體&#39;</span><span class="p">])</span>
<span class="gp">... </span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span>
<span class="gp">... </span>    <span class="p">]</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">members</span>
<span class="go">[(&#39;高坂 穂乃果&#39;, &quot;μ&#39;s&quot;),</span>
<span class="go"> (&#39;絢瀬 絵里&#39;, &quot;μ&#39;s&quot;),</span>
<span class="go"> (&#39;南 ことり&#39;, &quot;μ&#39;s&quot;),</span>
<span class="go"> (&#39;園田 海未&#39;, &quot;μ&#39;s&quot;),</span>
<span class="go"> # ...</span>
<span class="go"> (&#39;中野 梓&#39;, &#39;K-ON!&#39;)]</span>
</code></pre></div>

<p>接著是新的部份，要先用 <code>sqlite3.connect()</code> 建立 SQLite database 連線，然後再用這個連線去下 SQL 指令。首先要把 table 都建立出來：</p>
<div class="highlight"><pre><span></span><code class="language-pycon"><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;create_db.sql&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">create_db_sql</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;members.db&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">db</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">db</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">create_db_sql</span><span class="p">)</span>
<span class="gp">...</span>
</code></pre></div>

<p><code>db.executescript('...')</code> 可以執行一系列的 SQL 指令（注意指令間要有分號）。另外使用 <code>with db: ...</code> 作用是會 sqlite3 module 會自動幫我們把中間的 SQL 指令送出<sup id="fnref:sqlite3 auto commit"><a class="footnote-ref" href="#fn:sqlite3 auto commit">2</a></sup>，等同於：</p>
<div class="highlight"><pre><span></span><code class="language-python"><span class="o">&gt;&gt;&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">create_db_sql</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>

<p>再來把讀進來的 <code>members</code> 變數寫到資料表裡面。</p>
<div class="highlight"><pre><span></span><code class="language-pycon"><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">db</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">db</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
<span class="gp">... </span>        <span class="s1">&#39;INSERT INTO  members (name, group_name) VALUES (?, ?)&#39;</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">members</span>
<span class="gp">... </span>    <span class="p">)</span>
</code></pre></div>

<p>試著把資料讀出來，確定真的存進去了。</p>
<div class="highlight"><pre><span></span><code class="language-pycon"><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM members LIMIT 3&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="go">(1, &#39;高坂 穂乃果&#39;, &quot;μ&#39;s&quot;)</span>
<span class="go">(2, &#39;絢瀬 絵里&#39;, &quot;μ&#39;s&quot;)</span>
<span class="go">(3, &#39;南 ことり&#39;, &quot;μ&#39;s&quot;)</span>
</code></pre></div>

<p>到了這邊我們資料的部份沒問題了，接下來就要處理網站流程本身。</p>
<h3 id="flask">Flask 基本架構</h3>
<p><a href="http://flask.pocoo.org/">Flask</a> 的 web server 可以把所有功能都寫在一個檔案，在這邊就以 <code>draw_member.py</code> 為例子。</p>
<div class="highlight"><pre><span></span><code class="language-python"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;p&gt;Hello World!&lt;/p&gt;&quot;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>以上就是最基本的 Flask server 架構。先來測試看看，都已經等待一千六百多字了。先把 server 跑起來，</p>
<div class="highlight"><pre><span></span><code class="language-bash"><span class="o">(</span>VENV<span class="o">)</span> $ python draw_member.py
 * Running on http://127.0.0.1:5000/ <span class="o">(</span>Press CTRL+C to quit<span class="o">)</span>
 * Restarting with stat
</code></pre></div>

<p>再來可以開瀏覽器訪問 <a href="http://localhost:5000/">http://localhost:5000/</a>，或者用 command line 來訪問：</p>
<div class="highlight"><pre><span></span><code class="language-bash">$ curl <span class="s1">&#39;http://localhost:5000/&#39;</span>
<span class="c1"># &lt;p&gt;Hello World!&lt;/p&gt;</span>
</code></pre></div>

<p>會看到 server 回傳「Hello World!」。太感動了！底下先說明整個流程與 code 的關係。</p>
<p><code>app</code> 是整個 Flask application 的核心物件，可以看到最後我們會呼叫它的 <code>.run()</code> 來產生一個可以動的 web server。<code>debug=True</code> 表示如果 server 有錯誤的時候 Flask 會提供我們完整的錯誤訊息，包含錯誤是在哪個 Python function 裡產生的，錯誤時各個變數的值等等。因為這樣會也會讓有心人士知道網站是怎麼運行的，變正式網站（上 production）時會把這個選項關掉。</p>
<p>我們定義了一個 <code>index</code> function 並且用 decorator 把這個函式綁定在 <code>/</code> 路徑也就是首頁上。使用者訪問 <code>/</code> 就會跑到這個 function 裡來。</p>
<h3 id="flask-sqlite">Flask 與 SQLite 資料庫讀取</h3>
<p>我們先把資料庫相關的函式都先寫好，這邊基本上參照 <a href="http://flask.pocoo.org/docs/0.10/patterns/sqlite3/#using-sqlite-3-with-flask">Flask 官網 SQLite 使用方式</a>。</p>
<div class="highlight"><pre><span></span><code class="language-python"><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">g</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">SQLITE_DB_PATH</span> <span class="o">=</span> <span class="s1">&#39;members.db&#39;</span>
<span class="n">SQLITE_DB_SCHEMA</span> <span class="o">=</span> <span class="s1">&#39;create_db.sql&#39;</span>
<span class="n">MEMBER_CSV_PATH</span> <span class="o">=</span> <span class="s1">&#39;members.csv&#39;</span>


<span class="c1"># SQLite3-related operations</span>
<span class="c1"># See SQLite3 usage pattern from Flask official doc</span>
<span class="c1"># http://flask.pocoo.org/docs/0.10/patterns/sqlite3/</span>
<span class="k">def</span> <span class="nf">get_db</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;_database&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">SQLITE_DB_PATH</span><span class="p">)</span>
        <span class="c1"># Enable foreign key check</span>
        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys = ON&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">teardown_appcontext</span>
<span class="k">def</span> <span class="nf">close_connection</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;_database&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>一下子多了很多 code，如果太複雜可以先當作就是這樣吧。</p>
<p>需要了解的部份，第一是 <code>g</code> 這個變數裡可以放很多需要傳來傳去的變數，所以就把建立好的資料庫連線放在 <code>g._database</code>。平常如果要用這個連線的話，就用 <code>db = get_db()</code> 去拿。</p>
<p>第二是我們把資料的路徑等等，都寫成變數放在程式碼的最開頭。這是個好習慣，把常數跟程式分開來，管理才方便<sup id="fnref:flask-config"><a class="footnote-ref" href="#fn:flask-config">3</a></sup>。</p>
<h3 id="first-view-first-template">First view, first template</h3>
<p>先來做首頁，把 HTML 放在 <code>templates/index.html</code>。</p>
<div class="highlight"><pre><span></span><code class="language-html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>成員抽籤<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>來抽出快樂的夥伴吧！<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>功能列<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>首頁（抽籤）<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>歷史記錄<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>清除記錄、更新成員資料<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p>這只是個單純的首頁，有個標題，還有個功能列，但暫時都沒有功能。我們修改一下 <code>draw_member.py</code> 裡定義的 index 讓：</p>
<div class="highlight"><pre><span></span><code class="language-python"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">)</span>
</code></pre></div>

<p>馬上來執行看看，用一樣的方式。不過之前執行的那個可能沒有結束，記得一個 port 只能有一個服務，所以要不是用舊的（Flask 很聰明，在 <code>debug=True</code> 時知道檔案被更新時就會用新的），要不是就關掉再重開一個新的。</p>
<p>打開瀏覽器訪問 <a href="http://localhost:5000">http://localhost:5000</a> 應該會出現底下的畫面。</p>
<figure class="align-center">
  <img src="https://blog.liang2.tw/posts/2015/09/flask-draw-member/pics/flask_helloworld.png"/>
  <figcaption>Flask Hello World</figcaption>
</figure>

<h3 id="_4">抽籤功能</h3>
<p>接下來要實作抽籤的功能啦，照前面說的，我們在首頁會設一個團體列表，使用者就會選擇某個團體去抽籤。</p>
<p>在實作之前要來背景介紹一下，要先講一下 GET 與 POST 的差異。</p>
<h4 id="get-vs-post">GET vs POST</h4>
<p>使用者平常在訪問網站時，該人輸入一個網站、點一個超連址，這時候瀏覽器會發送一個 GET request 到對應的 server 以及路徑。瀏覽器（通常）就會回傳一個對應的 HTML 檔案，瀏覽器就會負責把它顯示在畫面上。</p>
<p>但當使用者跟網站有更多互動的時候，常常是要把使用者的資訊送給網站時，像帳號登入、填問卷表單，或者在這邊的選擇某個團體去抽籤，這時候就會透過 POST。</p>
<p>更多的 GET/POST 以及其他的 HTTP request，可以參考<a href="https://archer1609wp.wordpress.com/2014/03/02/httppost%E8%88%87get/">一頁式介紹（中）</a>或<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP">非常完整的介紹在 Mozilla Developer Network (MDN)（英）</a></p>
<h4 id="form">Form</h4>
<p>最常見的 POST 就是搭配<a href="https://developer.mozilla.org/en/docs/Web/HTML/Element/form">表單 (form)</a> 使用。像登入要填帳號密碼、問卷問題與回答，就很常用 form 實作。Form 裡面有很多種 input，代表使用者能填的欄位，類型可能是單選、複選、單行、多行、密文等。</p>
<p>我們就先看一下 form 實際的長相吧。改寫 <code>templates/index.html</code>，加上一個抽籤選團體的 form。</p>
<div class="highlight"><pre><span></span><code class="language-text">&lt;h1&gt;來抽出快樂的夥伴吧！&lt;/h1&gt;&lt;!-- 本來有的 --&gt;
&lt;p&gt;選擇要被抽的團體&lt;/p&gt;
&lt;form action=&quot;/draw&quot; method=&quot;post&quot;&gt;
  &lt;label for=&quot;group_name&quot;&gt;團隊名稱：&lt;/label&gt;
  &lt;input type=&quot;radio&quot; name=&quot;group_name&quot; value=&quot;μ&#39;s&quot;&gt;μ&#39;s
  &lt;input type=&quot;radio&quot; name=&quot;group_name&quot; value=&quot;K-ON!&quot;&gt;K-ON!
  &lt;input type=&quot;radio&quot; name=&quot;group_name&quot; value=&quot;ALL&quot; checked&gt;（全）
  &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;
&lt;/form&gt;
&lt;hr&gt;&lt;!-- 這是分隔線 --&gt;
</code></pre></div>

<p>基本上加在 body 裡面就可以。這個 form 包含了一個標籤，指定是給名為 <code>group_name</code> 的 input。底下接四個 input tags 但實際上只有兩大個。</p>
<p>第一大個是團體的單選選項共三個 input，注意到他們的 <code>name</code> 都是 <code>group_name</code> 但 <code>value</code> 不同，後面接著他們顯示的字。其中「（全）」它多了一個 <code>checked</code> 表示預設選擇這個選項。</p>
<p>另一大個是 <code>type=submit</code> 的 input，他就是送出的表單的按鈕。</p>
<p>再來注意 form tag 本身。<code>method="post"</code> 應該很好理解，表示要送出 POST request；<code>action="/draw"</code> 表示這個 POST 要發到 <code>/draw</code> 這個路徑。</p>
<p>同樣，form 底下也很多細節，歡迎再去 <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/Forms">MDN</a> 了解。</p>
<h4 id="request-form-post-handling-in-flask">Request (Form / POST) handling in Flask</h4>
<p>所以我們馬上來寫處理 <code>/draw</code> POST 的 view 吧。</p>
<div class="highlight"><pre><span></span><code class="language-python"><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/draw&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">draw</span><span class="p">():</span>
    <span class="c1"># Get the database connection</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>

    <span class="c1"># Draw member ids from given group</span>
    <span class="c1"># If ALL is given then draw from all members</span>
    <span class="n">group_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group_name&#39;</span><span class="p">,</span> <span class="s1">&#39;ALL&#39;</span><span class="p">)</span>
    <span class="n">valid_members_sql</span> <span class="o">=</span> <span class="s1">&#39;SELECT id FROM members &#39;</span>
    <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="s1">&#39;ALL&#39;</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">valid_members_sql</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">valid_members_sql</span> <span class="o">+=</span> <span class="s1">&#39;WHERE group_name = ?&#39;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">valid_members_sql</span><span class="p">,</span> <span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">valid_member_ids</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span>
    <span class="p">]</span>

    <span class="c1"># If no valid members return 404 (unlikely)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_member_ids</span><span class="p">:</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;&lt;p&gt;No members in group &#39;</span><span class="si">%s</span><span class="s2">&#39;&lt;/p&gt;&quot;</span> <span class="o">%</span> <span class="n">group_name</span>
        <span class="k">return</span> <span class="n">err_msg</span><span class="p">,</span> <span class="mi">404</span>

    <span class="c1"># Randomly choice a member</span>
    <span class="n">lucky_member_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_member_ids</span><span class="p">)</span>

    <span class="c1"># Obtain the lucy member&#39;s information</span>
    <span class="n">member_name</span><span class="p">,</span> <span class="n">member_group_name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT name, group_name FROM members WHERE id = ?&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="n">lucky_member_id</span><span class="p">,</span> <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;p&gt;</span><span class="si">%s</span><span class="s1">（團體：</span><span class="si">%s</span><span class="s1">）&lt;/p&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">member_name</span><span class="p">,</span> <span class="n">member_group_name</span><span class="p">)</span>
</code></pre></div>

<p>Flask 會把使用者發給 server 的 request 存在 <code>request</code> 裡面，其實使用者會傳蠻多資訊的，像該人的語言、用的瀏覽器、時間等等，這些都能在 <code>request</code> 找到。而使用者填好的 form 的內容會存在當中 <code>request.form</code> 裡，而我們先前定義在 form 中 input name 就會變成這邊的 dict key。</p>
<p>因此如果要拿使用者決定的 <code>group_name</code> 時，就會寫成 <code>request.form.get('group_name', 'ALL')</code>。這相當於 <code>request.form['group_name']</code> 但在沒有這個 key 時回傳預設值 <code>'ALL'</code>。正常使用並不會找不到這個 key，但網站開發者永遠不要相信使用者會乖乖回傳這些內容。</p>
<p>拿了團體名稱之後，就用團體名稱去下查詢的 SQL。同理這名稱可能沒有結果，這時就回傳一個 HTTP status code 為 404 的錯誤訊息。一般情況 4XX 都代表使用者給的資料有問題的。</p>
<p>拿到了所有成員的 id 後，用了個 <code>random.choice</code> 隨機抽一個出來。如同字面上的意思，<a href="https://docs.python.org/3.5/library/random.html#random.choice">random</a> 是個 Python 內建的 module。再把這個 id 拿去查名字與團體。</p>
<p>我們總共做了兩個資料庫查詢，第一次把可能的 member id 都傳回來，第二次把抽中的人的名字、團體都拿回來。暫時還沒做寫到歷史的功能，但那個也不難，之後再說。先不做 template，把結果包在 HTML 最基本的 <code>&lt;p&gt;</code> 元素就傳回來。</p>
<h4 id="demo">Demo</h4>
<p>重新整理首頁，可以看到多了一個表單（廢話）。Flask 的 web server 很聰明，不用重新啟動它，會自動看到檔案有更新做 reload。可以回去比對一下自己寫在 <code>index.html</code> 裡 HTML 在瀏覽器上呈現的對應關係。</p>
<figure class="align-center">
  <img src="https://blog.liang2.tw/posts/2015/09/flask-draw-member/pics/flask_index_form.png"/>
  <figcaption>新的首頁，多了一個表單</figcaption>
</figure>

<p>按下 Submit 之後就會跳到抽籤結果（注意 URL 的變化）</p>
<figure class="align-center">
  <img src="https://blog.liang2.tw/posts/2015/09/flask-draw-member/pics/flask_draw_result.png"/>
  <figcaption>抽籤結果</figcaption>
</figure>

<p>預計是抽全部，你也可以回到上一頁，選自己想要的團體。</p>
<p>最重要的功能就完成啦！如果自己程式遇到一些狀況的話，可以看<a href="https://github.com/ccwang002/draw_member/blob/169d81650d8ca649c5484c43c05324885e7cb7fb/draw_member.py">我寫的完整版本</a>。</p>
<h3 id="more-on-templates">More on templates</h3>
<p>之前我們 <code>render_template</code> 其實都是傳一個完整的 HTML 內容給它，並沒有用到 template 功能。Template 有幾個用處：</p>
<ul>
<li>集中重覆用到的片段、結構</li>
<li>讓一部份 HTML 的內容受變數控制</li>
</ul>
<p>馬上來改寫一下吧。我們的功能表應該每一頁都要出現，再來我們希望 <code>/draw</code> 的頁面也是個完整的 HTML。</p>
<p>首先先把常用的部份獨立出來，做成 <code>templates/base.html</code>。</p>
<div class="highlight"><pre><span></span><code class="language-text">&lt;!-- templates/base.html --&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;&gt;
    &lt;title&gt;{% block title %}成員抽籤{% endblock title %}&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    {% block content %}{% endblock content %}
    &lt;hr&gt;
    &lt;h3&gt;功能列&lt;/h3&gt;
    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;/&quot;&gt;首頁（抽籤）&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;/history&quot;&gt;歷史記錄&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;/reset&quot;&gt;清除記錄、更新成員資料&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre></div>

<p>像功能列這種不會變的就很適合放在這邊。而我們的首頁就可以重覆使用這個結構，</p>
<div class="highlight"><pre><span></span><code class="language-text">&lt;!-- templates/index.html --&gt;
{% extends &quot;base.html&quot; %}

{% block content %}
&lt;h1&gt;來抽出快樂的夥伴吧！&lt;/h1&gt;
&lt;p&gt;選擇要被抽的團體&lt;/p&gt;
&lt;form action=&quot;/draw&quot; method=&quot;post&quot;&gt;
  &lt;label for=&quot;group_name&quot;&gt;團隊名稱：&lt;/label&gt;
  &lt;input type=&quot;radio&quot; name=&quot;group_name&quot; value=&quot;μ&#39;s&quot;&gt;μ&#39;s
  &lt;input type=&quot;radio&quot; name=&quot;group_name&quot; value=&quot;K-ON!&quot;&gt;K-ON!
  &lt;input type=&quot;radio&quot; name=&quot;group_name&quot; value=&quot;ALL&quot; checked&gt;（全）
  &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;
&lt;/form&gt;
{% endblock content %}
</code></pre></div>

<p>可以看到最大的差異就是我們的 <code>index.html</code> 變簡單了。它就像物件繼承一樣，<code>{% extends "base.html" %}</code>，表示先把 <code>base.html</code> 的內容放進來，而裡面定義了兩個 block：<code>title</code> 以及 <code>content</code>。Index 有定義 content 的內容，所以就取代掉原本定義在 base 裡空的 content。  Index 並沒有定義 title，那就會用原本 block 內的值，即「成員抽籤」。</p>
<p>再來處理 <code>/draw</code> 的部份，我們除而再利用 <code>base.html</code> 之外，還要引入 template variable 的概念。</p>
<div class="highlight"><pre><span></span><code class="language-text">&lt;!-- templates/draw.html --&gt;
{% extends &quot;base.html&quot; %}

{% block title %}抽籤結果{% endblock title %}

{% block content %}
&lt;h1&gt;抽籤結果&lt;/h1&gt;
&lt;p&gt;{{ name }}（團體：{{ group }}）&lt;/p&gt;
{% endblock content %}
</code></pre></div>

<p>特別的是 <code>{{ name }}</code> 和 <code>{{ group }}</code>。這語法表示他們的值分別受 <code>name</code> 和 <code>group</code> 這兩個變數決定，變數的值在 <code>render_template</code> 時才會決定。要怎麼把變數的值傳到 template 裡呢？</p>
<div class="highlight"><pre><span></span><code class="language-python"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/draw&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">draw</span><span class="p">():</span>
    <span class="c1"># ...</span>
    <span class="c1"># return &#39;&lt;p&gt;%s（團體：%s）&lt;/p&gt;&#39; % (member_name, member_group_name)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;draw.html&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">member_name</span><span class="p">,</span>
        <span class="n">group</span><span class="o">=</span><span class="n">member_group_name</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>

<p>改寫好的 draw 使用 template <code>templates/draw.html</code>，並在 <code>render_template</code> 時把變數的值都放進去。</p>
<p>這時候才重新抽籤可以看到新的 template 的輸出結果，功能表也出現了。</p>
<figure class="align-center">
  <img src="https://blog.liang2.tw/posts/2015/09/flask-draw-member/pics/flask_new_draw_result.png"/>
</figure>

<h3 id="_5">歷史記錄</h3>
<p>記得要在抽籤的時候把記錄加到 database 裡。因為之前有設好 schema 預設用現在時間當抽籤時間，所以時間的處理完全交給 SQLite。用 SQL 語法 <code>LIMIT 10</code> 以及 <code>ORDER BY</code> 選擇最近的十筆，同時在查結果時，也同時查詢 <strong>members</strong> table 對應的名字與團體。這個專業術語叫 <a href="https://en.wikipedia.org/wiki/Join_%28SQL%29">JOIN</a>。</p>
<p>把這個 view 放在 <code>/history</code> 路徑。</p>
<div class="highlight"><pre><span></span><code class="language-python"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/draw&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">draw</span><span class="p">():</span>
    <span class="c1"># ...</span>
    <span class="c1"># Update draw history</span>
    <span class="k">with</span> <span class="n">db</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;INSERT INTO draw_histories (memberid) VALUES (?)&#39;</span><span class="p">,</span>
                   <span class="p">(</span><span class="n">lucky_member_id</span><span class="p">,</span> <span class="p">))</span>
    <span class="c1"># Render template</span>
    <span class="k">return</span> <span class="o">...</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/history&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">history</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
    <span class="n">recent_histories</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT m.name, m.group_name, d.time &#39;</span>
        <span class="s1">&#39;FROM draw_histories AS d, members as m &#39;</span>
        <span class="s1">&#39;WHERE m.id == d.memberid &#39;</span>
        <span class="s1">&#39;ORDER BY d.time DESC &#39;</span>
        <span class="s1">&#39;LIMIT 10&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;history.html&#39;</span><span class="p">,</span>
        <span class="n">recent_histories</span><span class="o">=</span><span class="n">recent_histories</span>
    <span class="p">)</span>
</code></pre></div>

<p>同理也要建立對應的 template。</p>
<div class="highlight"><pre><span></span><code class="language-text">&lt;!-- templates/history.html --&gt;
{% extends &quot;base.html&quot; %}

{% block title %}抽籤歷史{% endblock title %}

{% block content %}
&lt;h1&gt;抽籤歷史（最近 10 筆）&lt;/h1&gt;
&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;名字&lt;/th&gt;
      &lt;th&gt;團體&lt;/th&gt;
      &lt;th&gt;抽中時間&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    {% for history in recent_histories %}
    &lt;tr&gt;
      &lt;td&gt;{{ history.0 }}&lt;/td&gt;
      &lt;td&gt;{{ history.1 }}&lt;/td&gt;
      &lt;td&gt;{{ history.2 }}&lt;/td&gt;
    &lt;/tr&gt;
    {% endfor %}
  &lt;/tbody&gt;
&lt;/table&gt;
{% endblock content %}
</code></pre></div>

<p>這邊用了新的 template 語法 for loop，每次 loop <code>history</code> 的值都會變，而且還可以再存取它底下的屬性，寫成 Python 就像：</p>
<div class="highlight"><pre><span></span><code class="language-python"><span class="k">for</span> <span class="n">history</span> <span class="ow">in</span> <span class="n">recent_histories</span><span class="p">:</span>
    <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>

<p>Flask 用的 Jinja2 template 功能很多，現在各位已經比較理解 server 的運作了，可以去閱讀一下 <a href="http://jinja.pocoo.org/docs/dev/templates/">Jinja2 官網文件</a>看完整的使用方式。</p>
<figure class="align-center">
  <img src="https://blog.liang2.tw/posts/2015/09/flask-draw-member/pics/flask_history.png"/>
</figure>

<h4 id="datetime">時間處理用 datetime</h4>
<p>如果有注意到的話，我們用的時間從 SQLite 回傳回來其實是字串。想要改寫時間格式怎麼辦？這時候就要用上內建 module <a href="https://docs.python.org/3.5/library/datetime.html#datetime-objects">datetime</a> 裡提供的 <code>datetime</code> 物件。同時我們也順便把本來用 <code>fetchall()</code> 的結果，改成用 dict 表示每一筆歷史。</p>
<div class="highlight"><pre><span></span><code class="language-python"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/history&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">history</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT m.name, m.group_name, d.time AS &quot;draw_time [timestamp]&quot; &#39;</span>
        <span class="s1">&#39;FROM draw_histories AS d, members as m &#39;</span>
        <span class="s1">&#39;WHERE m.id == d.memberid &#39;</span>
        <span class="s1">&#39;ORDER BY d.time DESC &#39;</span>
        <span class="s1">&#39;LIMIT 10&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">recent_histories</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">recent_histories</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;draw_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">),</span>
        <span class="p">})</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code class="language-text">{% for history in recent_histories %}
&lt;tr&gt;
  &lt;td&gt;{{ history.name }}&lt;/td&gt;
  &lt;td&gt;{{ history.group }}&lt;/td&gt;
  &lt;td&gt;{{ history.draw_time.strftime(&quot;%Y 年 %m 月 %d 日 %H 時 %M 分&quot;) }}&lt;/td&gt;
&lt;/tr&gt;
{% endfor %}
</code></pre></div>

<p>可以看到 for loop 不再使用 0, 1, 2 去拿每筆歷史各欄位的值，而是用欄位名稱，相當於 <code>history['name']</code>。這樣的做法比較好，因為用數字一下就忘了，隨便調整一下 view 的內容順序就不一定是這樣了；單獨讀 template 也能懂每個欄位的意思。</p>
<figure class="align-center">
  <img src="https://blog.liang2.tw/posts/2015/09/flask-draw-member/pics/flask_history_zh.png"/>
</figure>

<h3 id="whats-next">What&rsquo;s Next</h3>
<h3 id="static-files-and-better-theme">Static files and better theme</h3>
<p>我們只用了 HTML template。想要讓網站看起來更漂亮，就要寫 CSS 與 Javascript (JS)。有像 Bootstrap、PureCSS、Semantic UI 這類的「framework」，套用之後能在短時間畫出美觀實用的版面。</p>
<p>而 CSS、JS，以及站上大大小的其他檔案都必需要從 server 傳送到用戶端上，這邊就是 static files 的處理。</p>
<h3 id="more-how-web-works">More how web works</h3>
<p>除了 HTTP GET、POST 之外，還有 HTTPS、session、cookie 等很常見的技術。</p>
<h3 id="object-relational-model-orm">Object Relational Model (ORM)</h3>
<p>我們只舉了純寫 SQL 的例子，但當專案變複雜的時候，純 SQL 管理上越來越複雜。ORM 是一種解決的方案。</p>
<h3 id="django">Django</h3>
<p>當然可以繼續把 Flask 研究下去，它也是個很好的 web framework。不過我們主要的 code base 是 Django。所以希望大家在了解一個 web server (app) 長得像怎樣之後，就可以開始學習 Django。Django 與 Flask 最大的設計不同就是 Django 一開始就提供了很多模組與功能，感覺很「肥」，而 Flask 只提供了必要的功能</p>
<h3 id="_6">總結</h3>
<p>這樣就是一個完整的抽籤的網站了。其實架網站的主要知識也差不多是這些，再來就是細節以及知識的加強。</p>
<p>做好的成品我也放在 <a href="https://github.com/ccwang002/draw_member">Github</a> 上了，裡面的 commit log 記錄了幾個重要的步驟，所以想要看看每一步的結果可以用 <code>git checkout</code> 回到每個記錄點，例如想要看抽籤功能寫完，用上 template 的版本就可以到 <code>git checkout f39fc1</code>。</p>
<p>PS: 沒想到會寫這麼長啊……</p>
<h3 id="details">Details</h3>
<p>底下記了很多技術細節，有興趣再看吧。</p>
<h4 id="sqlite-table-info">SQLite table info</h4>
<p>除了用 <code>.schema</code> 去看每個 TABLE 建立時的指令之外，也可以用 <code>PRAGMA table_info</code> 去看某個 table 每個欄位的設定。</p>
<div class="highlight"><pre><span></span><code class="language-sqlite3"><span class="go">-- Run `sqlite -init create_db.sql`</span>
<span class="gp">sqlite&gt;</span><span class="w"> </span><span class="p">.</span><span class="n">header</span><span class="w"> </span><span class="k">on</span><span class="w"></span>
<span class="gp">sqlite&gt;</span><span class="w"> </span><span class="p">.</span><span class="k">mode</span><span class="w"> </span><span class="k">column</span><span class="w"></span>
<span class="gp">sqlite&gt;</span><span class="w"> </span><span class="n">PRAGMA</span><span class="w"> </span><span class="n">table_info</span><span class="p">(</span><span class="n">members</span><span class="p">);</span><span class="w"></span>
<span class="go">cid  name         type       notnul  dflt_value                    pk</span>
<span class="go">---  -----------  ---------  ------  ----------------------------  --</span>
<span class="go">0    id           INTEGER    0                                     1</span>
<span class="go">1    name         TEXT       1                                     0</span>
<span class="go">2    group_name   TEXT       0                                     0</span>
<span class="gp">sqlite&gt;</span><span class="w"> </span><span class="n">PRAGMA</span><span class="w"> </span><span class="n">table_info</span><span class="p">(</span><span class="n">draw_histories</span><span class="p">);</span><span class="w"></span>
<span class="go">cid  name         type       notnul  dflt_value                    pk</span>
<span class="go">---  -----------  ---------  ------  ----------------------------  --</span>
<span class="go">0    memberid     INTEGER    0                                     0</span>
<span class="go">1    draw_time    DATETIME   0       datetime(&#39;now&#39;, &#39;localtime&#39;)  0</span>
</code></pre></div>

<h4 id="sqlite-foreign-key-check">SQLite foreign key check</h4>
<p>SQLite3 在比較新版才會去處理 foreign key 限制的功能，參考<a href="https://www.sqlite.org/foreignkeys.html#fk_enable">官網的說明</a>，</p>
<div class="highlight"><pre><span></span><code class="language-sqlite3"><span class="gp">sqlite&gt;</span><span class="w"> </span><span class="n">PRAGMA</span><span class="w"> </span><span class="n">foreign_keys</span><span class="p">;</span><span class="w"></span>
<span class="go">0</span>
</code></pre></div>

<p>如果是 0 的話表示 SQLite 並不會去檢查 foreign key。這可以手動打開檢查。</p>
<div class="highlight"><pre><span></span><code class="language-sqlite3"><span class="gp">sqlite&gt;</span><span class="w"> </span><span class="n">PRAGMA</span><span class="w"> </span><span class="n">foreign_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ON</span><span class="p">;</span><span class="w"></span>
<span class="gp">sqlite&gt;</span><span class="w"> </span><span class="n">PRAGMA</span><span class="w"> </span><span class="n">foreign_keys</span><span class="p">;</span><span class="w"></span>
<span class="go">1</span>
<span class="gp">sqlite&gt;</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">draw_histories</span><span class="p">(</span><span class="n">memberid</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="go">Error: FOREIGN KEY constraint failed</span>
</code></pre></div>

<h4 id="_7">重新讀入資料</h4>
<p>我們先包好一個 function <code>reset_db</code>。</p>
<div class="highlight"><pre><span></span><code class="language-python"><span class="c1"># draw_members.py</span>
<span class="k">def</span> <span class="nf">reset_db</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">SQLITE_DB_SCHEMA</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">create_db_sql</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
    <span class="c1"># Reset database</span>
    <span class="c1"># Note that CREATE/DROP table are *immediately* committed</span>
    <span class="c1"># even inside a transaction</span>
    <span class="k">with</span> <span class="n">db</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS draw_histories&quot;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS members&quot;</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">create_db_sql</span><span class="p">)</span>

    <span class="c1"># Read members CSV data</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">MEMBER_CSV_PATH</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">members</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;名字&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;團體&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span>
        <span class="p">]</span>

    <span class="c1"># Write members into databse</span>
    <span class="k">with</span> <span class="n">db</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
            <span class="s1">&#39;INSERT INTO members (name, group_name) VALUES (?, ?)&#39;</span><span class="p">,</span>
            <span class="n">members</span>
        <span class="p">)</span>
</code></pre></div>

<p><code>reset_db()</code> 會 DROP 掉舊的 database ，然後再用剛剛介紹的方法再把資料從 CSV 讀進來。</p>
<p>所以這個 function 要怎麼使用？</p>
<p>一個是像之前一樣綁定一個路徑 <code>@app.route('/reset')</code>；另一個方式我們可以透過 python shell 達到。</p>
<div class="highlight"><pre><span></span><code class="language-pycon"><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">draw_member</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">reset_db</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
<span class="gp">... </span>    <span class="n">reset_db</span><span class="p">()</span>
</code></pre></div>

<h4 id="datetime-in-sqlite-and-python">Datetime in SQLite and Python</h4>
<p>這篇文章太長了，寫到<a href="../datetime-sqlite/#datetime-sqlite">下一篇去</a>。</p>
<p>2016-06-14 更新：增加使用 <code>datetime.datetime</code> 的說明避免跟 module 名稱混淆 (credit: 馬國薰)</p>
<div class="footnote">
<hr>
<ol>
<li id="fn:1">
<p>在資料處理上其實會有個 NA 的值來區分「空」以及「空值」的概念。不過這用 Python 內建的 <code>csv.reader</code> 處理會太複雜就先算了。&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:sqlite3 auto commit">
<p>參考<a href="https://docs.python.org/3.5/library/sqlite3.html#using-the-connection-as-a-context-manager">官方說明文件</a>，它是在進入 <code>with db: ...</code> code block 時開啟一個 transaction，並在正常離開的時候自動 commit。如果中間遇到沒有處理的 Exception 時，就會自動 roll back。&#160;<a class="footnote-backref" href="#fnref:sqlite3 auto commit" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:flask-config">
<p>其實 Flask 相關的設定通常放在 <code>app.config</code> 裡面，不過我們的例子沒差。&#160;<a class="footnote-backref" href="#fnref:flask-config" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div></section>
    <footer class="post-footer">
	<section
		class="utterances"
		data-repo="ccwang002/ccwang002.github.io"
		data-issue-term="pathname"
		data-label="Comment">
	</section>
	</footer>
</article>
	</main>
	<footer class="site-footer">
		<a class="subscribe"
			href="https://blog.liang2.tw/feeds/all.atom.xml"
			data-tooltip="Atom feed"
		>
			<svg viewBox="0 0 24 24" width="24" height="24" alt="Atom feed">
				<circle cx="6.18" cy="17.82" r="2.18"/>
				<path d="m4 10.1v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9zm0-5.66v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56z"/>
			</svg>
		</a>
		<div class="inner">
			<section>
				Browse articles by
				<a href="https://blog.liang2.tw/tags.html">Tags</a> |
				<a href="https://blog.liang2.tw/categories.html">Categories</a>
			</section>
			<section class="contact">
				Contact me by
				<a href="https://twitter.com/lbwang2">Twitter</a> |
				<a href="https://www.facebook.com/lbwang.2">Facebook</a> |
				<a href="https://github.com/ccwang002">GitHub</a> |
				<a href="mailto:me+blog@liang2.tw">Email</a> |
				<a href="https://www.linkedin.com/in/liangbowang/">LinkedIn</a>
			</section>
			<section class="copyright">
				This work is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
			</section>
			<section class="poweredby">
				Built using <a href="https://getpelican.com/">Pelican</a>.
				Powered by the <a href="https://kura.github.io/hauntr/">Hauntr</a> theme.
			</section>
		</div>
	</footer>
	<script src="https://blog.liang2.tw/theme/scripts/theme-toggle.js"></script>
</body>
</html>