<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">
<meta name="author" content="Liang-Bo Wang" />
<meta name="description" content="For my daily terminal life, I use fish shell. Fish shell can be largely described by the headline on its official website: Finally, a command line shell for the 90s fish is a smart and user-friendly command line shell for macOS, Linux, and the rest of the family. Among all â€¦" />
<meta name="keywords" content="en, fish, shell">
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.95em%22 font-size=%2295%22>ðŸ“–</text></svg>">
	<title>Changing login shell without chsh</title>

	<!-- og -->
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="Liang-Bo Wang's Blog"/>
<meta property="og:title" content="Changing login shell without chsh"/>
<meta property="og:description" content="For my daily terminal life, I use fish shell. Fish shell can be largely described by the headline on its official website: Finally, a command line shell for the 90s fish is a smart and user-friendly command line shell for macOS, Linux, and the rest of the family. Among all â€¦"/>
<meta property="og:locale" content=""/>
<meta property="og:url" content="https://blog.liang2.tw/posts/2017/01/without-chsh/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-01-23 00:00:00-06:00"/>
<meta property="article:modified_time" content="2022-02-20 20:07:45.295201-06:00"/>
<meta property="article:author" content="https://blog.liang2.tw/author/liang-bo-wang.html">
<meta property="article:section" content="Coding"/>
<meta property="article:tag" content="en"/>
<meta property="article:tag" content="fish"/>
<meta property="article:tag" content="shell"/>
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ccwang002">
<meta name="twitter:title" content="Changing login shell without chsh">
<meta name="twitter:description" content="For my daily terminal life, I use fish shell. Fish shell can be largely described by the headline on its official website: Finally, a command line shell for the 90s fish is a smart and user-friendly command line shell for macOS, Linux, and the rest of the family. Among all â€¦">

	<!-- Feeds -->
	<link href="https://blog.liang2.tw/feeds/all.atom.xml"
		type="application/atom+xml" rel="alternate" title="Liang-Bo Wang's Blog" />

	<link rel="stylesheet" type="text/css" href="https://blog.liang2.tw/theme/styles/styles.css" />
	<link rel="stylesheet" type="text/css" href="https://blog.liang2.tw/theme/katex-0.15.3/katex.min.css">
</head>

<body class="post-template">
	<header class="site-head">
		<h1 class="blog-title"><a href="https://blog.liang2.tw">Liang-Bo Wang's Blog</a></h1>
		<h2 class="blog-description">
			<a href="https://blog.liang2.tw/about-me/">About</a> |
			<a href="https://blog.liang2.tw/talks/">Talks</a> |
			<a href="https://blog.liang2.tw/archives.html">Archives</a> |
			<button class="theme-toggle" aria-label="auto" aria-live="polite">ðŸŒ™</button>
		</h2>
	</header>
	<main id="content" class="content" role="main">
<article class="post">
    <span class="post-meta">
        <time datetime="2017-01-23">Jan 23, 2017</time>
        in <a href="https://blog.liang2.tw/category/coding/">Coding</a>
    </span>
    <h1 class="post-title">
        <a href="https://blog.liang2.tw/posts/2017/01/without-chsh/" rel="bookmark" title="Permalink to Changing login shell without chsh">Changing login shell without chsh</a>
    </h1>
    <span class="post-meta">
                <a href="https://blog.liang2.tw/tag/en/">en</a>
                <a href="https://blog.liang2.tw/tag/fish/">fish</a>
                <a href="https://blog.liang2.tw/tag/shell/">shell</a>
    </span>
    <section class="post-content"><p>For my daily terminal life, I use <a href="https://fishshell.com/">fish shell</a>. Fish shell can be largely described by the headline on its official website:</p>
<blockquote>
<p><strong>Finally, a command line shell for the 90s</strong><br>
fish is a smart and user-friendly command line
shell for macOS, Linux, and the rest of the family.</p>
</blockquote>
<p>Among all of its features, I particularly enjoy how the autocompletions are widely available and easy to use for generally all common commands and operations. I think I&rsquo;ve got spoiled by the autocompletion so much that sometimes I get lazy at typing the full commands. Undoubtedly, fish is my login shell, replacing the ubiquitous Bash shell.</p>
<p>Most of the time, one can change the login shell by the command <code>chsh</code>. In order to let <code>chsh</code> accept the new fish shell, it must be added into the list of all accepted shells which requires root permission. However, in many occasions including working on a large shared server, one may not has the permission to add new shell and thus the options for the login shell are often limited.  </p>
<h4 id="replacing-login-shell-by-exec">Replacing login shell by <code>exec</code></h4>
<p>Alternative solution will be calling the new shell upon the execution of current shell.  A POSIX-compliant shell<sup id="fnref:posix"><a class="footnote-ref" href="#fn:posix">1</a></sup> should always read the <code>.profile</code> configuration file upon login, the following command execute fish and sweep the process with the current running shell (usually, bash). </p>
<div class="highlight"><pre><span></span><code class="language-bash"><span class="nb">exec</span> -l <span class="nv">$SHELL</span> -l
</code></pre></div>

<p><code>-l</code> tells shell to act like a login shell. For more explanation about login and non-login (as well as (non-)interactive) shells can be found at <a href="http://unix.stackexchange.com/a/46856">this StackOverflow answer</a>. By pointing <code>$SHELL</code> to the desired shell binary, one can achieve the similar behavior to <code>chsh</code>.</p>
<p>However putting <code>exec</code> in the login profile comes with a risk that if the new shell executable crashes (e.g. failed symlink, erroneous compilation and failed dynamic library linking), one cannot establish proper shell connections. I&rsquo;ve experienced these catastrophic failures for a couple of times. Since the new shell crashes when the original shell is replacing its process, one cannot set up the proper terminal session, or simply put, one will fail to login. It was not fun at all to recover.</p>
<h4 id="fail-safe-shell-changing">Fail-safe shell changing</h4>
<p>To provide a fail-safe mechanism, I use the following code in my <code>~/.profile</code> to change the shell. Only login shells will read this file so it won&rsquo;t be executed when one runs a bash script.</p>
<div class="highlight"><pre><span></span><code class="language-bash"><span class="nv">FISH_BIN</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HOME</span><span class="s2">/.linuxbrew/bin/fish&quot;</span>

<span class="c1"># The replacement is only done in non-fish login interactive shell in</span>
<span class="c1"># SSH connection and fish executable exists.</span>
<span class="k">if</span> <span class="o">[</span>                                                            <span class="se">\</span>
     <span class="s2">&quot;</span><span class="nv">$SHELL</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$FISH_BIN</span><span class="s2">&quot;</span> -a -n <span class="s2">&quot;</span><span class="nv">$SSH_TTY</span><span class="s2">&quot;</span> -a -x <span class="s2">&quot;</span><span class="nv">$FISH_BIN</span><span class="s2">&quot;</span> <span class="se">\</span>
<span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c1"># we first check whether fish can be executed, otherwise the</span>
    <span class="c1"># replacement will cause immediate crash at login (not fun)</span>
    <span class="k">if</span> <span class="s2">&quot;</span><span class="nv">$FISH_BIN</span><span class="s2">&quot;</span> -c <span class="s1">&#39;echo &quot;Test fish running&quot; &gt;/dev/null&#39;</span> <span class="p">;</span> <span class="k">then</span>
        <span class="nb">export</span> <span class="nv">SHELL</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$FISH_BIN</span><span class="s2">&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;One can launch the fish shell by &#39;exec -l \$SHELL -l&#39;&quot;</span>
        <span class="c1"># exec -l $SHELL -l   # launch the fish login shell</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;Failed to launch fish shell. Go check its installation!&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;Fall back to default shell </span><span class="nv">$SHELL</span><span class="s2"> ...&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>
</code></pre></div>

<p>Basically we ensure whether fish executable work by running <code>echo '...'</code> before we change the shell. By uncommenting the <code>exec ..</code> line one will get automatically directed to fish shell. But the safest option is to run the shell change oneself. This kind of &ldquo;shell swapping&rdquo; will only happen when we log in the server by ssh</p>
<p>The actual setting is quite straight-forward. While the backstory here is that I messed up a few times and I was lucky enough to keep another session alive. At first I only checked <code>fish --version</code> but it was not sufficient, since it didn&rsquo;t actually execute fish&rsquo;s main code instructions. I got a illegal instruction after changing to fish even though printing its version was fine.</p>
<div class="footnote">
<hr>
<ol>
<li id="fn:posix">
<p>Interestingly, fish is not a POSIX-compliant shell so it won&rsquo;t read <code>~/.profile</code> configuration file.&#160;<a class="footnote-backref" href="#fnref:posix" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div></section>
    <footer class="post-footer">
	<section
		class="utterances"
		data-repo="ccwang002/ccwang002.github.io"
		data-issue-term="pathname"
		data-label="Comment">
	</section>
	</footer>
</article>
	</main>
	<footer class="site-footer">
		<a class="subscribe"
			href="https://blog.liang2.tw/feeds/all.atom.xml"
			data-tooltip="Atom feed"
		>
			<svg viewBox="0 0 24 24" width="24" height="24" alt="Atom feed">
				<circle cx="6.18" cy="17.82" r="2.18"/>
				<path d="m4 10.1v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9zm0-5.66v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56z"/>
			</svg>
		</a>
		<div class="inner">
			<section>
				Browse articles by
				<a href="https://blog.liang2.tw/tags.html">Tags</a> |
				<a href="https://blog.liang2.tw/categories.html">Categories</a>
			</section>
			<section class="contact">
				Contact me by
				<a href="https://twitter.com/lbwang2">Twitter</a> |
				<a href="https://www.facebook.com/lbwang.2">Facebook</a> |
				<a href="https://github.com/ccwang002">GitHub</a> |
				<a href="mailto:me+blog@liang2.tw">Email</a> |
				<a href="https://www.linkedin.com/in/liangbowang/">LinkedIn</a>
			</section>
			<section class="copyright">
				This work is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
			</section>
			<section class="poweredby">
				Built using <a href="https://getpelican.com/">Pelican</a>.
				Powered by the <a href="https://kura.github.io/hauntr/">Hauntr</a> theme.
			</section>
		</div>
	</footer>
	<script src="https://blog.liang2.tw/theme/scripts/theme-toggle.js"></script>
</body>
</html>