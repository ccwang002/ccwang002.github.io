---
Title: Build EnsDb from a local Ensembl MySQL database
Slug: build-ensdb-from-local-mysql
Date: 2019-01-08
Tags: en, r, bioconductor, sqlite, ensembldb
Category: Bioinfo
---

In some occasions, I need to access the older version of Ensembl human transcripts. For example, the mutation calls generated by the [NCI's Genomic Data Common][gdc] pipeline are annotated by Ensembl v84. To programmatically query the Ensembl annotations, I use the EnsDb SQLite database created by [ensembldb], which is a R package I enjoy using (see [my previous post][my-post-ensdb] for its usage).

The EnsDbs of the recent versions of Ensembl (v87+) are available on AnnotationHub. However, the older versions are not available, and they don't get updated when ensembldb introduces a new feature. For example, now newer EnsDbs include the transcript and gene ID version ([github issue][ensdb-id-version-issue]).

In my case, I need to build a EnsDb of Ensembl v84. [The ensembldb's documentation][ensembldb-doc] describes how to build one from the public Ensembl MySQL server. However, this method will take more than a day to complete. I started to look for other methods. After some trial and error, I managed to create my EnsDb fast by connecting to a local Ensembl database that I built. Surprisingly the setup wasn't difficult at all, and it only took about an hour to build the EnsDb.

Here are my notes of how to create the EnsDB from a local Ensembl MySQL database. I use macOS but the steps can be easily modified to work on other OSes.

[TOC]

[gdc]: https://gdc.cancer.gov/
[ensembldb]: https://bioconductor.org/packages/release/bioc/html/ensembldb.html
[my-post-ensdb]: {filename}../2017-11/1117_ensdb_in_python.md
[ensdb-id-version-issue]: https://github.com/jotsetung/ensembldb/issues/89
[ensembldb-doc]: https://bioconductor.org/packages/release/bioc/vignettes/ensembldb/inst/doc/ensembldb.html#10_getting_or_building_ensdb_databasespackages


### Ensembl VM
To create a EnsDB from a Ensembl MySQL database, we need to the Ensembl Perl APIs. And the easiest setup is by a [Ensembl virtual machine][ensembl-vm]. We just need to import the VM image using VirtualBox and install the ensembldb R package inside the      VM, then it is ready to build the EnsDb. I recommend the VM to have more memory than the default 1GB since larger memory help build the R packages and EnsDb.

[ensembl-vm]: http://www.ensembl.org/info/data/virtual_machine.html


### Build a local Ensembl v84 MySQL database
Ensembl provides [the MySQL database dump][ensembl-data] to allow easy import of their data of any version. Assuming the working directory being `~/Documents/Ensembl_MySQL_mirror/`, we first copy the database dump by:

```
cd ~/Documents/Ensembl_MySQL_mirror
rsync -a rsync://ftp.ensembl.org/ensembl/pub/release-84/mysql/homo_sapiens_core_84_38 .
gunzip *.txt.gz  # MySQL doesn't accept compressed db dump
```

While downloading the data, we also need to install the MySQL server. I install [the same or similar version of MySQL][mysql-ver] Ensembl is currently using, which is 5.6 at the time of writing. On macOS, Homebrew allows the database to be installed with a specific version:

```bash
brew install mysql@5.6
# And start the MySQL server
/usr/local/opt/mysql@5.6/bin/mysql.server start
```

First we create a database matching the Ensembl version, in our case of v84:

```sql
CREATE DATABASE homo_sapiens_core_84_38;
```

Then we load the table schema and the Ensembl data:

```bash
/usr/local/opt/mysql@5.6/bin/mysql -u root \
    homo_sapiens_core_84_38 < homo_sapiens_core_84_38.sql

/usr/local/opt/mysql@5.6/bin/mysqlimport \
    -u root \
    --fields-terminated-by='\t' --fields_escaped_by=\\  \
    homo_sapiens_core_84_38 -L *.txt
```

Finally, we change the MySQL config `/usr/local/etc/my.cnf` to accept remote database connection so the VM can access the database on the host machine. I don't use MySQL for anything else, so I simply let it accept (bind) any IP address:

```
[mysqld]
bind-address = *
```

Note that this is not a secure configuration. Restart MySQL to get the new setting in effect:

```
/usr/local/opt/mysql@5.6/bin/mysql.server restart
```

By default the vm share the same network as the host machine. Write down the IP address of our host machine.


[ensembl-data]:https://www.ensembl.org/info/docs/webcode/mirror/install/ensembl-data.html
[mysql-ver]: http://www.ensembl.org/info/data/mysql.html


### Build EnsDB from the local MySQL database
Now we can come back to the vm and build the EnsDb v84. Run the following R script:

```r
library(ensembldb)
fetchTablesFromEnsembl(
    84, species = "human",
    user = 'root', host = '<our host IP>', port = 3306
)
DBFile <- makeEnsemblSQLiteFromTables()
```

The EnsDb SQLite database will be availabe under the working directory. We can test to load the new EnsDb by:

```r
edb <- EnsDb(DBFile)
```


### Remove MySQL
If there is no other need of MySQL, we can uninstall it and remove all its databases by:

```
brew remove mysql@5.6
rm -rf /usr/local/var/mysql
```
